<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>主机路由详解 | Ian21c's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">主机路由详解</h1><a id="logo" href="/.">Ian21c's Blog</a><p class="description">Peace &amp; Love ! Learning to think independently !</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">主机路由详解</h1><div class="post-meta">Mar 17, 2021<span> | </span><span class="category"><a href="/categories/technology/">technology</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#主机双网卡使用说明"><span class="toc-number">1.</span> <span class="toc-text">主机双网卡使用说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows——保证双网卡配置正确启用即可"><span class="toc-number">1.1.</span> <span class="toc-text">Windows——保证双网卡配置正确启用即可</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-DHCP-获取地址"><span class="toc-number">1.1.1.</span> <span class="toc-text">使用 DHCP 获取地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#手动配置"><span class="toc-number">1.1.2.</span> <span class="toc-text">手动配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux——策略路由"><span class="toc-number">1.2.</span> <span class="toc-text">Linux——策略路由</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#技术原理详解"><span class="toc-number">2.</span> <span class="toc-text">技术原理详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#路由简介"><span class="toc-number">2.1.</span> <span class="toc-text">路由简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#路由判断位置"><span class="toc-number">2.1.1.</span> <span class="toc-text">路由判断位置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#路由三要素"><span class="toc-number">2.1.2.</span> <span class="toc-text">路由三要素</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么-Windows-双网卡配置那么简单"><span class="toc-number">2.2.</span> <span class="toc-text">为什么 Windows 双网卡配置那么简单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#明细路由"><span class="toc-number">2.3.</span> <span class="toc-text">明细路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关闭反向路由检查"><span class="toc-number">2.4.</span> <span class="toc-text">关闭反向路由检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#策略路由"><span class="toc-number">2.5.</span> <span class="toc-text">策略路由</span></a></li></ol></li></ol></div></div><div class="post-content"><p>——此【主机路由】指主机上的路由规则，非全网络位的前缀路由条目。</p>
<h2 id="主机双网卡使用说明"><a href="#主机双网卡使用说明" class="headerlink" title="主机双网卡使用说明"></a>主机双网卡使用说明</h2><p>写这篇文章的原因就是一些云主机客户在添加双网卡之后，网络出现连通性问题，这里先直接给出最优解，后文会详细阐述涉及的原理和其它一些相关性技术。</p>
<h3 id="Windows——保证双网卡配置正确启用即可"><a href="#Windows——保证双网卡配置正确启用即可" class="headerlink" title="Windows——保证双网卡配置正确启用即可"></a>Windows——保证双网卡配置正确启用即可</h3><h4 id="使用-DHCP-获取地址"><a href="#使用-DHCP-获取地址" class="headerlink" title="使用 DHCP 获取地址"></a>使用 DHCP 获取地址</h4><p><img src="/images/主机路由详解/win1.png" alt="win1"></p>
<p>这是最推荐的方式，简单不容易出错，若网络连通性还有问题，请检查地址的获取情况和路由表状态</p>
<ul>
<li><p>检查地址的获取情况</p>
<figure class="highlight plain"><figcaption><span>config</span><a href="/all```">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 路由表状态</span><br><span class="line"></span><br><span class="line">  ```route print</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="手动配置"><a href="#手动配置" class="headerlink" title="手动配置"></a>手动配置</h4><p><img src="/images/主机路由详解/win2.png" alt="win2"></p>
<p>注意保证网卡对应地址和网关配置的正确性。</p>
<h3 id="Linux——策略路由"><a href="#Linux——策略路由" class="headerlink" title="Linux——策略路由"></a>Linux——策略路由</h3><p>网卡信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eth0 192.168.10.100 (gw)192.168.10.1</span><br><span class="line">eth1 192.168.20.100 (gw)192.168.20.1</span><br></pre></td></tr></table></figure>
<p>新建路由表并添加默认路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">### eth0</span><br><span class="line"># echo &quot;101 net_100&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line"># ip route add default via 192.168.10.1 dev eth0 table net_100</span><br><span class="line"></span><br><span class="line">### eth1</span><br><span class="line"># echo &quot;101 net_101&quot; &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line"># ip route add default via 192.168.20.1 dev eth1 table net_101</span><br><span class="line"></span><br><span class="line">### 持久化</span><br><span class="line">### 使用 -p 参数，或者在 /etc/rc.local 中添加 route 命令来保证该路由设置永久有效</span><br><span class="line">### /etc/rc.local 文件不生效，尝试</span><br><span class="line"># cat /etc/sysconfig/network-scripts/route-eth0</span><br><span class="line">default via 192.168.10.1 dev eth1 table net_101</span><br><span class="line"># cat /etc/sysconfig/network-scripts/route-eth1</span><br><span class="line">default via 192.168.20.1 dev eth2 table net_102</span><br><span class="line"></span><br><span class="line">### PS：可以只新建一张路由表，另一张使用系统的</span><br></pre></td></tr></table></figure>
<p>添加策略路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### eth0</span><br><span class="line"># ip rule add from 192.168.10.100 table net_100</span><br><span class="line"></span><br><span class="line">### eth1</span><br><span class="line"># ip rule add from 192.168.20.100 table net_101</span><br><span class="line"></span><br><span class="line">### 持久化</span><br><span class="line"># echo &quot;ip rule add from 192.168.3.0/24 table storage&quot; &gt;&gt; /etc/rc.local</span><br><span class="line"># chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>
<h2 id="技术原理详解"><a href="#技术原理详解" class="headerlink" title="技术原理详解"></a>技术原理详解</h2><h3 id="路由简介"><a href="#路由简介" class="headerlink" title="路由简介"></a>路由简介</h3><h4 id="路由判断位置"><a href="#路由判断位置" class="headerlink" title="路由判断位置"></a>路由判断位置</h4><p>其实在系统内有两处判断路由的地方，以 Linux 为例，一处是 prerouting，另一处是 output：</p>
<p><img src="/images/主机路由详解/iptables数据处理流程.png" alt="iptables数据处理流程"></p>
<p>主机系统一般只有 output，开启路由功能后 prerouting 才会判断不丢弃，简单理解一个为主机自身选路，另一个为转发非自身产生的报文。</p>
<h4 id="路由三要素"><a href="#路由三要素" class="headerlink" title="路由三要素"></a>路由三要素</h4><ul>
<li><p>网络前缀：匹配的唯一条件（最长匹配原则）</p>
</li>
<li><p>逃出接口：发包的出口</p>
</li>
<li><p>下一跳：数据包的下一站，一般为网关地址</p>
</li>
</ul>
<p>ps：逃出接口和下一跳可二选一，缺少逃出接口会递归查询直到得到逃出接口，缺少下一跳会导致 ARP 请求（一般为末梢网络，否则下一目的设备必须有 ARP 代答）</p>
<p>ext：路由类型，有直连路由、静态路由、动态路由(很多子类)等；路由管理距离，不同的路由类型具有不同的管理距离，可以简单理解为优先级；metric，路由条目的代价值，可以理解为当管理距离和路由前缀一致时使用的优先级</p>
<h3 id="为什么-Windows-双网卡配置那么简单"><a href="#为什么-Windows-双网卡配置那么简单" class="headerlink" title="为什么 Windows 双网卡配置那么简单"></a>为什么 Windows 双网卡配置那么简单</h3><p>在正式讲解通用的解决方案前，需要把 Windows 的情况单独拿出来说，因为它的路由机制做了一定的优化处理。</p>
<p>前文有提到两点，一是对于主机来说一般是不需要开启路由功能的，二是路由的唯一匹配条件是网络前缀。基于此，Windows 当系统未开启路由功能时，路由判断的时候把逃出接口改为了逃出接口的 IP 地址并做了校验。</p>
<p>下图是不同子网的双网卡生成的路由表：</p>
<p><img src="/images/主机路由详解/windiff.png" alt="Win 路由表"></p>
<p>我们看到有俩条优先级不同的默认路由（其实还有一条高优先级的没有逃出接口的未活动默认路由），当使用次网卡的时候，虽然匹配了高优先级默认路由，但是此时对源地址做了校验（注意这不是常规操作），所以最后走了低优先级路由。</p>
<p>经过测试，当 Windows 开启路由功能后，路由规则就符合常理了，不会进行这个校验，因为这个校验会所有的转发报文被丢弃。此时，Windows 的双网卡使用自然也有问题了。</p>
<p><strong><em>在补充个知识点——源地址是如何决定的？</em></strong><br><strong><em>- 当存在 bind 时：</em></strong><br><strong><em>此时一般是被动建立的连接，或者主动发起时指定源地址，自然使用的 bind 地址</em></strong><br><strong><em>- 当不存在 bind 时：</em></strong><br><strong><em>此时只有不指定源时主动发起访问，源地址来源于逃出接口的地址</em></strong></p>
<p>附：<br><a href="https://www.mdeditor.tw/pl/pStO" target="_blank" rel="noopener">Windows 开启路由功能</a><br><a href="https://www.linuxidc.com/Linux/2016-12/138661.htm" target="_blank" rel="noopener">Linux 开启路由功能</a></p>
<p>接下来，我们来看看常规的解决办法吧（据笔者所知，Windows无法使用关闭反向路由检查和策略路由）：</p>
<ul>
<li>明细路由</li>
<li>关闭反向路由检查</li>
<li>策略路由</li>
</ul>
<h3 id="明细路由"><a href="#明细路由" class="headerlink" title="明细路由"></a>明细路由</h3><p>我们已经知道双网卡造成连通性的根因是主机无法根据路由判断数据包往哪发了，那我们就根据业务需求和规划，写明哪个网段走哪个出口就好了。</p>
<p>缺点：既然写了规矩，自然是哪些网段走哪个口整的明明白白的，不能两个网口同时向所有网段提供服务了，明细网段二选一。</p>
<p>根据业务需求，分为同子网接入和不同子网接入两种情况，一般明细路由的使用情况建议采用不同子网模式。</p>
<p><img src="/images/主机路由详解/双网卡使用情形.png" alt="双网卡使用情形"></p>
<p>其实，两种情况就只是下一跳的值不一样，便于管理和逻辑清晰推荐不同子网。</p>
<p>附：<br>Windows 详细配置明细路由可参见链接的第三部分：<a href="https://cloud.tencent.com/developer/article/1493985" target="_blank" rel="noopener">Windows 路由表详解</a><br>Linux 详细配置明细路由：<a href="https://blog.csdn.net/devil_2009/article/details/6768935" target="_blank" rel="noopener">关于Linux路由表的route命令</a></p>
<h3 id="关闭反向路由检查"><a href="#关闭反向路由检查" class="headerlink" title="关闭反向路由检查"></a>关闭反向路由检查</h3><p>rp_filter 本身会过滤反向路由不通的数据包。用通俗的话解释一下，就是NIC1 有 incoming 数据包，Reverse Path Filtering 模块会将数据包的源地址和目的地址(srcIP-&gt;dstIP)调转过来成为(dstIP-&gt;srcIP)，然后在路由表中查找这个(dstIP-&gt;srcIP) 的路由，如果出口恰好是 NIC1 那么 rp_filter 测试通过，否则不通过/丢弃。</p>
<p>0：不开启源地址校验。<br>1：开启严格的反向路径校验。对每个进来的数据包，校验其反向路径是否是最佳路径。如果反向路径不是最佳路径，则直接丢弃该数据包。<br>2：开启松散的反向路径校验。对每个进来的数据包，校验其源地址是否可达，即反向路径是否能通（通过任意网口），如果反向路径不同，则直接丢弃该数据包。</p>
<p>基于此，我们可以把它关闭，然后保证只有一条默认路由（优先级也好，不指定网关也罢，都是可以采取的措施）。此时主动访问时主机已经明确知道走默认路由的那张网卡了，而对于被动访问的次网卡，egress 流量其实走的还是主网卡，我们只是关闭掉反向路由检查放行了。</p>
<p>此种方式并不推荐，原因如下：</p>
<ul>
<li>egress 流量还是占用主网卡的带宽</li>
<li>一般云平台都会对 IP 和 Mac 的映射关系进行检查</li>
</ul>
<p>附：<a href="https://myscis.cn/?p=289" target="_blank" rel="noopener">Linux 关闭 rpf</a></p>
<h3 id="策略路由"><a href="#策略路由" class="headerlink" title="策略路由"></a>策略路由</h3><p>路由选路的唯一匹配条件就是网络前缀，策略路由可以基于报文的其它信息，比如来源端口和五元组其它信息等。</p>
<p>路由因只能使用网络前缀匹配导致无法分别两个接口的流量，我们这里就基于不同的源地址使数据包从不同的接口出去，实现原进原出。</p>
<p>这里顺便提一下路由策略，其是路由收敛时采取的机制，这里就不展开介绍了，注意不要混淆即可。</p>
<p>附：<a href="https://www.cnblogs.com/wanstack/p/7728785.html" target="_blank" rel="noopener">策略路由配置参考</a></p>
</div><div class="tags"><a href="/tags/network/">network</a><a href="/tags/cloud/">cloud</a></div><div class="post-nav"><a class="pre" href="/2021/07/13/NCN-Draft/">NCN-Draft</a><a class="next" href="/2021/03/05/不识庐山真面目——我在虚拟网的打怪升级之路/">不识庐山真面目——我在虚拟网的打怪升级之路</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'cf6cbb233152befba374',
  clientSecret: 'd1d9b814b36163460ad6241843c4d1be861fe7db',
  repo: 'BlogComments',
  owner: 'sirius21c',
  admin: ['sirius21c'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://21c.me"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/emotion/">emotion</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technology/">technology</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/diary/" style="font-size: 15px;">diary</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/network/" style="font-size: 25px;">network</a> <a href="/tags/cloud/" style="font-size: 22.14px;">cloud</a> <a href="/tags/sdn/" style="font-size: 19.29px;">sdn</a> <a href="/tags/Happy-Birthday/" style="font-size: 15px;">Happy Birthday</a> <a href="/tags/随笔/" style="font-size: 16.43px;">随笔</a> <a href="/tags/neutron/" style="font-size: 23.57px;">neutron</a> <a href="/tags/openstack/" style="font-size: 25px;">openstack</a> <a href="/tags/travel/" style="font-size: 15px;">travel</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/tool/" style="font-size: 15px;">tool</a> <a href="/tags/octavia/" style="font-size: 15px;">octavia</a> <a href="/tags/openflow/" style="font-size: 17.86px;">openflow</a> <a href="/tags/note/" style="font-size: 20.71px;">note</a> <a href="/tags/ovs/" style="font-size: 19.29px;">ovs</a> <a href="/tags/sfc/" style="font-size: 15px;">sfc</a> <a href="/tags/tripleo/" style="font-size: 15px;">tripleo</a> <a href="/tags/linux-bridge/" style="font-size: 15px;">linux bridge</a> <a href="/tags/devstack/" style="font-size: 15px;">devstack</a> <a href="/tags/firewall对接/" style="font-size: 17.86px;">firewall对接</a> <a href="/tags/security/" style="font-size: 16.43px;">security</a> <a href="/tags/calico/" style="font-size: 15px;">calico</a> <a href="/tags/k8s/" style="font-size: 16.43px;">k8s</a> <a href="/tags/wireshark/" style="font-size: 15px;">wireshark</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/poetry/" style="font-size: 15px;">poetry</a> <a href="/tags/边缘计算/" style="font-size: 15px;">边缘计算</a> <a href="/tags/5G/" style="font-size: 15px;">5G</a> <a href="/tags/kvm/" style="font-size: 15px;">kvm</a> <a href="/tags/SR-IOV/" style="font-size: 15px;">SR-IOV</a> <a href="/tags/VPNaaS/" style="font-size: 15px;">VPNaaS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/06/21/使用字节构造PCAP格式/">使用字节构造PCAP格式</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/06/21/SDN设计理念思考/">SDN设计理念思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/06/21/PrivateNote-UCloudFlowLaws/">PrivateNote-UCloudFlowLaws</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/04/23/404/">404</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/29/ARP缓存更新机制/">ARP缓存更新机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/07/13/NCN-Draft/">NCN-Draft</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/17/主机路由详解/">主机路由详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/05/不识庐山真面目——我在虚拟网的打怪升级之路/">不识庐山真面目——我在虚拟网的打怪升级之路</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/28/成都购房指北/">成都购房指北</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/15/所爱隔山海，山海难平——浅谈SDN/">所爱隔山海，山海难平——浅谈SDN</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">Ian21c's Blog.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.6" zindex="-1" count="55" src="//lib.baomitu.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>