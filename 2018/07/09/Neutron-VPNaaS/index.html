<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Neutron-VPNaaS | Sirius21c's Docs</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Neutron-VPNaaS</h1><a id="logo" href="/.">Sirius21c's Docs</a><p class="description">一位不爱写文档的码农的自我救赎之路</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Neutron-VPNaaS</h1><div class="post-meta">Jul 9, 2018<span> | </span><span class="category"><a href="/categories/technology/">technology</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VPN的本质和分类"><span class="toc-number">2.</span> <span class="toc-text">VPN的本质和分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第二层隧道协议"><span class="toc-number">2.1.</span> <span class="toc-text">第二层隧道协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三层隧道协议"><span class="toc-number">2.2.</span> <span class="toc-text">第三层隧道协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IP-over-IP"><span class="toc-number">2.3.</span> <span class="toc-text">IP-over-IP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常见-VPN-实现介绍"><span class="toc-number">3.</span> <span class="toc-text">常见 VPN 实现介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GRE"><span class="toc-number">3.1.</span> <span class="toc-text">GRE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MPLS"><span class="toc-number">3.2.</span> <span class="toc-text">MPLS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSL"><span class="toc-number">3.3.</span> <span class="toc-text">SSL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPSec（重点介绍）"><span class="toc-number">3.4.</span> <span class="toc-text">IPSec（重点介绍）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模块架构"><span class="toc-number">4.</span> <span class="toc-text">模块架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据模型"><span class="toc-number">5.</span> <span class="toc-text">数据模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#VPNServices-Resource"><span class="toc-number">5.1.</span> <span class="toc-text">VPNServices Resource</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IKEPolicies-Resource"><span class="toc-number">5.2.</span> <span class="toc-text">IKEPolicies Resource</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPsecPolicies-Resource"><span class="toc-number">5.3.</span> <span class="toc-text">IPsecPolicies Resource</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ipsec-site-connection-Resource"><span class="toc-number">5.4.</span> <span class="toc-text">ipsec-site-connection Resource</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#object-diagram"><span class="toc-number">5.5.</span> <span class="toc-text">object diagram</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-命令"><span class="toc-number">6.</span> <span class="toc-text">API 命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署"><span class="toc-number">7.</span> <span class="toc-text">部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Devstack快速部署"><span class="toc-number">7.1.</span> <span class="toc-text">Devstack快速部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用软件包安装部署"><span class="toc-number">7.2.</span> <span class="toc-text">使用软件包安装部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">8.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用两个Devstack节点进行测试"><span class="toc-number">8.1.</span> <span class="toc-text">使用两个Devstack节点进行测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DevStack配置"><span class="toc-number">8.1.1.</span> <span class="toc-text">DevStack配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#VPNaaS配置"><span class="toc-number">8.1.2.</span> <span class="toc-text">VPNaaS配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#验证"><span class="toc-number">8.1.3.</span> <span class="toc-text">验证</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用单个Devstack节点进行测试"><span class="toc-number">8.2.</span> <span class="toc-text">使用单个Devstack节点进行测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#环境初始化"><span class="toc-number">8.2.1.</span> <span class="toc-text">环境初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#IPSec站点到站点连接创建"><span class="toc-number">8.2.2.</span> <span class="toc-text">IPSec站点到站点连接创建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#验证-1"><span class="toc-number">8.2.3.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MLS-和-Endpoint-group"><span class="toc-number">8.2.4.</span> <span class="toc-text">*! MLS 和 Endpoint group</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VPN-test-for-CentOS"><span class="toc-number">8.3.</span> <span class="toc-text">VPN test for CentOS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#测试环境"><span class="toc-number">8.3.1.</span> <span class="toc-text">测试环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#环境配置"><span class="toc-number">8.3.2.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试方案"><span class="toc-number">8.3.3.</span> <span class="toc-text">测试方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#过程记录"><span class="toc-number">8.3.4.</span> <span class="toc-text">过程记录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#分析与总结"><span class="toc-number">8.3.5.</span> <span class="toc-text">分析与总结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VPN-test-for-Ubuntu"><span class="toc-number">8.4.</span> <span class="toc-text">VPN test for Ubuntu</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#测试环境-1"><span class="toc-number">8.4.1.</span> <span class="toc-text">测试环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#环境配置-1"><span class="toc-number">8.4.2.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试方案-1"><span class="toc-number">8.4.3.</span> <span class="toc-text">测试方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#过程记录-1"><span class="toc-number">8.4.4.</span> <span class="toc-text">过程记录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Endpoint-group功能测试"><span class="toc-number">8.4.5.</span> <span class="toc-text">*! Endpoint group功能测试</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#测试方案-2"><span class="toc-number">8.4.5.1.</span> <span class="toc-text">测试方案</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#测试步骤"><span class="toc-number">8.4.5.2.</span> <span class="toc-text">测试步骤</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#结果与分析"><span class="toc-number">8.4.6.</span> <span class="toc-text">结果与分析</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>VPN的英文全称是“Virtual Private Network”，翻译过来就是“虚拟专用网络”。顾名思义，虚拟专用网络我们可以把它理解成是虚拟出来的企业内部专线。它可以通过特殊的加密的通讯协议在连接在Internet上的位于不同地方的两个或多个企业内部网之间建立一条专有的通讯线路，就好比是架设了一条专线一样，但是它并不需要真正的去铺设光缆之类的物理线路。一句话，VPN的核心就是在利用公共网络建立虚拟私有网。</p>
<p>VPNaas（VPN as a service）是Openstack的Havana版本中，neutron增加的一个新的功能，将VPN功能引入到了neutron中，虽然在Havana版中只支持IPSec协议的VPN，功能还比较弱，但这个关键特性已经有了，后续会不断加强该特性，其长期目标是使其功能非常丰富，支持多种支持静态和动态路由的隧道安全协议，但从短期来看，希望仅由静态态路由完成基于开源IPsec的基本实现。</p>
<h3 id="VPN的本质和分类"><a href="#VPN的本质和分类" class="headerlink" title="VPN的本质和分类"></a>VPN的本质和分类</h3><p>vpn比较容易误解的是，某网络区域不可访问的时候使用vpn就能顺利解决，这种情况其实vpn到vpn设备或网关就已终结，由他们进行隧道协议的封装和解封装后完成数据转发。<br>vpn本身的建立是在网络可达性之上的，其一般完成两件事：1.通过封装对中间设备透明，识别内部对应层次的原有报文语义；2.通过加密使数据不会暴露在外部传输网络中。</p>
<p>网络虚拟化最基础的技术莫过于分层，要实现分层有两种手段，一个是映射，另一个是封装。vpn技术就是基于封装的技术。</p>
<ul>
<li>映射：主要思路是转发时替换报文语义，如何替换将需要设备进行查询。</li>
<li>封装：把需要的报文语义添加到网包中，处理的时候一层层的解封装即可，尽量对设备透明。</li>
</ul>
<h4 id="第二层隧道协议"><a href="#第二层隧道协议" class="headerlink" title="第二层隧道协议"></a>第二层隧道协议</h4><p>PPP、PPTP、L2TP、L2F等都属于第二层隧道协议，修改帧报头将用户数据封装在PPP帧中通过互联网发送。对于非以太网，ATM和帧中继也是两种最为流行的vpn隧道。第二层隧道的优点是能将大二层直接打通，独立于它传输第三层的数据流。</p>
<h4 id="第三层隧道协议"><a href="#第三层隧道协议" class="headerlink" title="第三层隧道协议"></a>第三层隧道协议</h4><p>如果递送的报头位于第三层就是第三层vpn，如gre、mpls、ipsec等。</p>
<h4 id="IP-over-IP"><a href="#IP-over-IP" class="headerlink" title="IP-over-IP"></a>IP-over-IP</h4><p>经常会有人将像GRE这种隧道协议和IP-over-IP混淆。IP-over-IP一般具有两层IP报头，内部报头和外部报头，但无论是内部报头还是外部报头都是标准的IP报头，等于还是IP协议。但GRE这种隧道会有自己的新的报头，这样就相当于一种新协议，所以严格地讲我们叫它隧道协议，而不是隧道。</p>
<h3 id="常见-VPN-实现介绍"><a href="#常见-VPN-实现介绍" class="headerlink" title="常见 VPN 实现介绍"></a>常见 VPN 实现介绍</h3><h4 id="GRE"><a href="#GRE" class="headerlink" title="GRE"></a>GRE</h4><p>建立vpn很方便，且留有专门的virtual tunnel interface可以直接完成IGP的私网收敛，但没有安全机制，即数据没有进行加密，将内部报文直接暴露在外部传输网络中。</p>
<h4 id="MPLS"><a href="#MPLS" class="headerlink" title="MPLS"></a>MPLS</h4><p>在传输数据之前就先用L3层的路由机制将L2层的标签在途经的每个路由器上都事先算好了，并且这种标签是自动配置的。</p>
<h4 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h4><p>这种vpn的最大好处在于，仅需要一个单独的TCP或UDP端口便可以轻易穿越大多数防火墙进行数据传送。openVPN是在Linux系统上最好的实现，其使在广域网内网的两台主机可以直接进行通信，即host-to-host。</p>
<h4 id="IPSec（重点介绍）"><a href="#IPSec（重点介绍）" class="headerlink" title="IPSec（重点介绍）"></a>IPSec（重点介绍）</h4><p>目前neutron唯一实现的 vpn driver，但也已不再活跃。</p>
<p>IPSec就封装建立隧道而言还是很鸡肋的，匹配感兴趣流较麻烦，多路由节点配置，IGP无法收敛，所以一般采用和gre结合的方式，gre完成隧道建立，ipsec进行加密处理，结合方式有两种：</p>
<ul>
<li><p><strong>IPSEC Over GRE</strong>：IPSEC在里，GRE在外。先把需要加密的数据包封装成IPSEC包，然后再扔到GRE隧道里。作法是把IPSEC的加密图作用在Tunnel口上的，即在Tunnel口上监控（访问控制列表监控本地ip网段-源i和远端ip网段-目的地），是否有需要加密的数据流，有则先加密封装为IPSEC包，然后封装成GRE包进入隧道（这里显而易见的是，GRE隧道始终无论如何都是存在的，即GRE隧道的建立过程并没有被加密），同时，未在访问控制列表里的数据流将以不加密的状态直接走GRE隧道，即存在有些数据可能被不安全地传递的状况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 访问控制列表，针对两个网段的数据流，如：</span><br><span class="line">  ip access-list extended vpn12</span><br><span class="line">  permit ip 10.1.1.0 0.0.0.255 10.2.2.0 0.0.0.255</span><br><span class="line">- 加密处放在Tunnel口</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>GRE Over IPSEC</strong>：GRE Over IPSEC是指，先把数据分装成GRE包，然后再分装成IPSEC包。做法是在物理接口上监控，是否有需要加密的GRE流量（访问控制列表针对GRE两端的设备ip），所有的这两个端点的GRE数据流将被加密分装为IPSEC包再进行传递，这样保证的是所有的数据包都会被加密，包括隧道的建立和路由的建立和传递。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 访问列表，针对两个路由器之间的GRE流，如：</span><br><span class="line">  ip access-list extended vpn12</span><br><span class="line">  permit gre host 172.16.11.2 host 172.16.22.2</span><br><span class="line">- 加密图作用在物理口。</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>另外还有一个概念是传输模式和隧道模式，加密方式也分为AH和ESP。</p>
<ul>
<li><strong>传输模式</strong>：一层报头，传输过程中IPSec源端点不会修改IP报中的目标IP地址，只是对IP协议的数据部分(payload)进行了加密。</li>
<li><strong>隧道模式</strong>：内外两层报头，传输过程中IPSec源端点会修改IP报中的目标IP地址，对整个IP数据包进行加密。</li>
</ul>
<p>显然隧道模式不符合我们的应用场景。</p>
<p>对于加密方式，由于南北流量需要经过端口复用的SNAT或者一对一的fip，会产生冲突。</p>
<ul>
<li><strong>AH</strong>：AH封装的校验从IP头开始，如果NAT将IP的头部改动，AH的校验就会失败，因此我们得出结论，AH是无法与NAT共存的。</li>
<li><strong>ESP</strong>：<ul>
<li><em>传输模式</em>，虽然不适合场景，此处也说明一下。对于NAT来说，ESP封装比AH的优势在于，无论是加密还是完整性的校验，IP头部都没有被包括进去。但是还是有新的问题，对于ESP的传输模式，NAT 无法更新上层校验和。因为TCP 和 UDP 报头包含一个校验和，它整合了源和目标 IP 地址和端口号的值，而源和目的IP地址和端口号在做NAT时会发生改变。当 NAT 改变了某个包的 IP 地址和（或）端口号时，它通常要更新 TCP 或 UDP 校验和。当 TCP 或 UDP 校验和使用了 ESP 来加密时，它就无法更新这个校验和。由于地址或端口已经被 NAT 更改，目的地的校验和检验就会失败。虽然 UDP 校验和是可选的，但是 TCP 校验和却是必需的。所以ESP的传输模式也不支持NAT穿越。</li>
<li><em>隧道模式</em>。ESP隧道模式将整个原始的IP包整个进行了加密，且在ESP的头部外面新加了一层IP头部，所以NAT如果只改变最前面的新的IP地址对后面受到保护的部分是不会有影响的。因此，IPsec只有采用ESP的隧道模式来封装数据时才能与NAT共存。但只能对非PAT得情况，即因为ESP协议号50，直接构建在IP层之上，没有类似于UDP/TCP端口号的概念，也就没有NAT复用标识，只能采用fip，q-router的qg桥上的默认snat失效，所以需要采用nat-t，通过借用UDP的方式实现端口复用。详细可参看<a href="https://technet.microsoft.com/zh-cn/library/bb878090.aspx" target="_blank" rel="noopener">https://technet.microsoft.com/zh-cn/library/bb878090.aspx</a>。</li>
</ul>
</li>
</ul>
<h3 id="模块架构"><a href="#模块架构" class="headerlink" title="模块架构"></a>模块架构</h3><p><img src="/images/Neutron-VPNaaS/模块架构.png" alt="模块架构"></p>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><h4 id="VPNServices-Resource"><a href="#VPNServices-Resource" class="headerlink" title="VPNServices Resource"></a>VPNServices Resource</h4><table>
<thead>
<tr>
<th style="text-align:center">Attribute</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">DefaultValue</th>
<th style="text-align:center">Vaildation Constraint</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">uuid-str</td>
<td style="text-align:center">generated</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">用于VPNService对象的UUID</td>
</tr>
<tr>
<td style="text-align:center">tenant_id</td>
<td style="text-align:center">uuid-str</td>
<td style="text-align:center">None</td>
<td style="text-align:center">Valid tenant_id</td>
<td style="text-align:center">vpn服务的租户的UUID</td>
</tr>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">string</td>
<td style="text-align:center">None</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">VPN服务的名称</td>
</tr>
<tr>
<td style="text-align:center">description</td>
<td style="text-align:center">string</td>
<td style="text-align:center">None</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">VPN服务的描述</td>
</tr>
<tr>
<td style="text-align:center">status</td>
<td style="text-align:center">string</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">指示ipsec vpnservice当前是否可用。可能的值包括：ACTIVE DOWN BUILD ERROR</td>
</tr>
<tr>
<td style="text-align:center">admin_state_up</td>
<td style="text-align:center">bool</td>
<td style="text-align:center">TRUE</td>
<td style="text-align:center">true/false</td>
<td style="text-align:center">vpnservice的管理状态。 如果为false（down），则端口不转发数据包</td>
</tr>
<tr>
<td style="text-align:center">subnet_id</td>
<td style="text-align:center">uuid</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">Valid subnet id</td>
<td style="text-align:center">租户需要vpn服务的子网ID</td>
</tr>
<tr>
<td style="text-align:center">router_id</td>
<td style="text-align:center">uuid</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">Valid router id</td>
<td style="text-align:center">vpn服务所插入的路由器ID</td>
</tr>
</tbody>
</table>
<h4 id="IKEPolicies-Resource"><a href="#IKEPolicies-Resource" class="headerlink" title="IKEPolicies Resource"></a>IKEPolicies Resource</h4><table>
<thead>
<tr>
<th style="text-align:center">Attribute</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">DefaultValue</th>
<th style="text-align:center">Vaildation Constraint</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">uuid-str</td>
<td style="text-align:center">generated</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">用于IKEPolicy的UUID</td>
</tr>
<tr>
<td style="text-align:center">tenant_id</td>
<td style="text-align:center">uuid-str</td>
<td style="text-align:center">None</td>
<td style="text-align:center">Valid tenant_id</td>
<td style="text-align:center">用于vpn服务的所有者的UUID</td>
</tr>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">string</td>
<td style="text-align:center">None</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">友好的ikepolicy名称</td>
</tr>
<tr>
<td style="text-align:center">description</td>
<td style="text-align:center">string</td>
<td style="text-align:center">None</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">ikepolicy的描述</td>
</tr>
<tr>
<td style="text-align:center">auth_algorithm</td>
<td style="text-align:center">string</td>
<td style="text-align:center">sha1</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">身份验证散列算法“sha1”</td>
</tr>
<tr>
<td style="text-align:center">encryption_algorithm</td>
<td style="text-align:center">string</td>
<td style="text-align:center">aes-128</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">加密算法3des，aes-128，aes-256，aes-192等</td>
</tr>
<tr>
<td style="text-align:center">phase1_negotiation_mode</td>
<td style="text-align:center">string</td>
<td style="text-align:center">Main Mode</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">IKE模式主模式</td>
</tr>
<tr>
<td style="text-align:center">pfs</td>
<td style="text-align:center">string</td>
<td style="text-align:center">Group5</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">完美的正向保密（Group2，Group5，Group14）</td>
</tr>
<tr>
<td style="text-align:center">ike_version</td>
<td style="text-align:center">string</td>
<td style="text-align:center">v1</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">v1或v2版本</td>
</tr>
<tr>
<td style="text-align:center">lifetime</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">units</td>
<td style="text-align:center">string</td>
<td style="text-align:center">seconds</td>
<td style="text-align:center">“seconds”</td>
<td style="text-align:center">SA单元的生命周期,以’秒’为单位</td>
</tr>
<tr>
<td style="text-align:center">value</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">3600 for seconds</td>
<td style="text-align:center">Integer</td>
<td style="text-align:center">以秒为单位的生命周期值（值&gt; = 60）</td>
</tr>
</tbody>
</table>
<h4 id="IPsecPolicies-Resource"><a href="#IPsecPolicies-Resource" class="headerlink" title="IPsecPolicies Resource"></a>IPsecPolicies Resource</h4><table>
<thead>
<tr>
<th style="text-align:center">Attribute</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">DefaultValue</th>
<th style="text-align:center">Vaildation Constraint</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">uuid-str</td>
<td style="text-align:center">generated</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">用于IPsecPolicy的UUID</td>
</tr>
<tr>
<td style="text-align:center">tenant_id</td>
<td style="text-align:center">uuid-str</td>
<td style="text-align:center">None</td>
<td style="text-align:center">Valid tenant_id</td>
<td style="text-align:center">用于vpn服务的所有者的UUID</td>
</tr>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">string</td>
<td style="text-align:center">None</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">友好的IPsecPolicy名称</td>
</tr>
<tr>
<td style="text-align:center">description</td>
<td style="text-align:center">string</td>
<td style="text-align:center">None</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">policy的描述</td>
</tr>
<tr>
<td style="text-align:center">transform_protocol</td>
<td style="text-align:center">string</td>
<td style="text-align:center">ESP</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">使用Tranform协议，例如ESP或AH或AH-ESP</td>
</tr>
<tr>
<td style="text-align:center">encapsulation_mode</td>
<td style="text-align:center">string</td>
<td style="text-align:center">tunnel</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">封装模式为隧道模式或传输模式</td>
</tr>
<tr>
<td style="text-align:center">auth_algorithm</td>
<td style="text-align:center">string</td>
<td style="text-align:center">sha1</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">身份验证散列算法“sha1”</td>
</tr>
<tr>
<td style="text-align:center">encryption_algorithm</td>
<td style="text-align:center">string</td>
<td style="text-align:center">aes-128</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">加密算法3des，aes-128，aes-256，aes-192等</td>
</tr>
<tr>
<td style="text-align:center">pfs</td>
<td style="text-align:center">string</td>
<td style="text-align:center">Group5</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">完美的正向保密（Group2，Group5，Group14）</td>
</tr>
<tr>
<td style="text-align:center">lifetime</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">units</td>
<td style="text-align:center">string</td>
<td style="text-align:center">seconds</td>
<td style="text-align:center">“seconds”</td>
<td style="text-align:center">SA单元的生命周期,以’秒’为单位</td>
</tr>
<tr>
<td style="text-align:center">value</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">3600 for seconds</td>
<td style="text-align:center">Integer</td>
<td style="text-align:center">以秒为单位的生命周期值（值&gt; = 60）</td>
</tr>
</tbody>
</table>
<h4 id="ipsec-site-connection-Resource"><a href="#ipsec-site-connection-Resource" class="headerlink" title="ipsec-site-connection Resource"></a>ipsec-site-connection Resource</h4><table>
<thead>
<tr>
<th style="text-align:center">Attribute</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">DefaultValue</th>
<th style="text-align:center">Vaildation Constraint</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">uuid-str</td>
<td style="text-align:center">generated</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">用于vpn连接的UUID</td>
</tr>
<tr>
<td style="text-align:center">tenant_id</td>
<td style="text-align:center">uuid-str</td>
<td style="text-align:center">None</td>
<td style="text-align:center">valid tenant_id</td>
<td style="text-align:center">用于vpn服务的所有者的UUID</td>
</tr>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">string</td>
<td style="text-align:center">None</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">ipsec-site-connection的名称</td>
</tr>
<tr>
<td style="text-align:center">description</td>
<td style="text-align:center">string</td>
<td style="text-align:center">None</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">ipsec站点连接的描述</td>
</tr>
<tr>
<td style="text-align:center">peer_address</td>
<td style="text-align:center">ipaddress(v4 or v6)</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">valid ip address (v4 or v6)</td>
<td style="text-align:center">对等VPN网关公共地址或FQDN</td>
</tr>
<tr>
<td style="text-align:center">peer_id</td>
<td style="text-align:center">string</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">对等标识符（可以是名称，字符串或FQDN）</td>
</tr>
<tr>
<td style="text-align:center">peer_cidrs</td>
<td style="text-align:center">list[string]</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">valid cidr</td>
<td style="text-align:center">对等私有cidr</td>
</tr>
<tr>
<td style="text-align:center">route_mode</td>
<td style="text-align:center">string</td>
<td style="text-align:center">static</td>
<td style="text-align:center">static</td>
<td style="text-align:center">静态的</td>
</tr>
<tr>
<td style="text-align:center">mtu</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">1500</td>
<td style="text-align:center">Integer</td>
<td style="text-align:center">mtu - 地址分段的最大传输单元（值&gt; = 68）</td>
</tr>
<tr>
<td style="text-align:center">auth_mode</td>
<td style="text-align:center">string</td>
<td style="text-align:center">psk</td>
<td style="text-align:center">psk/certs</td>
<td style="text-align:center">身份验证模式，PSK或证书</td>
</tr>
<tr>
<td style="text-align:center">psk</td>
<td style="text-align:center">string</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">预共享密钥,可以是任何字符串</td>
</tr>
<tr>
<td style="text-align:center">initiator</td>
<td style="text-align:center">string</td>
<td style="text-align:center">bi-directional</td>
<td style="text-align:center">“bi-directional / response-only”</td>
<td style="text-align:center">这个VPN是否只能响应连接或者可以启动</td>
</tr>
<tr>
<td style="text-align:center">admin_state_up</td>
<td style="text-align:center">bool</td>
<td style="text-align:center">True</td>
<td style="text-align:center">“true / false”</td>
<td style="text-align:center">VPN连接的管理状态。 如果为false（down），vpn连接不转发数据包</td>
</tr>
<tr>
<td style="text-align:center">status</td>
<td style="text-align:center">string</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">指示vpn连接当前是否可用。 可能的值包括：ACTIVE，DOWN，BUILD，ERROR</td>
</tr>
<tr>
<td style="text-align:center">ikepolicy_id</td>
<td style="text-align:center">uuid</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">uuid of ikepolicy</td>
<td style="text-align:center">ikepolicy的uuid ID</td>
</tr>
<tr>
<td style="text-align:center">ipsecpolicy_id</td>
<td style="text-align:center">uuid</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">uuid of ipsecpolicy</td>
<td style="text-align:center">ipsecpolicy的uuid ID</td>
</tr>
<tr>
<td style="text-align:center">vpnservice_id</td>
<td style="text-align:center">uuid</td>
<td style="text-align:center">N/A</td>
<td style="text-align:center">uuid of vpnservice</td>
<td style="text-align:center">vpnservice的服务ID</td>
</tr>
<tr>
<td style="text-align:center">dpd</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">action</td>
<td style="text-align:center">string</td>
<td style="text-align:center">hold</td>
<td style="text-align:center">“hold / clear / disabled /restart /restart_by_peer”</td>
<td style="text-align:center">DPD操作控制使用死对等检测协议。 ( clear, hold, restart, disabled, restart-by-peer)</td>
</tr>
<tr>
<td style="text-align:center">interval</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">30</td>
<td style="text-align:center">&gt; 0</td>
<td style="text-align:center">DPD延迟的秒数</td>
</tr>
<tr>
<td style="text-align:center">timeout</td>
<td style="text-align:center">integer</td>
<td style="text-align:center">120</td>
<td style="text-align:center">&gt; 0 &amp; &gt; dpd_interval</td>
<td style="text-align:center">DPD超时的秒数</td>
</tr>
</tbody>
</table>
<h4 id="object-diagram"><a href="#object-diagram" class="headerlink" title="object diagram"></a>object diagram</h4><p>目前，VPNaaS中的设计和对象模型允许每个路由器和每个子网创建1个服务对象。 但是每个服务可以有多个VPN连接对象。具体对象图如下：<br><img src="/images/Neutron-VPNaaS/object_diagram.jpg" alt="object_diagram"></p>
<h3 id="API-命令"><a href="#API-命令" class="headerlink" title="API 命令"></a>API 命令</h3><p>本部分介绍支持VPNaaS高级服务的CLI命令。详细内容见API参考文档: <a href="https://developer.openstack.org/api-ref/network/v2/index.html#vpnaas-2-0-vpn-vpnservices-ikepolicies-ipsecpolicies-endpoint-groups-ipsec-site-connections" target="_blank" rel="noopener">VPNaaS 2.0</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vpn-service-create      Create a VPNService</span><br><span class="line">vpn-service-delete      Delete a given VPNService</span><br><span class="line">vpn-service-list        List all VPNService for a given tenant.</span><br><span class="line">vpn-service-show        Show detailed information of a given VPNService.</span><br><span class="line">vpn-service-update      Update a given VPNservice.</span><br><span class="line"></span><br><span class="line">vpn-ikepolicy-create       Create an IKEPolicy</span><br><span class="line">vpn-ikepolicy-delete       Delete a given IKE Policy.</span><br><span class="line">vpn-ikepolicy-list         List IKEPolicies that belong to a given tenant.</span><br><span class="line">vpn-ikepolicy-show         Show detailed information of a given IKEPolicy.</span><br><span class="line">vpn-ikepolicy-update       Update a given IKE Policy.</span><br><span class="line"></span><br><span class="line">vpn-ipsecpolicy-create     Create an IPsec policy</span><br><span class="line">vpn-ipsecpolicy-delete     Delete a given IPsec Policy</span><br><span class="line">vpn-ipsecpolicy-list       List IPsecPolicies that belong to a given tenant    connection.</span><br><span class="line">vpn-ipsecpolicy-show       Show detailed information of a given IPsec Policy</span><br><span class="line">vpn-ipsecpolicy-update     Update a given IPsec Policy.</span><br><span class="line"></span><br><span class="line">ipsec-site-connection-create  Create a ipsec-site-connection</span><br><span class="line">ipsec-site-connection-delete  Delete a given ipsec-site-connection.</span><br><span class="line">ipsec-site-connection-list    List ipsec-site-connections that belong to a given tenant.</span><br><span class="line">ipsec-site-connection-show    Show information of a given ipsec-site-connection.</span><br><span class="line">ipsec-site-connection-update  Update a given ipsec-site-connection.</span><br><span class="line"></span><br><span class="line">vpn-endpoint-group-create     Create a VPN endpoint groups.</span><br><span class="line">vpn-endpoint-group-delete     Removes a VPN endpoint group.</span><br><span class="line">vpn-endpoint-group-list       Lists VPN endpoint groups.</span><br><span class="line">vpn-endpoint-group-show       Shows details for a VPN endpoint group.</span><br><span class="line">vpn-endpoint-group-update     Updates settings for a VPN endpoint group.</span><br><span class="line"></span><br><span class="line">service-provider-list         List service providers.</span><br></pre></td></tr></table></figure></p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="Devstack快速部署"><a href="#Devstack快速部署" class="headerlink" title="Devstack快速部署"></a>Devstack快速部署</h4><p>使用devstack在单节点上快速安装VPNaaS服务，需要在local.conf文件中添加以下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[[local|localrc]]</span><br><span class="line"></span><br><span class="line">enable_plugin neutron-vpnaas https://git.openstack.org/openstack/neutron-vpnaas</span><br><span class="line"></span><br><span class="line">disable_service n-net</span><br><span class="line">enable_service q-svc</span><br><span class="line">enable_service q-agt</span><br><span class="line">enable_service q-dhcp</span><br><span class="line">enable_service q-l3</span><br><span class="line">enable_service q-meta</span><br><span class="line"># Optional, to enable tempest configuration as part of devstack</span><br><span class="line">enable_service tempest</span><br><span class="line"></span><br><span class="line"># IPSec driver to use. Optional, defaults to strongswan.For example, install libreswan for CentOS/RHEL 7</span><br><span class="line"># IPSEC_PACKAGE=&quot;libreswan&quot;</span><br></pre></td></tr></table></figure></p>
<p>执行stack.sh脚本文件，并且成功完成后，云主机环境中会发生如下变化：</p>
<ul>
<li><p>/etc/neutron/neutron.conf文件中service_plugins后面会增加vpnaas字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">service_plugins = neutron.services.l3_router.l3_router_plugin.L3RouterPlugin,vpnaas</span><br></pre></td></tr></table></figure>
</li>
<li><p>/etc/neutron/目录下会为你配置好neutron_vpnaas.conf文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[service_providers]</span><br><span class="line">service_provider = VPN:strongswan:neutron_vpnaas.services.vpn.service_drivers.ipsec.IPsecVPNDriver:default</span><br><span class="line"># if you want use libreswan，configuration example is as follows</span><br><span class="line">#service_provider = VPN:libreswan:neutron_vpnaas.services.vpn.service_drivers.ipsec.IPsecVPNDriver:default</span><br><span class="line"># From neutron.vpnaas</span><br><span class="line">#</span><br><span class="line"># Defines providers for advanced services using the format:</span><br><span class="line"># &lt;service_type&gt;:&lt;name&gt;:&lt;driver&gt;[:default] (multi valued)</span><br><span class="line">#service_provider =</span><br></pre></td></tr></table></figure>
</li>
<li><p>/etc/neutron/l3_agent.ini中会增加[AGENT]和[vpnagent]项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[AGENT]</span><br><span class="line">extensions = vpnaas</span><br><span class="line">root_helper_daemon = sudo /usr/local/bin/neutron-rootwrap-daemon /etc/neutron/rootwrap.conf</span><br><span class="line">root_helper = sudo /usr/local/bin/neutron-rootwrap /etc/neutron/rootwrap.conf</span><br><span class="line">[vpnagent]</span><br><span class="line">vpn_device_driver = neutron_vpnaas.services.vpn.device_drivers.strongswan_ipsec.StrongSwanDriver</span><br><span class="line"># when use libreswan</span><br><span class="line"># vpn_device_driver = neutron_vpnaas.services.vpn.device_drivers.libreswan_ipsec.LibreSwanDriver</span><br></pre></td></tr></table></figure>
</li>
<li><p>/etc/neutron/rootwrap.d目录下会增加vpnaas.filters权限管理文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># neutron-rootwrap command filters for nodes on which neutron is</span><br><span class="line"># expected to control network</span><br><span class="line"># for libreswan, just change &quot;strongswan&quot; to &quot;libreswan&quot;</span><br><span class="line"># This file should be owned by (and only-writable by) the root user</span><br><span class="line"># format seems to be</span><br><span class="line"># cmd-name: filter-name, raw-command, user, args</span><br><span class="line">[Filters]</span><br><span class="line">cp: RegExpFilter, cp, root, cp, -a, .*, .*/strongswan.d</span><br><span class="line">ip: IpFilter, ip, root</span><br><span class="line">ip_exec: IpNetnsExecFilter, ip, root</span><br><span class="line">ipsec: CommandFilter, ipsec, root</span><br><span class="line">rm: RegExpFilter, rm, root, rm, -rf, (.*/strongswan.d|.*/ipsec/[0-9a-z-]+)</span><br><span class="line">rm_file: RegExpFilter, rm, root, rm, -f, .*/ipsec.secrets</span><br><span class="line">strongswan: CommandFilter, strongswan, root</span><br><span class="line">neutron_netns_wrapper: CommandFilter, neutron-vpn-netns-wrapper, root</span><br><span class="line">neutron_netns_wrapper_local: CommandFilter, /usr/local/bin/neutron-vpn-netns-wrapper, root</span><br><span class="line">chown: RegExpFilter, chown, root, chown, --from=.*, root.root, .*/(ipsec.secrets|ipsec/[0-9a-z-]+/log)</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据库中会增加vpnservice，vpn_endpoint_groups，vpn_endpoints等与VPN服务相关的表:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show tables;</span><br><span class="line">+-----------------------------------------+</span><br><span class="line">| Tables_in_neutron |</span><br><span class="line">+-----------------------------------------+</span><br><span class="line">| address_scopes |</span><br><span class="line">| agents |</span><br><span class="line">| alembic_version |</span><br><span class="line">   ...........</span><br><span class="line">| vpn_endpoint_groups |</span><br><span class="line">| vpn_endpoints |</span><br><span class="line">| vpnservices |</span><br><span class="line">+-----------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="使用软件包安装部署"><a href="#使用软件包安装部署" class="headerlink" title="使用软件包安装部署"></a>使用软件包安装部署</h4><p>手动安装好OpenStack环境后，按以下步骤为环境添加VPN功能</p>
<ol>
<li><p>下载vpnaas软件包，以及实现ipsec的软件包，strongswan，openswan，libreswan等等，注意：目前CentOS不支持strongswan，使用libreswan即可。</p>
<ul>
<li><p>Ubuntu下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install strongswan</span><br><span class="line">pip install neutron-vpnaas</span><br></pre></td></tr></table></figure>
</li>
<li><p>CentOS下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install libreswan</span><br><span class="line">pip install neutron-vpnaas</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>修改配置文件</p>
<ul>
<li><p>修改控制节点上neutron.conf文件，在service_plugins增加对VPNaaS的支持，修改如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">***/etc/neutron/neutron.conf***</span><br><span class="line">[DEFAULT]</span><br><span class="line">service_plugins = ......,vpnaas</span><br></pre></td></tr></table></figure>
</li>
<li><p>在/etc/neutron目录下添加neutron_vpnaas.conf文件，添加[service_providers]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">***/etc/neutron/neutron_vpnaas.conf***</span><br><span class="line">[service_providers]</span><br><span class="line">service_provider = VPN:strongswan:neutron_vpnaas.services.vpn.service_drivers.ipsec.IPsecVPNDriver:default</span><br><span class="line">#</span><br><span class="line"># if you want use libreswan，configuration example is as follows</span><br><span class="line">#service_provider = VPN:libreswan:neutron_vpnaas.services.vpn.service_drivers.ipsec.IPsecVPNDriver:default</span><br><span class="line"># From neutron.vpnaas</span><br><span class="line">#</span><br><span class="line"># Defines providers for advanced services using the format:</span><br><span class="line"># &lt;service_type&gt;:&lt;name&gt;:&lt;driver&gt;[:default] (multi valued)</span><br><span class="line">#service_provider =</span><br></pre></td></tr></table></figure>
</li>
<li><p>在/etc/neutron/l3_agent.ini文件中额外添加以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">***/etc/neutron/l3_agnet.ini***</span><br><span class="line">[AGENT]</span><br><span class="line">extensions = vpnaas</span><br><span class="line">root_helper_daemon = sudo /usr/bin/neutron-rootwrap-daemon /etc/neutron/rootwrap.conf</span><br><span class="line">root_helper = sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf</span><br><span class="line">[vpnagent]</span><br><span class="line">vpn_device_driver = neutron_vpnaas.services.vpn.device_drivers.strongswan_ipsec.StrongSwanDriver</span><br><span class="line"># when use libreswan</span><br><span class="line"># vpn_device_driver = neutron_vpnaas.services.vpn.device_drivers.libreswan_ipsec.LibreSwanDriver</span><br></pre></td></tr></table></figure>
</li>
<li><p>/etc/neutron/rootwrap.conf内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">***/etc/neutron/rootwrap.conf***</span><br><span class="line"># Configuration for neutron-rootwrap</span><br><span class="line"># This file should be owned by (and only-writeable by) the root user</span><br><span class="line">[DEFAULT]</span><br><span class="line"># List of directories to load filter definitions from (separated by &apos;,&apos;).</span><br><span class="line"># These directories MUST all be only writeable by root !</span><br><span class="line">filters_path=/etc/neutron/rootwrap.d</span><br><span class="line"># List of directories to search executables in, in case filters do not</span><br><span class="line"># explicitely specify a full path (separated by &apos;,&apos;)</span><br><span class="line"># If not specified, defaults to system PATH environment variable.</span><br><span class="line"># These directories MUST all be only writeable by root !</span><br><span class="line">exec_dirs=/sbin,/usr/sbin,/bin,/usr/bin,/usr/local/bin,/usr/local/sbin,/usr/local/bin</span><br><span class="line"># Enable logging to syslog</span><br><span class="line"># Default value is False</span><br><span class="line">use_syslog=False</span><br><span class="line"># Which syslog facility to use.</span><br><span class="line"># Valid values include auth, authpriv, syslog, local0, local1...</span><br><span class="line"># Default value is &apos;syslog&apos;</span><br><span class="line">syslog_log_facility=syslog</span><br><span class="line"># Which messages to log.</span><br><span class="line"># INFO means log all usage</span><br><span class="line"># ERROR means only log unsuccessful attempts</span><br><span class="line">syslog_log_level=ERROR</span><br><span class="line">[xenapi]</span><br><span class="line"># XenAPI configuration is only required by the L2 agent if it is to</span><br><span class="line"># target a XenServer/XCP compute host&apos;s dom0.</span><br><span class="line">xenapi_connection_url=&lt;None&gt;</span><br><span class="line">xenapi_connection_username=root</span><br><span class="line">xenapi_connection_password=&lt;None&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在/etc/neutron/rootwrap.d目录下添加权限管理文件vpnaas.filters，默认安装时该目录下没有该文件，所以必须手动将该文件放入，不然运行时会报没有操作权限的错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">***vpnaas.filters***</span><br><span class="line"># neutron-rootwrap command filters for nodes on which neutron is</span><br><span class="line"># expected to control network</span><br><span class="line"># for libreswan, just change &quot;strongswan&quot; to &quot;libreswan&quot;</span><br><span class="line"># This file should be owned by (and only-writable by) the root user</span><br><span class="line"># format seems to be</span><br><span class="line"># cmd-name: filter-name, raw-command, user, args</span><br><span class="line">[Filters]</span><br><span class="line">cp: RegExpFilter, cp, root, cp, -a, .*, .*/strongswan.d</span><br><span class="line">ip: IpFilter, ip, root</span><br><span class="line">ip_exec: IpNetnsExecFilter, ip, root</span><br><span class="line">ipsec: CommandFilter, ipsec, root</span><br><span class="line">rm: RegExpFilter, rm, root, rm, -rf, (.*/strongswan.d|.*/ipsec/[0-9a-z-]+)</span><br><span class="line">rm_file: RegExpFilter, rm, root, rm, -f, .*/ipsec.secrets</span><br><span class="line">strongswan: CommandFilter, strongswan, root</span><br><span class="line">neutron_netns_wrapper: CommandFilter, neutron-vpn-netns-wrapper, root</span><br><span class="line">neutron_netns_wrapper_local: CommandFilter, /usr/local/bin/neutron-vpn-netns-wrapper, root</span><br><span class="line">chown: RegExpFilter, chown, root, chown, --from=.*, root.root, .*/(ipsec.secrets|ipsec/[0-9a-z-]+/log)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>创建和更新数据库中所需要的VPN服务相关的表，更换ipsec driver后，也需要执行以下命令来更新数据库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># neutron-db-manage --subproject neutron-vpnaas upgrade head</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启控制节点上的neutron-server和网络节点上的neutron-l3-agent，各项服务必须正常运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sudo systemctl restart &quot;devstack@q-*&quot;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><em>查看服务状态</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ sudo systemctl list-units | grep devstack</span><br><span class="line">devstack@c-api.service                                                      loaded active running   Devstack devstack@c-api.service</span><br><span class="line">devstack@c-sch.service                                                      loaded active running   Devstack devstack@c-sch.service</span><br><span class="line">devstack@c-vol.service                                                      loaded active running   Devstack devstack@c-vol.service</span><br><span class="line">devstack@dstat.service                                                      loaded active running   Devstack devstack@dstat.service</span><br><span class="line">devstack@etcd.service                                                       loaded active running   Devstack devstack@etcd.service</span><br><span class="line">devstack@g-api.service                                                      loaded active running   Devstack devstack@g-api.service</span><br><span class="line">devstack@g-reg.service                                                      loaded active running   Devstack devstack@g-reg.service</span><br><span class="line">devstack@keystone.service                                                   loaded active running   Devstack devstack@keystone.service</span><br><span class="line">devstack@n-api-meta.service                                                 loaded active running   Devstack devstack@n-api-meta.service</span><br><span class="line">devstack@n-api.service                                                      loaded active running   Devstack devstack@n-api.service</span><br><span class="line">devstack@n-cauth.service                                                    loaded active running   Devstack devstack@n-cauth.service</span><br><span class="line">devstack@n-cond-cell1.service                                               loaded active running   Devstack devstack@n-cond-cell1.service</span><br><span class="line">devstack@n-cpu.service                                                      loaded active running   Devstack devstack@n-cpu.service</span><br><span class="line">devstack@n-novnc-cell1.service                                              loaded active running   Devstack devstack@n-novnc-cell1.service</span><br><span class="line">devstack@n-sch.service                                                      loaded active running   Devstack devstack@n-sch.service</span><br><span class="line">devstack@n-super-cond.service                                               loaded active running   Devstack devstack@n-super-cond.service</span><br><span class="line">devstack@placement-api.service                                              loaded active running   Devstack devstack@placement-api.service</span><br><span class="line">devstack@q-agt.service                                                      loaded active running   Devstack devstack@q-agt.service</span><br><span class="line">devstack@q-dhcp.service                                                     loaded active running   Devstack devstack@q-dhcp.service</span><br><span class="line">devstack@q-l3.service                                                       loaded active running   Devstack devstack@q-l3.service</span><br><span class="line">devstack@q-meta.service                                                     loaded active running   Devstack devstack@q-meta.service</span><br><span class="line">devstack@q-svc.service                                                      loaded active running   Devstack devstack@q-svc.service</span><br><span class="line">system-devstack.slice                                                       loaded active active    system-devstack.slice</span><br></pre></td></tr></table></figure></p>
<p> <strong><em>注意</em></strong>：当采用默认devstack快速部署后，想更换ipsec_driver(如;strongswan→libreswan），同样可以按照以上步骤及配置进行更换，也必须执行neutron-db-manage来更新数据库内容，否则重启neutron服务时会出错。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="使用两个Devstack节点进行测试"><a href="#使用两个Devstack节点进行测试" class="headerlink" title="使用两个Devstack节点进行测试"></a>使用两个Devstack节点进行测试</h4><p>使用两个由公共“public”网络连接的DevStack节点来测试VPNaaS。 第二个节点可以使用与第一个节点相同的公共网络进行设置，但它将使用不同的网关IP（即路由器IP）。 在本次测试中，我们假设有两个DevStack节点（East和West），每个节点都在物理机上运行（如果需要，可以对多个虚拟机执行相同的操作）。 （注意：也可以在一个节点上使用两个虚拟路由器创建类似拓扑）</p>
<p>示例拓扑：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(10.1.0.0/24 - DevStack East)</span><br><span class="line">              |</span><br><span class="line">              |  10.1.0.1</span><br><span class="line">     [Neutron Router]</span><br><span class="line">              |  172.24.4.226</span><br><span class="line">              |</span><br><span class="line">              |  172.24.4.225</span><br><span class="line">     [Internet GW]</span><br><span class="line">              |</span><br><span class="line">              |</span><br><span class="line">     [Internet GW]</span><br><span class="line">              | 172.24.4.232</span><br><span class="line">              |</span><br><span class="line">              | 172.24.4.233</span><br><span class="line">     [Neutron Router]</span><br><span class="line">              |  10.2.0.1</span><br><span class="line">              |</span><br><span class="line">     (10.2.0.0/24 DevStack West)</span><br></pre></td></tr></table></figure></p>
<p>专用物理端口可用于通过物理交换机互连的“public”网络连接（例如：eth2）。 需要将端口添加到每个DevStack节点上的OVS桥（例如：sudo ovs-vsctl add-port br-ex eth2）。</p>
<h5 id="DevStack配置"><a href="#DevStack配置" class="headerlink" title="DevStack配置"></a>DevStack配置</h5><p>对于East节点，可以将以下字段添加到local.conf文件，这将自动为你配置一个10.1.0.0/24的私有网络和172.24.4.0/24的公共网络。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC_SUBNET_NAME=yoursubnet</span><br><span class="line">PRIVATE_SUBNET_NAME=mysubnet</span><br><span class="line">FIXED_RANGE=10.1.0.0/24</span><br><span class="line">NETWORK_GATEWAY=10.1.0.1</span><br><span class="line">PUBLIC_NETWORK_GATEWAY=172.24.4.225</span><br><span class="line">Q_FLOATING_ALLOCATION_POOL=start=172.24.4.226,end=172.24.4.231</span><br></pre></td></tr></table></figure></p>
<p>对于West节点，添加以下内容，以使用不同的本地网络和公共的网关IP。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUBLIC_SUBNET_NAME=yoursubnet</span><br><span class="line">PRIVATE_SUBNET_NAME=mysubnet</span><br><span class="line">FIXED_RANGE=10.2.0.0/24</span><br><span class="line">NETWORK_GATEWAY=10.2.0.1</span><br><span class="line">PUBLIC_NETWORK_GATEWAY=172.24.4.232</span><br><span class="line">Q_FLOATING_ALLOCATION_POOL=start=172.24.4.233,end=172.24.4.238</span><br></pre></td></tr></table></figure></p>
<h5 id="VPNaaS配置"><a href="#VPNaaS配置" class="headerlink" title="VPNaaS配置"></a>VPNaaS配置</h5><p>使用在East和West节点上运行的DevStack并确认连接（即确保可以到另一个节点上路由器/ GW 能够ping通），然后执行以下VPNaaS CLI命令。</p>
<ul>
<li>East节点<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">neutron vpn-ikepolicy-create ikepolicy1</span><br><span class="line">neutron vpn-ipsecpolicy-create ipsecpolicy1</span><br><span class="line">neutron vpn-service-create --name myvpn --description &quot;My vpn service&quot; router1 mysubnet</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neutron ipsec-site-connection-create --name vpnconnection1 --vpnservice-id myvpn --ikepolicy-id ikepolicy1 --ipsecpolicy-id ipsecpolicy1 --peer-address 172.24.4.233 --peer-id 172.24.4.233 --peer-cidr 10.2.0.0/24 --psk secret</span><br></pre></td></tr></table></figure>
<ul>
<li>West节点<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">neutron vpn-ikepolicy-create ikepolicy1</span><br><span class="line">neutron vpn-ipsecpolicy-create ipsecpolicy1</span><br><span class="line">neutron vpn-service-create --name myvpn --description &quot;My vpn service&quot; router1 mysubnet</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neutron ipsec-site-connection-create --name vpnconnection1 --vpnservice-id myvpn --ikepolicy-id ikepolicy1 --ipsecpolicy-id ipsecpolicy1 --peer-address 172.24.4.226 --peer-id 172.24.4.226 --peer-cidr 10.1.0.0/24 --psk secret</span><br></pre></td></tr></table></figure>
<p>注：</p>
<ul>
<li>peer-address 和peer-id 对写成对方router的对外网关ip地址</li>
<li>peer-cidr写成对方路由保护的内网，即想要建立ipsec-site-connection连接的子网</li>
<li>psk可以自定义，只要双方一致即可</li>
</ul>
<h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><p>可以在每个节点上启动VM，然后从VM ping到远端路由器的公共IP。 使用运行在其中一个节点上的tcpdump，可以看到加密数据包（ESP）。</p>
<h4 id="使用单个Devstack节点进行测试"><a href="#使用单个Devstack节点进行测试" class="headerlink" title="使用单个Devstack节点进行测试"></a>使用单个Devstack节点进行测试</h4><p>这里的想法是使用DevStack部署一个OpenStack云，两个路由器（一个自动创建），两个私有网络（自动创建一个）10.1.0.0 / 24和10.2.0.0/24，每个私有网络中有一个虚拟机， 并使用公共网络（172.24.4.0/24）在两个私有网络之间建立VPN连接。</p>
<p>本次示例，local.conf文件内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[[local|localrc]]</span><br><span class="line">GIT_BASE=https://github.com</span><br><span class="line">DEST=/opt/stack</span><br><span class="line"></span><br><span class="line">disable_service n-net</span><br><span class="line">enable_service q-svc</span><br><span class="line">enable_service q-agt</span><br><span class="line">enable_service q-dhcp</span><br><span class="line">enable_service q-l3</span><br><span class="line">enable_service q-meta</span><br><span class="line">enable_service neutron</span><br><span class="line">enable_plugin neutron-vpnaas https://git.openstack.org/openstack/neutron-vpnaas</span><br><span class="line"></span><br><span class="line">FIXED_RANGE=10.1.0.0/24</span><br><span class="line">FIXED_NETWORK_SIZE=256</span><br><span class="line">NETWORK_GATEWAY=10.1.0.1</span><br><span class="line">PRIVATE_SUBNET_NAME=privateA</span><br><span class="line"></span><br><span class="line">PUBLIC_SUBNET_NAME=public-subnet</span><br><span class="line">FLOATING_RANGE=172.24.4.0/24</span><br><span class="line">PUBLIC_NETWORK_GATEWAY=172.24.4.10</span><br><span class="line">Q_FLOATING_ALLOCATION_POOL=&quot;start=172.24.4.11,end=172.24.4.29&quot;</span><br><span class="line"></span><br><span class="line">LIBVIRT_TYPE=qemu</span><br><span class="line"></span><br><span class="line">IMAGE_URLS=&quot;http://cloud-images.ubuntu.com/releases/14.04.1/release/ubuntu-14.04-server-cloudimg-amd64.tar.gz,http://download.cirros-cloud.net/0.3.3/cirros-0.3.3-x86_64-uec.tar.gz&quot;</span><br><span class="line"></span><br><span class="line">SCREEN_LOGDIR=/opt/stack/screen-logs</span><br><span class="line">SYSLOG=True</span><br><span class="line">LOGFILE=~/devstack/stack.sh.log</span><br><span class="line"></span><br><span class="line">ADMIN_PASSWORD=password</span><br><span class="line">MYSQL_PASSWORD=password</span><br><span class="line">RABBIT_PASSWORD=password</span><br><span class="line">SERVICE_PASSWORD=password</span><br><span class="line">SERVICE_TOKEN=tokentoken</span><br><span class="line"></span><br><span class="line">Q_USE_DEBUG_COMMAND=True</span><br><span class="line"></span><br><span class="line"># RECLONE=No</span><br><span class="line">RECLONE=yes</span><br><span class="line">OFFLINE=False</span><br></pre></td></tr></table></figure></p>
<p>执行 ./stack.sh，确保执行成功。</p>
<h5 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h5><p>stack.sh完成后，将拥有一个专用网络（10.1.0.0/24）和一个路由器（router1）。 为了准备建立VPN连接，需要创建第二个网络，子网和路由器，并在每个专用网络中启动一个VM。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Create second net, subnet, router</span><br><span class="line">  source ~/devstack/openrc admin demo</span><br><span class="line">  neutron net-create privateB</span><br><span class="line">  neutron subnet-create --name subB privateB 10.2.0.0/24 --gateway 10.2.0.1</span><br><span class="line">  neutron router-create router2</span><br><span class="line">  neutron router-interface-add router2 subB</span><br><span class="line">  neutron router-gateway-set router2 public</span><br><span class="line"></span><br><span class="line">  # Start up a VM in the privateA subnet.</span><br><span class="line">  PRIVATE_NET=`neutron net-list | grep &apos;private &apos; | cut -f 2 -d&apos; &apos;`</span><br><span class="line">  nova boot --flavor 1 --image cirros-0.3.3-x86_64-uec --nic net-id=$PRIVATE_NET peter</span><br><span class="line"></span><br><span class="line">  # Start up a VM in the privateB subnet</span><br><span class="line">  PRIVATE_NETB=`neutron net-list | grep privateB | cut -f 2 -d&apos; &apos;`</span><br><span class="line">  nova boot --flavor 1 --image cirros-0.3.3-x86_64-uec --nic net-id=$PRIVATE_NETB paul</span><br></pre></td></tr></table></figure></p>
<h5 id="IPSec站点到站点连接创建"><a href="#IPSec站点到站点连接创建" class="headerlink" title="IPSec站点到站点连接创建"></a>IPSec站点到站点连接创建</h5><p>以下命令将创建IPSec连接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Create VPN connections</span><br><span class="line">   neutron vpn-ikepolicy-create ikepolicy</span><br><span class="line">   neutron vpn-ipsecpolicy-create ipsecpolicy</span><br><span class="line">   neutron vpn-service-create --name myvpn --description &quot;My vpn service&quot; router1 privateA</span><br><span class="line">    </span><br><span class="line">   neutron ipsec-site-connection-create --name vpnconnection1 --vpnservice-id myvpn \</span><br><span class="line">   --ikepolicy-id ikepolicy --ipsecpolicy-id ipsecpolicy --peer-address 172.24.4.13 \</span><br><span class="line">   --peer-id 172.24.4.13 --peer-cidr 10.2.0.0/24 --psk secret</span><br><span class="line">    </span><br><span class="line">   neutron vpn-service-create --name myvpnB --description &quot;My vpn serviceB&quot; router2 subB</span><br><span class="line">    </span><br><span class="line">   neutron ipsec-site-connection-create --name vpnconnection2 --vpnservice-id myvpnB \</span><br><span class="line">   --ikepolicy-id ikepolicy --ipsecpolicy-id ipsecpolicy --peer-address 172.24.4.11 \</span><br><span class="line">   --peer-id 172.24.4.11 --peer-cidr 10.1.0.0/24 --psk secret</span><br></pre></td></tr></table></figure></p>
<h5 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h5><p>此时（一旦连接变为Active状态 - 可能需要30秒左右），应该能够从privateA网络中的虚拟机ping到privateB网络中的虚拟机。 如果您使用来自其中一个路由器名称空间的qg-＃##接口进行tcpdump，您将看到加密数据包。 如果删除其中一个连接，您将看到ping失败（如果所有连接都正确）。</p>
<h5 id="MLS-和-Endpoint-group"><a href="#MLS-和-Endpoint-group" class="headerlink" title="*! MLS 和 Endpoint group"></a>*! MLS 和 Endpoint group</h5><p>MLS（Multi local subnets）即多个本地子网。在Mitaka版本中，除了当前的多个对等CIDR之外，IPSec站点间连接还将支持多个本地子网。 创建VPN服务时，多个本地子网功能由未指定本地子网触发。 通过在VPN服务创建中提供子网，可以在单个本地子网中保持向后兼容性。</p>
<p>为了支持多个本地子网，在Liberty版本已经提供了一种叫Endpoint groups的新功能，称为“端点组”。 每个端点组将定义一个或多个特定类型的端点，并可用于为IPSec连接指定本地和对等端点。 端点组将“连接的内容”与VPN服务的“如何连接”分开，并且将来可用于不同flavor的VPN。 一个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Create VPN connections</span><br><span class="line">  neutron vpn-ikepolicy-create ikepolicy</span><br><span class="line">  neutron vpn-ipsecpolicy-create ipsecpolicy</span><br><span class="line">  neutron vpn-service-create --name myvpnC --description &quot;My vpn service&quot; router1</span><br></pre></td></tr></table></figure></p>
<p>要准备IPSec站点到站点，可以为本地子网创建端点组，并为对等CIDR创建端点组，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">neutron vpn-endpoint-group-create --name my-locals --type subnet --value privateA --value privateA2</span><br><span class="line">neutron vpn-endpoint-group-create --name my-peers --type cidr --value 10.2.0.0/24 --value 20.2.0.0/24</span><br></pre></td></tr></table></figure></p>
<p>其中privateA和privateA2是两个本地（专用）子网，10.2.0.0/24和20.2.0.0/24是两个CIDR，代表连接将使用的对等（专用）子网。 然后，在创建IPSec站点到站点连接时，将指定这些端点组ID，而不是peer-cidrs属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">neutron ipsec-site-connection-create --name vpnconnection3 --vpnservice-id myvpnC \</span><br><span class="line">   --ikepolicy-id ikepolicy --ipsecpolicy-id ipsecpolicy --peer-address 172.24.4.11 \</span><br><span class="line">   --peer-id 172.24.4.11 --local-ep-group my-locals --peer-ep-group my-peers --psk secret</span><br></pre></td></tr></table></figure></p>
<h4 id="VPN-test-for-CentOS"><a href="#VPN-test-for-CentOS" class="headerlink" title="VPN test for CentOS"></a>VPN test for CentOS</h4><h5 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h5><p>云主机环境：CentOS7.4<br>Devstack版本：master<br>Openstack版本：master(Rocky，Queens)<br>ipsec_driver类型：libreswan<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[stack@vpnaas devstack]$ neutron service-provider-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+---------------+-------------+---------+</span><br><span class="line">| service_type  | name        | default |</span><br><span class="line">+---------------+-------------+---------+</span><br><span class="line">| L3_ROUTER_NAT | single_node | False   |</span><br><span class="line">| L3_ROUTER_NAT | ha          | False   |</span><br><span class="line">| L3_ROUTER_NAT | dvrha       | False   |</span><br><span class="line">| VPN           | libreswan   | True    |</span><br><span class="line">| L3_ROUTER_NAT | dvr         | False   |</span><br><span class="line">| VPN           | libreswan   | True    |</span><br><span class="line">+---------------+-------------+---------+</span><br></pre></td></tr></table></figure></p>
<h5 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h5><p>Devstack目录下local.conf的配置内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[[local|localrc]]</span><br><span class="line">ADMIN_PASSWORD=secret</span><br><span class="line">DATABASE_PASSWORD=$ADMIN_PASSWORD</span><br><span class="line">RABBIT_PASSWORD=$ADMIN_PASSWORD</span><br><span class="line">SERVICE_PASSWORD=$ADMIN_PASSWORD</span><br><span class="line"></span><br><span class="line">enable_plugin neutron-vpnaas https://git.openstack.org/openstack/neutron-vpnaas</span><br><span class="line">disable_service n-net</span><br><span class="line">enable_service q-svc</span><br><span class="line">enable_service q-agt</span><br><span class="line">enable_service q-dhcp</span><br><span class="line">enable_service q-l3</span><br><span class="line">enable_service q-meta</span><br><span class="line">enable_service tempest</span><br><span class="line"></span><br><span class="line">IPSEC_PACKAGE=&quot;libreswan&quot;</span><br><span class="line"></span><br><span class="line">LOGFILE=$DEST/logs/stack.sh.log</span><br><span class="line">LOGDAYS=2</span><br><span class="line"></span><br><span class="line">SWIFT_HASH=66a3d6b56c1f479c8b4e70ab5c2000f5</span><br><span class="line">SWIFT_REPLICAS=1</span><br><span class="line">SWIFT_DATA_DIR=$DEST/data</span><br></pre></td></tr></table></figure></p>
<p><strong><em>注意</em></strong>：本次测试第一次是使用默认IPSEC_PACKAGE=”strongwan”，最后发现创建vpn-service和ipsec-site-connection状态都是PENDING-CREATE，于是手动安装libreswan，将配置strongswan更改为librewan,具体更改配置步骤参照另一篇文档中使用软件包安装部署，当然你也可以跑devstack时候，在local.conf里面直接指定IPSEC_PACKAGE=”libreswan”，参照上面。</p>
<h5 id="测试方案"><a href="#测试方案" class="headerlink" title="测试方案"></a>测试方案</h5><p>两个不同的vm，各自创建VPN服务，只需要各自VPC对应的VPN-Service里的出口网关IP地址能通即可；可vpn-service里出口IP默认是Router Gateway IP，而只需要将两个vm的external网络设置为同一网段，这样就能达到目标。</p>
<p>具体步骤:</p>
<ol>
<li>为两个vm创建对应的network和所在子网</li>
<li>创建router，并设置网关在同一段external网络，即”public”</li>
<li>各自network下创建vm，并创建ikepolicy，ipsecpolicy，和vpn-service</li>
<li>创建ipsec-site-connection，测试两个vm的连通性</li>
</ol>
<p>网络拓扑:<br><img src="https://raw.githubusercontent.com/Sirius21c/sirius21c.github.io/master/images/Neutron-VPNaaS/centos%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91.png" alt="CentOS测试拓扑"></p>
<h5 id="过程记录"><a href="#过程记录" class="headerlink" title="过程记录"></a>过程记录</h5><ol>
<li><p>创建vpn-network-1，和vpn-network-1，指定子网的CIDR为2.3.4.0/24</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">neutron net-create vpn-network-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new network:</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | True                                 |</span><br><span class="line">| availability_zone_hints   |                                      |</span><br><span class="line">| availability_zones        |                                      |</span><br><span class="line">| created_at                | 2018-07-05T10:14:12Z                 |</span><br><span class="line">| description               |                                      |</span><br><span class="line">| id                        | e6edeb26-b2b7-4c83-ad39-4fc2fe671e6e |</span><br><span class="line">| ipv4_address_scope        |                                      |</span><br><span class="line">| ipv6_address_scope        |                                      |</span><br><span class="line">| is_default                | False                                |</span><br><span class="line">| mtu                       | 1450                                 |</span><br><span class="line">| name                      | vpn-network-1                        |</span><br><span class="line">| port_security_enabled     | True                                 |</span><br><span class="line">| project_id                | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| provider:network_type     | vxlan                                |</span><br><span class="line">| provider:physical_network |                                      |</span><br><span class="line">| provider:segmentation_id  | 15                                   |</span><br><span class="line">| revision_number           | 2                                    |</span><br><span class="line">| router:external           | False                                |</span><br><span class="line">| shared                    | False                                |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   |                                      |</span><br><span class="line">| tags                      |                                      |</span><br><span class="line">| tenant_id                 | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| updated_at                | 2018-07-05T10:14:13Z                 |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">neutron subnet-create --name vpn-subnet-1 vpn-network-1 2.3.4.0/24</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new subnet:</span><br><span class="line">+-------------------+------------------------------------------+</span><br><span class="line">| Field             | Value                                    |</span><br><span class="line">+-------------------+------------------------------------------+</span><br><span class="line">| allocation_pools  | &#123;&quot;start&quot;: &quot;2.3.4.2&quot;, &quot;end&quot;: &quot;2.3.4.254&quot;&#125; |</span><br><span class="line">| cidr              | 2.3.4.0/24                               |</span><br><span class="line">| created_at        | 2018-07-05T10:14:51Z                     |</span><br><span class="line">| description       |                                          |</span><br><span class="line">| dns_nameservers   |                                          |</span><br><span class="line">| enable_dhcp       | True                                     |</span><br><span class="line">| gateway_ip        | 2.3.4.1                                  |</span><br><span class="line">| host_routes       |                                          |</span><br><span class="line">| id                | 79645d5f-59db-47b1-a996-b30d2e513140     |</span><br><span class="line">| ip_version        | 4                                        |</span><br><span class="line">| ipv6_address_mode |                                          |</span><br><span class="line">| ipv6_ra_mode      |                                          |</span><br><span class="line">| name              | vpn-subnet-1                             |</span><br><span class="line">| network_id        | e6edeb26-b2b7-4c83-ad39-4fc2fe671e6e     |</span><br><span class="line">| project_id        | 60ad4059478544e6a4d3d241fdbefa69         |</span><br><span class="line">| revision_number   | 0                                        |</span><br><span class="line">| service_types     |                                          |</span><br><span class="line">| subnetpool_id     |                                          |</span><br><span class="line">| tags              |                                          |</span><br><span class="line">| tenant_id         | 60ad4059478544e6a4d3d241fdbefa69         |</span><br><span class="line">| updated_at        | 2018-07-05T10:14:51Z                     |</span><br><span class="line">+-------------------+------------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建路由器vpn-router-1，为其添加子网vpn-subnet-1，设置其网关为”public”网络</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[stack@vpnaas devstack]$ openstack network list</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">| ID                                   | Name          | Subnets                                                                    |</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">| 0e34b977-8c21-4027-9029-1ff0d53c443c | private       | 00015b05-4e14-4535-864f-04a2991761aa, f30ddb58-d365-4154-88f7-baf0259a6363 |</span><br><span class="line">| cfc1f313-1a12-46d3-b9f0-8a0d0fc83994 | public        | eca99e88-279e-4a4d-9dcd-d2011bbcc58b, eefc51de-718a-4539-a167-e95cab039ae4 |</span><br><span class="line">| e6edeb26-b2b7-4c83-ad39-4fc2fe671e6e | vpn-network-1 | 79645d5f-59db-47b1-a996-b30d2e513140                                       |</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ neutron router-create vpn-router-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new router:</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| Field                   | Value                                |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up          | True                                 |</span><br><span class="line">| availability_zone_hints |                                      |</span><br><span class="line">| availability_zones      |                                      |</span><br><span class="line">| created_at              | 2018-07-05T10:16:23Z                 |</span><br><span class="line">| description             |                                      |</span><br><span class="line">| distributed             | False                                |</span><br><span class="line">| external_gateway_info   |                                      |</span><br><span class="line">| flavor_id               |                                      |</span><br><span class="line">| ha                      | False                                |</span><br><span class="line">| id                      | da70042a-aa92-4b81-a00d-630b8da0f3e2 |</span><br><span class="line">| name                    | vpn-router-1                         |</span><br><span class="line">| project_id              | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| revision_number         | 1                                    |</span><br><span class="line">| routes                  |                                      |</span><br><span class="line">| status                  | ACTIVE                               |</span><br><span class="line">| tags                    |                                      |</span><br><span class="line">| tenant_id               | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| updated_at              | 2018-07-05T10:16:23Z                 |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ neutron router-interface-add vpn-router-1 vpn-subnet-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Added interface 2c1b084d-f618-4cae-9a35-83718976fe40 to router vpn-router-1.</span><br><span class="line">[stack@vpnaas devstack]$ neutron router-gateway-set vpn-router-1 public</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Set gateway for router vpn-router-1</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建vm1,类似创建vpn-network-2及vm2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[stack@vpnaas devstack]$ nova boot --flavor 1 --image cirros-0.3.5-x86_64-disk --nic net-id=e6edeb26-b2b7-4c83-ad39-4fc2fe671e6e vm1</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| Property                             | Value                                                           |</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                    | MANUAL                                                          |</span><br><span class="line">| OS-EXT-AZ:availability_zone          |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                 | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:hostname             | vm1                                                             |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name        |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:kernel_id            |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:launch_index         | 0                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:ramdisk_id           |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:reservation_id       | r-5ufc0lzr                                                      |</span><br><span class="line">| OS-EXT-SRV-ATTR:root_device_name     | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:user_data            | -                                                               |</span><br><span class="line">| OS-EXT-STS:power_state               | 0                                                               |</span><br><span class="line">| OS-EXT-STS:task_state                | scheduling                                                      |</span><br><span class="line">| OS-EXT-STS:vm_state                  | building                                                        |</span><br><span class="line">| OS-SRV-USG:launched_at               | -                                                               |</span><br><span class="line">| OS-SRV-USG:terminated_at             | -                                                               |</span><br><span class="line">| accessIPv4                           |                                                                 |</span><br><span class="line">| accessIPv6                           |                                                                 |</span><br><span class="line">| adminPass                            | zWsm6KWAoBhc                                                    |</span><br><span class="line">| config_drive                         |                                                                 |</span><br><span class="line">| created                              | 2018-07-05T10:20:02Z                                            |</span><br><span class="line">| description                          | -                                                               |</span><br><span class="line">| flavor:disk                          | 1                                                               |</span><br><span class="line">| flavor:ephemeral                     | 0                                                               |</span><br><span class="line">| flavor:extra_specs                   | &#123;&#125;                                                              |</span><br><span class="line">| flavor:original_name                 | m1.tiny                                                         |</span><br><span class="line">| flavor:ram                           | 512                                                             |</span><br><span class="line">| flavor:swap                          | 0                                                               |</span><br><span class="line">| flavor:vcpus                         | 1                                                               |</span><br><span class="line">| hostId                               |                                                                 |</span><br><span class="line">| host_status                          |                                                                 |</span><br><span class="line">| id                                   | 5d88d5c3-ac9a-4330-bf96-6c953c215bf0                            |</span><br><span class="line">| image                                | cirros-0.3.5-x86_64-disk (5cd7bf05-9701-4e40-b6df-d2105457030c) |</span><br><span class="line">| key_name                             | -                                                               |</span><br><span class="line">| locked                               | False                                                           |</span><br><span class="line">| metadata                             | &#123;&#125;                                                              |</span><br><span class="line">| name                                 | vm1                                                             |</span><br><span class="line">| os-extended-volumes:volumes_attached | []                                                              |</span><br><span class="line">| progress                             | 0                                                               |</span><br><span class="line">| security_groups                      | default                                                         |</span><br><span class="line">| status                               | BUILD                                                           |</span><br><span class="line">| tags                                 | []                                                              |</span><br><span class="line">| tenant_id                            | 60ad4059478544e6a4d3d241fdbefa69                                |</span><br><span class="line">| updated                              | 2018-07-05T10:20:02Z                                            |</span><br><span class="line">| user_id                              | 08e7a814d45a4328a330c0bc4a41fa5d                                |</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ neutron net-create vpn-network-2</span><br><span class="line">[stack@vpnaas devstack]$ neutron subnet-create --name vpn-subnet-2 vpn-network-2 4.3.2.0/24</span><br><span class="line">[stack@vpnaas devstack]$ neutron router-create vpn-router-2</span><br><span class="line">[stack@vpnaas devstack]$ neutron router-interface-add vpn-router-2 vpn-subnet-2</span><br><span class="line">[stack@vpnaas devstack]$ neutron router-gateway-set vpn-router-2 public</span><br><span class="line">[stack@vpnaas devstack]$ nova boot --flavor 1 --image cirros-0.3.5-x86_64-disk --nic net-id=2a7d7d49-475f-4868-9d1f-c307bd05c8fe vm2</span><br><span class="line">[stack@vpnaas devstack]$ nova list</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+------------------------+</span><br><span class="line">| ID                                   | Name | Status | Task State | Power State | Networks               |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+------------------------+</span><br><span class="line">| 5d88d5c3-ac9a-4330-bf96-6c953c215bf0 | vm1  | ACTIVE | -          | Running     | vpn-network-1=2.3.4.11 |</span><br><span class="line">| 7971cf68-1b0b-461b-a72c-0d0243928543 | vm2  | ACTIVE | -          | Running     | vpn-network-2=4.3.2.6  |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ openstack network list</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">| ID                                   | Name          | Subnets                                                                    |</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">| 0e34b977-8c21-4027-9029-1ff0d53c443c | private       | 00015b05-4e14-4535-864f-04a2991761aa, f30ddb58-d365-4154-88f7-baf0259a6363 |</span><br><span class="line">| 2a7d7d49-475f-4868-9d1f-c307bd05c8fe | vpn-network-2 | 5035c74b-5d70-4d2b-b7cb-b1014a7c2e35                                       |</span><br><span class="line">| cfc1f313-1a12-46d3-b9f0-8a0d0fc83994 | public        | eca99e88-279e-4a4d-9dcd-d2011bbcc58b, eefc51de-718a-4539-a167-e95cab039ae4 |</span><br><span class="line">| e6edeb26-b2b7-4c83-ad39-4fc2fe671e6e | vpn-network-1 | 79645d5f-59db-47b1-a996-b30d2e513140                                       |</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ openstack router list</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">| ID                                   | Name         | Status | State | Distributed | HA    | Project                          |</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">| 6aaa82da-d904-468c-b643-220d96cf3841 | router1      | ACTIVE | UP    | False       | False | 3cf6626d7c3a4fc2b43deda4493a38ab |</span><br><span class="line">| 9ae51377-14b2-40c0-917e-c93a32ed6b76 | vpn-router-2 | ACTIVE | UP    | False       | False | 60ad4059478544e6a4d3d241fdbefa69 |</span><br><span class="line">| da70042a-aa92-4b81-a00d-630b8da0f3e2 | vpn-router-1 | ACTIVE | UP    | False       | False | 60ad4059478544e6a4d3d241fdbefa69 |</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ openstack subnet list</span><br><span class="line">+--------------------------------------+---------------------+--------------------------------------+---------------------+</span><br><span class="line">| ID                                   | Name                | Network                              | Subnet              |</span><br><span class="line">+--------------------------------------+---------------------+--------------------------------------+---------------------+</span><br><span class="line">| 00015b05-4e14-4535-864f-04a2991761aa | ipv6-private-subnet | 0e34b977-8c21-4027-9029-1ff0d53c443c | fd19:a538:3b0f::/64 |</span><br><span class="line">| 5035c74b-5d70-4d2b-b7cb-b1014a7c2e35 | vpn-subnet-2        | 2a7d7d49-475f-4868-9d1f-c307bd05c8fe | 4.3.2.0/24          |</span><br><span class="line">| 79645d5f-59db-47b1-a996-b30d2e513140 | vpn-subnet-1        | e6edeb26-b2b7-4c83-ad39-4fc2fe671e6e | 2.3.4.0/24          |</span><br><span class="line">| eca99e88-279e-4a4d-9dcd-d2011bbcc58b | ipv6-public-subnet  | cfc1f313-1a12-46d3-b9f0-8a0d0fc83994 | 2001:db8::/64       |</span><br><span class="line">| eefc51de-718a-4539-a167-e95cab039ae4 | public-subnet       | cfc1f313-1a12-46d3-b9f0-8a0d0fc83994 | 172.24.4.0/24       |</span><br><span class="line">| f30ddb58-d365-4154-88f7-baf0259a6363 | privateA            | 0e34b977-8c21-4027-9029-1ff0d53c443c | 10.0.0.0/26         |</span><br><span class="line">+--------------------------------------+---------------------+--------------------------------------+---------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建ikepolicy和ipsecpolicy和vpn-service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">[stack@vpnaas devstack]$ neutron vpn-ikepolicy-create vpn-ikepolicy-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ikepolicy:</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| Field                   | Value                                |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| auth_algorithm          | sha1                                 |</span><br><span class="line">| description             |                                      |</span><br><span class="line">| encryption_algorithm    | aes-128                              |</span><br><span class="line">| id                      | 1b6d0d3c-da17-4d61-961b-0b8585bfce21 |</span><br><span class="line">| ike_version             | v1                                   |</span><br><span class="line">| lifetime                | &#123;&quot;units&quot;: &quot;seconds&quot;, &quot;value&quot;: 3600&#125;  |</span><br><span class="line">| name                    | vpn-ikepolicy-1                      |</span><br><span class="line">| pfs                     | group5                               |</span><br><span class="line">| phase1_negotiation_mode | main                                 |</span><br><span class="line">| project_id              | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| tenant_id               | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ neutron vpn-ikepolicy-create vpn-ikepolicy-2</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ikepolicy:</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| Field                   | Value                                |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| auth_algorithm          | sha1                                 |</span><br><span class="line">| description             |                                      |</span><br><span class="line">| encryption_algorithm    | aes-128                              |</span><br><span class="line">| id                      | 9932a063-1df6-4b99-968b-3320a45ff2e8 |</span><br><span class="line">| ike_version             | v1                                   |</span><br><span class="line">| lifetime                | &#123;&quot;units&quot;: &quot;seconds&quot;, &quot;value&quot;: 3600&#125;  |</span><br><span class="line">| name                    | vpn-ikepolicy-2                      |</span><br><span class="line">| pfs                     | group5                               |</span><br><span class="line">| phase1_negotiation_mode | main                                 |</span><br><span class="line">| project_id              | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| tenant_id               | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ neutron vpn-ipsecpolicy-create vpn-ipsecpolicy-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ipsecpolicy:</span><br><span class="line">+----------------------+--------------------------------------+</span><br><span class="line">| Field                | Value                                |</span><br><span class="line">+----------------------+--------------------------------------+</span><br><span class="line">| auth_algorithm       | sha1                                 |</span><br><span class="line">| description          |                                      |</span><br><span class="line">| encapsulation_mode   | tunnel                               |</span><br><span class="line">| encryption_algorithm | aes-128                              |</span><br><span class="line">| id                   | 73af30cb-e34b-4ca6-9dd8-1ea30b132284 |</span><br><span class="line">| lifetime             | &#123;&quot;units&quot;: &quot;seconds&quot;, &quot;value&quot;: 3600&#125;  |</span><br><span class="line">| name                 | vpn-ipsecpolicy-1                    |</span><br><span class="line">| pfs                  | group5                               |</span><br><span class="line">| project_id           | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| tenant_id            | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| transform_protocol   | esp                                  |</span><br><span class="line">+----------------------+--------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ neutron vpn-ipsecpolicy-create vpn-ipsecpolicy-2</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ipsecpolicy:</span><br><span class="line">+----------------------+--------------------------------------+</span><br><span class="line">| Field                | Value                                |</span><br><span class="line">+----------------------+--------------------------------------+</span><br><span class="line">| auth_algorithm       | sha1                                 |</span><br><span class="line">| description          |                                      |</span><br><span class="line">| encapsulation_mode   | tunnel                               |</span><br><span class="line">| encryption_algorithm | aes-128                              |</span><br><span class="line">| id                   | c40a7b02-2745-49c5-bfb4-435e4d98bd0a |</span><br><span class="line">| lifetime             | &#123;&quot;units&quot;: &quot;seconds&quot;, &quot;value&quot;: 3600&#125;  |</span><br><span class="line">| name                 | vpn-ipsecpolicy-2                    |</span><br><span class="line">| pfs                  | group5                               |</span><br><span class="line">| project_id           | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| tenant_id            | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| transform_protocol   | esp                                  |</span><br><span class="line">+----------------------+--------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ neutron vpn-service-create vpn-router-1 vpn-subnet-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new vpnservice:</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">| Field          | Value                                |</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">| admin_state_up | True                                 |</span><br><span class="line">| description    |                                      |</span><br><span class="line">| external_v4_ip | 172.24.4.14                          |</span><br><span class="line">| external_v6_ip | 2001:db8::b                          |</span><br><span class="line">| flavor_id      |                                      |</span><br><span class="line">| id             | f46567dc-6752-497e-a9bd-97bffcc40ba0 |</span><br><span class="line">| name           |                                      |</span><br><span class="line">| project_id     | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| router_id      | da70042a-aa92-4b81-a00d-630b8da0f3e2 |</span><br><span class="line">| status         | PENDING_CREATE                       |</span><br><span class="line">| subnet_id      | 79645d5f-59db-47b1-a996-b30d2e513140 |</span><br><span class="line">| tenant_id      | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ neutron vpn-service-create vpn-router-2 vpn-subnet-2</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new vpnservice:</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">| Field          | Value                                |</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">| admin_state_up | True                                 |</span><br><span class="line">| description    |                                      |</span><br><span class="line">| external_v4_ip | 172.24.4.12                          |</span><br><span class="line">| external_v6_ip | 2001:db8::9                          |</span><br><span class="line">| flavor_id      |                                      |</span><br><span class="line">| id             | 056b7032-d26e-40a7-9e5a-0dd2cdd8e2b7 |</span><br><span class="line">| name           |                                      |</span><br><span class="line">| project_id     | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">| router_id      | 9ae51377-14b2-40c0-917e-c93a32ed6b76 |</span><br><span class="line">| status         | PENDING_CREATE                       |</span><br><span class="line">| subnet_id      | 5035c74b-5d70-4d2b-b7cb-b1014a7c2e35 |</span><br><span class="line">| tenant_id      | 60ad4059478544e6a4d3d241fdbefa69     |</span><br><span class="line">+----------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建ipsec-site-connection</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[stack@vpnaas devstack]$ neutron ipsec-site-connection-create --name connectionA --vpnservice-id f46567dc-6752-497e-a9bd-97bffcc40ba0 --ikepolicy-id 1b6d0d3c-da17-4d61-961b-0b8585bfce21 --ipsecpolicy-id 73af30cb-e34b-4ca6-9dd8-1ea30b132284 --peer-address 172.24.4.12 --peer-id 172.24.4.12 --peer-cidr 4.3.2.0/24 --psk lizenghui_key</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ipsec_site_connection:</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| Field             | Value                                              |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| admin_state_up    | True                                               |</span><br><span class="line">| auth_mode         | psk                                                |</span><br><span class="line">| description       |                                                    |</span><br><span class="line">| dpd               | &#123;&quot;action&quot;: &quot;hold&quot;, &quot;interval&quot;: 30, &quot;timeout&quot;: 120&#125; |</span><br><span class="line">| id                | ccab8f61-3998-4526-a0be-28dcda09871d               |</span><br><span class="line">| ikepolicy_id      | 1b6d0d3c-da17-4d61-961b-0b8585bfce21               |</span><br><span class="line">| initiator         | bi-directional                                     |</span><br><span class="line">| ipsecpolicy_id    | 73af30cb-e34b-4ca6-9dd8-1ea30b132284               |</span><br><span class="line">| local_ep_group_id |                                                    |</span><br><span class="line">| local_id          |                                                    |</span><br><span class="line">| mtu               | 1500                                               |</span><br><span class="line">| name              | connectionA                                        |</span><br><span class="line">| peer_address      | 172.24.4.12                                        |</span><br><span class="line">| peer_cidrs        | 4.3.2.0/24                                         |</span><br><span class="line">| peer_ep_group_id  |                                                    |</span><br><span class="line">| peer_id           | 172.24.4.12                                        |</span><br><span class="line">| project_id        | 60ad4059478544e6a4d3d241fdbefa69                   |</span><br><span class="line">| psk               | lizenghui_key                                      |</span><br><span class="line">| route_mode        | static                                             |</span><br><span class="line">| status            | PENDING_CREATE                                     |</span><br><span class="line">| tenant_id         | 60ad4059478544e6a4d3d241fdbefa69                   |</span><br><span class="line">| vpnservice_id     | f46567dc-6752-497e-a9bd-97bffcc40ba0               |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">neutron ipsec-site-connection-create --name connectionB --vpnservice-id 056b7032-d26e-40a7-9e5a-0dd2cdd8e2b7 --ikepolicy-id 9932a063-1df6-4b99-968b-3320a45ff2e8 --ipsecpolicy-id c40a7b02-2745-49c5-bfb4-435e4d98bd0a --peer-address 172.24.4.14 --peer-id 172.24.4.14 --peer-cidr 2.3.4.0/24 --psk lizenghui_key</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ipsec_site_connection:</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| Field             | Value                                              |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| admin_state_up    | True                                               |</span><br><span class="line">| auth_mode         | psk                                                |</span><br><span class="line">| description       |                                                    |</span><br><span class="line">| dpd               | &#123;&quot;action&quot;: &quot;hold&quot;, &quot;interval&quot;: 30, &quot;timeout&quot;: 120&#125; |</span><br><span class="line">| id                | b37e51cc-9cdd-45b0-98d8-c13a5fd2f41c               |</span><br><span class="line">| ikepolicy_id      | 9932a063-1df6-4b99-968b-3320a45ff2e8               |</span><br><span class="line">| initiator         | bi-directional                                     |</span><br><span class="line">| ipsecpolicy_id    | c40a7b02-2745-49c5-bfb4-435e4d98bd0a               |</span><br><span class="line">| local_ep_group_id |                                                    |</span><br><span class="line">| local_id          |                                                    |</span><br><span class="line">| mtu               | 1500                                               |</span><br><span class="line">| name              | connectionB                                        |</span><br><span class="line">| peer_address      | 172.24.4.14                                        |</span><br><span class="line">| peer_cidrs        | 2.3.4.0/24                                         |</span><br><span class="line">| peer_ep_group_id  |                                                    |</span><br><span class="line">| peer_id           | 172.24.4.14                                        |</span><br><span class="line">| project_id        | 60ad4059478544e6a4d3d241fdbefa69                   |</span><br><span class="line">| psk               | lizenghui_key                                      |</span><br><span class="line">| route_mode        | static                                             |</span><br><span class="line">| status            | PENDING_CREATE                                     |</span><br><span class="line">| tenant_id         | 60ad4059478544e6a4d3d241fdbefa69                   |</span><br><span class="line">| vpnservice_id     | 056b7032-d26e-40a7-9e5a-0dd2cdd8e2b7               |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">[stack@vpnaas devstack]$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| id                                   | name        | tenant_id                        | peer_address | auth_mode | status |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| b37e51cc-9cdd-45b0-98d8-c13a5fd2f41c | connectionB | 60ad4059478544e6a4d3d241fdbefa69 | 172.24.4.14  | psk       | ACTIVE |</span><br><span class="line">| ccab8f61-3998-4526-a0be-28dcda09871d | connectionA | 60ad4059478544e6a4d3d241fdbefa69 | 172.24.4.12  | psk       | ACTIVE |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试vm1和vm2的连通性，能够ping通，删掉site-connection后，无法ping通</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">[stack@vpnaas ~]$ openstack router list</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">| ID                                   | Name         | Status | State | Distributed | HA    | Project                          |</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">| 6aaa82da-d904-468c-b643-220d96cf3841 | router1      | ACTIVE | UP    | False       | False | 3cf6626d7c3a4fc2b43deda4493a38ab |</span><br><span class="line">| 9ae51377-14b2-40c0-917e-c93a32ed6b76 | vpn-router-2 | ACTIVE | UP    | False       | False | 60ad4059478544e6a4d3d241fdbefa69 |</span><br><span class="line">| da70042a-aa92-4b81-a00d-630b8da0f3e2 | vpn-router-1 | ACTIVE | UP    | False       | False | 60ad4059478544e6a4d3d241fdbefa69 |</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">[stack@vpnaas ~]$ nova list</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+------------------------+</span><br><span class="line">| ID                                   | Name | Status | Task State | Power State | Networks               |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+------------------------+</span><br><span class="line">| 5d88d5c3-ac9a-4330-bf96-6c953c215bf0 | vm1  | ACTIVE | -          | Running     | vpn-network-1=2.3.4.11 |</span><br><span class="line">| 7971cf68-1b0b-461b-a72c-0d0243928543 | vm2  | ACTIVE | -          | Running     | vpn-network-2=4.3.2.6  |</span><br><span class="line">+--------------------------------------+------+--------+------------+-------------+------------------------+</span><br><span class="line">[stack@vpnaas ~]$ sudo ip netns exec qrouter-da70042a-aa92-4b81-a00d-630b8da0f3e2 ssh cirros@2.3.4.11</span><br><span class="line">The authenticity of host &apos;2.3.4.11 (2.3.4.11)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is SHA256:quCmsfIs7PjSTxkwF+ZWTgVW6biLCUv2CovYtbMLkek.</span><br><span class="line">RSA key fingerprint is MD5:7c:c7:9e:54:0c:a2:1c:66:2a:18:37:d8:6d:d5:03:20.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;2.3.4.11&apos; (RSA) to the list of known hosts.</span><br><span class="line">cirros@2.3.4.11&apos;s password:</span><br><span class="line">$ ping 4.3.2.6</span><br><span class="line">PING 4.3.2.6 (4.3.2.6): 56 data bytes</span><br><span class="line">64 bytes from 4.3.2.6: seq=0 ttl=62 time=11.136 ms</span><br><span class="line">64 bytes from 4.3.2.6: seq=1 ttl=62 time=2.416 ms</span><br><span class="line">64 bytes from 4.3.2.6: seq=2 ttl=62 time=1.563 ms</span><br><span class="line">64 bytes from 4.3.2.6: seq=3 ttl=62 time=1.402 ms</span><br><span class="line">64 bytes from 4.3.2.6: seq=4 ttl=62 time=1.457 ms</span><br><span class="line">64 bytes from 4.3.2.6: seq=5 ttl=62 time=1.745 ms</span><br><span class="line">64 bytes from 4.3.2.6: seq=6 ttl=62 time=1.462 ms</span><br><span class="line">64 bytes from 4.3.2.6: seq=7 ttl=62 time=1.726 ms</span><br><span class="line">^C</span><br><span class="line">--- 4.3.2.6 ping statistics ---</span><br><span class="line">8 packets transmitted, 8 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 1.402/2.863/11.136 ms</span><br><span class="line">$ exit</span><br><span class="line">Connection to 2.3.4.11 closed.</span><br><span class="line">[stack@vpnaas ~]$ sudo ip netns exec qrouter-9ae51377-14b2-40c0-917e-c93a32ed6b76 ssh cirros@4.3.2.6</span><br><span class="line">The authenticity of host &apos;4.3.2.6 (4.3.2.6)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is SHA256:iJlXmthJVWjemtbNfCTqWjO7ePihSXrEpD1+ocCNCXI.</span><br><span class="line">RSA key fingerprint is MD5:d8:3b:2e:70:98:41:22:de:04:f3:02:69:08:50:99:06.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;4.3.2.6&apos; (RSA) to the list of known hosts.</span><br><span class="line">cirros@4.3.2.6&apos;s password:</span><br><span class="line">$ ping 2.3.4.11</span><br><span class="line">PING 2.3.4.11 (2.3.4.11): 56 data bytes</span><br><span class="line">64 bytes from 2.3.4.11: seq=0 ttl=62 time=5.454 ms</span><br><span class="line">64 bytes from 2.3.4.11: seq=1 ttl=62 time=1.406 ms</span><br><span class="line">64 bytes from 2.3.4.11: seq=2 ttl=62 time=1.584 ms</span><br><span class="line">64 bytes from 2.3.4.11: seq=3 ttl=62 time=1.577 ms</span><br><span class="line">64 bytes from 2.3.4.11: seq=4 ttl=62 time=1.412 ms</span><br><span class="line">64 bytes from 2.3.4.11: seq=5 ttl=62 time=1.335 ms</span><br><span class="line">64 bytes from 2.3.4.11: seq=6 ttl=62 time=2.119 ms</span><br><span class="line">^C</span><br><span class="line">--- 2.3.4.11 ping statistics ---</span><br><span class="line">7 packets transmitted, 7 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 1.335/2.126/5.454 ms</span><br><span class="line">$ exit</span><br><span class="line">Connection to 4.3.2.6 closed.</span><br><span class="line">[stack@vpnaas ~]$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| id                                   | name        | tenant_id                        | peer_address | auth_mode | status |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| b37e51cc-9cdd-45b0-98d8-c13a5fd2f41c | connectionB | 60ad4059478544e6a4d3d241fdbefa69 | 172.24.4.14  | psk       | ACTIVE |</span><br><span class="line">| ccab8f61-3998-4526-a0be-28dcda09871d | connectionA | 60ad4059478544e6a4d3d241fdbefa69 | 172.24.4.12  | psk       | ACTIVE |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">[stack@vpnaas ~]$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| id                                   | name        | tenant_id                        | peer_address | auth_mode | status |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| b37e51cc-9cdd-45b0-98d8-c13a5fd2f41c | connectionB | 60ad4059478544e6a4d3d241fdbefa69 | 172.24.4.14  | psk       | ACTIVE |</span><br><span class="line">| ccab8f61-3998-4526-a0be-28dcda09871d | connectionA | 60ad4059478544e6a4d3d241fdbefa69 | 172.24.4.12  | psk       | ACTIVE |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">[stack@vpnaas ~]$ neutron ipsec-site-connection-delete b37e51cc-9cdd-45b0-98d8-c13a5fd2f41c</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Deleted ipsec_site_connection(s): b37e51cc-9cdd-45b0-98d8-c13a5fd2f41c</span><br><span class="line">[stack@vpnaas ~]$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| id                                   | name        | tenant_id                        | peer_address | auth_mode | status |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| ccab8f61-3998-4526-a0be-28dcda09871d | connectionA | 60ad4059478544e6a4d3d241fdbefa69 | 172.24.4.12  | psk       | ACTIVE |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">[stack@vpnaas ~]$ sudo ip netns exec qrouter-da70042a-aa92-4b81-a00d-630b8da0f3e2 ssh cirros@2.3.4.11</span><br><span class="line">cirros@2.3.4.11&apos;s password:</span><br><span class="line">$ ping 4.3.2.6</span><br><span class="line">PING 4.3.2.6 (4.3.2.6): 56 data bytes</span><br><span class="line">^C</span><br><span class="line">--- 4.3.2.6 ping statistics ---</span><br><span class="line">5 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line">$ exit</span><br><span class="line">Connection to 2.3.4.11 closed.</span><br><span class="line">[stack@vpnaas ~]$ sudo ip netns exec qrouter-9ae51377-14b2-40c0-917e-c93a32ed6b76 ssh cirros@4.3.2.6</span><br><span class="line">cirros@4.3.2.6&apos;s password:</span><br><span class="line">$ ping 2.3.4.11</span><br><span class="line">PING 2.3.4.11 (2.3.4.11): 56 data bytes</span><br><span class="line">^C</span><br><span class="line">--- 2.3.4.11 ping statistics ---</span><br><span class="line">4 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line">$ exit</span><br><span class="line">Connection to 4.3.2.6 closed.</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="分析与总结"><a href="#分析与总结" class="headerlink" title="分析与总结"></a>分析与总结</h5><ul>
<li>CentOS不支持ipsec_duiver类型为strongswan，推荐Fedora/RHEL/CentOS系统使用libreswan。</li>
<li>Endpoint group测试可参照另一篇文档 <a href="#Endpoint-group功能测试">Endpoint group功能测试</a>。</li>
<li>如果已经在CentOS上装了strongswan，下载libreswan软件包，修改配置文件配置一下，将strongswan改成libreswan，然后更新neutron数据库，重启neutron相关服务即可。配置过程参照<a href="#使用软件包安装部署">使用软件包安装部署</a>。</li>
<li>建立ipsec-site-connection连接时双方psk值必须一致匹配。</li>
</ul>
<h4 id="VPN-test-for-Ubuntu"><a href="#VPN-test-for-Ubuntu" class="headerlink" title="VPN test for Ubuntu"></a>VPN test for Ubuntu</h4><h5 id="测试环境-1"><a href="#测试环境-1" class="headerlink" title="测试环境"></a>测试环境</h5><p>云主机环境：Ubuntu16.04<br>Devstack版本：master<br>Openstack版本：master(Rocky，Queens)<br>IPsec_driver类型：strongswan<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron service-provider-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+---------------+-------------+---------+</span><br><span class="line">| service_type  | name        | default |</span><br><span class="line">+---------------+-------------+---------+</span><br><span class="line">| L3_ROUTER_NAT | single_node | False   |</span><br><span class="line">| L3_ROUTER_NAT | ha          | False   |</span><br><span class="line">| L3_ROUTER_NAT | dvrha       | False   |</span><br><span class="line">| VPN           | strongswan  | True    |</span><br><span class="line">| L3_ROUTER_NAT | dvr         | False   |</span><br><span class="line">| VPN           | strongswan  | True    |</span><br><span class="line">+---------------+-------------+---------+</span><br></pre></td></tr></table></figure></p>
<h5 id="环境配置-1"><a href="#环境配置-1" class="headerlink" title="环境配置"></a>环境配置</h5><p>Devstack目录下local.conf的配置内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[[local|localrc]]</span><br><span class="line"></span><br><span class="line">ADMIN_PASSWORD=secret</span><br><span class="line">DATABASE_PASSWORD=$ADMIN_PASSWORD</span><br><span class="line">RABBIT_PASSWORD=$ADMIN_PASSWORD</span><br><span class="line">SERVICE_PASSWORD=$ADMIN_PASSWORD</span><br><span class="line"></span><br><span class="line">enable_plugin neutron-vpnaas https://git.openstack.org/openstack/neutron-vpnaas</span><br><span class="line">disable_service n-net</span><br><span class="line">enable_service q-svc</span><br><span class="line">enable_service q-agt</span><br><span class="line">enable_service q-dhcp</span><br><span class="line">enable_service q-l3</span><br><span class="line">enable_service q-meta</span><br><span class="line">enable_service tempest</span><br><span class="line"></span><br><span class="line">IPSEC_PACKAGE=&quot;strongswan&quot;</span><br><span class="line"></span><br><span class="line">LOGFILE=$DEST/logs/stack.sh.log</span><br><span class="line">LOGDAYS=2</span><br><span class="line"></span><br><span class="line">SWIFT_HASH=66a3d6b56c1f479c8b4e70ab5c2000f5</span><br><span class="line">SWIFT_REPLICAS=1</span><br></pre></td></tr></table></figure></p>
<h5 id="测试方案-1"><a href="#测试方案-1" class="headerlink" title="测试方案"></a>测试方案</h5><p>环境是ALL-IN-ONE单节点Openstack，两个不同的vm，各自创建VPN服务，只需要各自VPC对应的VPN-Service里的出口网关IP地址能通即可；可vpn-service里出口IP默认是Router Gateway IP，而只需要将两个vm的external网络设置为同一网段，这样就能达到目标。</p>
<p>具体步骤:</p>
<ol>
<li>为两个vm创建对应的network和所在子网</li>
<li>创建router，并设置网关在同一段external网络，即”public”</li>
<li>各自network下创建vm，并创建ikepolicy，ipsecpolicy，和vpn-service</li>
<li>创建ipsec-site-connection，测试两个vm的连通性</li>
</ol>
<p>网络拓扑:<br><img src="https://raw.githubusercontent.com/Sirius21c/sirius21c.github.io/master/images/Neutron-VPNaaS/ubuntu%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91.png" alt="ubuntu测试拓扑"></p>
<h5 id="过程记录-1"><a href="#过程记录-1" class="headerlink" title="过程记录"></a>过程记录</h5><ol>
<li><p>创建network和相应子网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ neutron net-create vpn-network-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new network:</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | True                                 |</span><br><span class="line">| availability_zone_hints   |                                      |</span><br><span class="line">| availability_zones        |                                      |</span><br><span class="line">| created_at                | 2018-07-04T09:02:12Z                 |</span><br><span class="line">| description               |                                      |</span><br><span class="line">| id                        | 8f71bd0e-d26e-405b-8e48-68148fef8ed1 |</span><br><span class="line">| ipv4_address_scope        |                                      |</span><br><span class="line">| ipv6_address_scope        |                                      |</span><br><span class="line">| is_default                | False                                |</span><br><span class="line">| mtu                       | 1450                                 |</span><br><span class="line">| name                      | vpn-network-1                        |</span><br><span class="line">| port_security_enabled     | True                                 |</span><br><span class="line">| project_id                | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| provider:network_type     | vxlan                                |</span><br><span class="line">| provider:physical_network |                                      |</span><br><span class="line">| provider:segmentation_id  | 35                                   |</span><br><span class="line">| revision_number           | 1                                    |</span><br><span class="line">| router:external           | False                                |</span><br><span class="line">| shared                    | False                                |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   |                                      |</span><br><span class="line">| tags                      |                                      |</span><br><span class="line">| tenant_id                 | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| updated_at                | 2018-07-04T09:02:12Z                 |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron subnet-create --name vpn-subnet-1 vpn-network-1 10.1.0.0/24 --gateway 10.1.0.1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new subnet:</span><br><span class="line">+-------------------+--------------------------------------------+</span><br><span class="line">| Field             | Value                                      |</span><br><span class="line">+-------------------+--------------------------------------------+</span><br><span class="line">| allocation_pools  | &#123;&quot;start&quot;: &quot;10.1.0.2&quot;, &quot;end&quot;: &quot;10.1.0.254&quot;&#125; |</span><br><span class="line">| cidr              | 10.1.0.0/24                                |</span><br><span class="line">| created_at        | 2018-07-04T09:03:32Z                       |</span><br><span class="line">| description       |                                            |</span><br><span class="line">| dns_nameservers   |                                            |</span><br><span class="line">| enable_dhcp       | True                                       |</span><br><span class="line">| gateway_ip        | 10.1.0.1                                   |</span><br><span class="line">| host_routes       |                                            |</span><br><span class="line">| id                | 840b87e2-c78c-45cb-92e7-2272ef6e0821       |</span><br><span class="line">| ip_version        | 4                                          |</span><br><span class="line">| ipv6_address_mode |                                            |</span><br><span class="line">| ipv6_ra_mode      |                                            |</span><br><span class="line">| name              | vpn-subnet-1                               |</span><br><span class="line">| network_id        | 8f71bd0e-d26e-405b-8e48-68148fef8ed1       |</span><br><span class="line">| project_id        | da717c389f494c3e8e6d32f46142d610           |</span><br><span class="line">| revision_number   | 0                                          |</span><br><span class="line">| service_types     |                                            |</span><br><span class="line">| subnetpool_id     |                                            |</span><br><span class="line">| tags              |                                            |</span><br><span class="line">| tenant_id         | da717c389f494c3e8e6d32f46142d610           |</span><br><span class="line">| updated_at        | 2018-07-04T09:03:32Z                       |</span><br><span class="line">+-------------------+--------------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron net-create vpn-network-2</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new network:</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | True                                 |</span><br><span class="line">| availability_zone_hints   |                                      |</span><br><span class="line">| availability_zones        |                                      |</span><br><span class="line">| created_at                | 2018-07-04T09:03:55Z                 |</span><br><span class="line">| description               |                                      |</span><br><span class="line">| id                        | 137d45d3-820f-409c-aac7-12ef9be66cb2 |</span><br><span class="line">| ipv4_address_scope        |                                      |</span><br><span class="line">| ipv6_address_scope        |                                      |</span><br><span class="line">| is_default                | False                                |</span><br><span class="line">| mtu                       | 1450                                 |</span><br><span class="line">| name                      | vpn-network-2                        |</span><br><span class="line">| port_security_enabled     | True                                 |</span><br><span class="line">| project_id                | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| provider:network_type     | vxlan                                |</span><br><span class="line">| provider:physical_network |                                      |</span><br><span class="line">| provider:segmentation_id  | 87                                   |</span><br><span class="line">| revision_number           | 1                                    |</span><br><span class="line">| router:external           | False                                |</span><br><span class="line">| shared                    | False                                |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   |                                      |</span><br><span class="line">| tags                      |                                      |</span><br><span class="line">| tenant_id                 | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| updated_at                | 2018-07-04T09:03:55Z                 |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron subnet-create --name vpn-subnet-2 vpn-network-2 10.2.0.0/24 --gateway 10.2.0.1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new subnet:</span><br><span class="line">+-------------------+--------------------------------------------+</span><br><span class="line">| Field             | Value                                      |</span><br><span class="line">+-------------------+--------------------------------------------+</span><br><span class="line">| allocation_pools  | &#123;&quot;start&quot;: &quot;10.2.0.2&quot;, &quot;end&quot;: &quot;10.2.0.254&quot;&#125; |</span><br><span class="line">| cidr              | 10.2.0.0/24                                |</span><br><span class="line">| created_at        | 2018-07-04T09:04:39Z                       |</span><br><span class="line">| description       |                                            |</span><br><span class="line">| dns_nameservers   |                                            |</span><br><span class="line">| enable_dhcp       | True                                       |</span><br><span class="line">| gateway_ip        | 10.2.0.1                                   |</span><br><span class="line">| host_routes       |                                            |</span><br><span class="line">| id                | 4a0b78a7-3d04-4b0e-8a43-350a482c4564       |</span><br><span class="line">| ip_version        | 4                                          |</span><br><span class="line">| ipv6_address_mode |                                            |</span><br><span class="line">| ipv6_ra_mode      |                                            |</span><br><span class="line">| name              | vpn-subnet-2                               |</span><br><span class="line">| network_id        | 137d45d3-820f-409c-aac7-12ef9be66cb2       |</span><br><span class="line">| project_id        | da717c389f494c3e8e6d32f46142d610           |</span><br><span class="line">| revision_number   | 0                                          |</span><br><span class="line">| service_types     |                                            |</span><br><span class="line">| subnetpool_id     |                                            |</span><br><span class="line">| tags              |                                            |</span><br><span class="line">| tenant_id         | da717c389f494c3e8e6d32f46142d610           |</span><br><span class="line">| updated_at        | 2018-07-04T09:04:39Z                       |</span><br><span class="line">+-------------------+--------------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建router，设置网关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ neutron router-create vpn-router-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new router:</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| Field                   | Value                                |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up          | True                                 |</span><br><span class="line">| availability_zone_hints |                                      |</span><br><span class="line">| availability_zones      |                                      |</span><br><span class="line">| created_at              | 2018-07-04T09:10:49Z                 |</span><br><span class="line">| description             |                                      |</span><br><span class="line">| distributed             | False                                |</span><br><span class="line">| external_gateway_info   |                                      |</span><br><span class="line">| flavor_id               |                                      |</span><br><span class="line">| ha                      | False                                |</span><br><span class="line">| id                      | f0906c65-e9b2-447c-ad25-73fecb7fd093 |</span><br><span class="line">| name                    | vpn-router-1                         |</span><br><span class="line">| project_id              | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| revision_number         | 0                                    |</span><br><span class="line">| routes                  |                                      |</span><br><span class="line">| status                  | ACTIVE                               |</span><br><span class="line">| tags                    |                                      |</span><br><span class="line">| tenant_id               | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| updated_at              | 2018-07-04T09:10:49Z                 |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron router-interface-add vpn-router-1 vpn-subnet-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Added interface 0fbd2cfa-9e25-4ba2-a5ff-c5949d2bdd70 to router vpn-router-1.</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron router-gateway-set vpn-router-1 public</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Set gateway for router vpn-router-1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ neutron router-create vpn-router-2</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new router:</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| Field                   | Value                                |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up          | True                                 |</span><br><span class="line">| availability_zone_hints |                                      |</span><br><span class="line">| availability_zones      |                                      |</span><br><span class="line">| created_at              | 2018-07-04T09:13:56Z                 |</span><br><span class="line">| description             |                                      |</span><br><span class="line">| distributed             | False                                |</span><br><span class="line">| external_gateway_info   |                                      |</span><br><span class="line">| flavor_id               |                                      |</span><br><span class="line">| ha                      | False                                |</span><br><span class="line">| id                      | faf5fb10-8662-4862-bcb4-b3cee3c603be |</span><br><span class="line">| name                    | vpn-router-2                         |</span><br><span class="line">| project_id              | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| revision_number         | 0                                    |</span><br><span class="line">| routes                  |                                      |</span><br><span class="line">| status                  | ACTIVE                               |</span><br><span class="line">| tags                    |                                      |</span><br><span class="line">| tenant_id               | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| updated_at              | 2018-07-04T09:13:56Z                 |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron router-interface-add vpn-router-2 vpn-subnet-2</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Added interface b0d7d178-00d1-44b2-87f9-322a1f5d9a6a to router vpn-router-2.</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron router-gateway-set vpn-router-2 public</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Set gateway for router vpn-router-2</span><br><span class="line">stack@vpn-test2:~/devstack$</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><p>创建2个虚拟机实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ openstack network list</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">| ID                                   | Name          | Subnets                                                                    |</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">| 137d45d3-820f-409c-aac7-12ef9be66cb2 | vpn-network-2 | 4a0b78a7-3d04-4b0e-8a43-350a482c4564                                       |</span><br><span class="line">| 4df92675-1843-4b4b-9436-4932856ed8fe | public        | 4d801dd9-da36-4832-ad10-0be3229fea9a, 4fafa6f9-2f43-475d-95b0-5392dc3164fb |</span><br><span class="line">| 8f71bd0e-d26e-405b-8e48-68148fef8ed1 | vpn-network-1 | 840b87e2-c78c-45cb-92e7-2272ef6e0821                                       |</span><br><span class="line">| e95e8eac-c523-4066-a6fd-9ba03f7a9b20 | private       | 20516105-08ab-407a-8c8f-a16f3d2f60c0, bab7c9d8-2065-4dfc-9ff7-1973ebb4b604 |</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ openstack image list</span><br><span class="line">+--------------------------------------+--------------------------+--------+</span><br><span class="line">| ID                                   | Name                     | Status |</span><br><span class="line">+--------------------------------------+--------------------------+--------+</span><br><span class="line">| 695cf39a-6e94-46ed-9332-158da52361fc | cirros-0.3.5-x86_64-disk | active |</span><br><span class="line">+--------------------------------------+--------------------------+--------+</span><br><span class="line">stack@vpn-test2:~/devstack$ nova boot --flavor 1 --image 695cf39a-6e94-46ed-9332-158da52361fc --nic net-id=8f71bd0e-d26e-405b-8e48-68148fef8ed1 vpn-vm-1</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| Property                             | Value                                                           |</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                    | MANUAL                                                          |</span><br><span class="line">| OS-EXT-AZ:availability_zone          |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                 | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:hostname             | vpn-vm-1                                                        |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name        |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:kernel_id            |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:launch_index         | 0                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:ramdisk_id           |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:reservation_id       | r-6hmzgn8b                                                      |</span><br><span class="line">| OS-EXT-SRV-ATTR:root_device_name     | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:user_data            | -                                                               |</span><br><span class="line">| OS-EXT-STS:power_state               | 0                                                               |</span><br><span class="line">| OS-EXT-STS:task_state                | scheduling                                                      |</span><br><span class="line">| OS-EXT-STS:vm_state                  | building                                                        |</span><br><span class="line">| OS-SRV-USG:launched_at               | -                                                               |</span><br><span class="line">| OS-SRV-USG:terminated_at             | -                                                               |</span><br><span class="line">| accessIPv4                           |                                                                 |</span><br><span class="line">| accessIPv6                           |                                                                 |</span><br><span class="line">| adminPass                            | C3eFwVpuG7Su                                                    |</span><br><span class="line">| config_drive                         |                                                                 |</span><br><span class="line">| created                              | 2018-07-04T09:22:12Z                                            |</span><br><span class="line">| description                          | -                                                               |</span><br><span class="line">| flavor:disk                          | 1                                                               |</span><br><span class="line">| flavor:ephemeral                     | 0                                                               |</span><br><span class="line">| flavor:extra_specs                   | &#123;&#125;                                                              |</span><br><span class="line">| flavor:original_name                 | m1.tiny                                                         |</span><br><span class="line">| flavor:ram                           | 512                                                             |</span><br><span class="line">| flavor:swap                          | 0                                                               |</span><br><span class="line">| flavor:vcpus                         | 1                                                               |</span><br><span class="line">| hostId                               |                                                                 |</span><br><span class="line">| host_status                          |                                                                 |</span><br><span class="line">| id                                   | 70b959d7-3bc6-485a-b51c-07711b67757e                            |</span><br><span class="line">| image                                | cirros-0.3.5-x86_64-disk (695cf39a-6e94-46ed-9332-158da52361fc) |</span><br><span class="line">| key_name                             | -                                                               |</span><br><span class="line">| locked                               | False                                                           |</span><br><span class="line">| metadata                             | &#123;&#125;                                                              |</span><br><span class="line">| name                                 | vpn-vm-1                                                        |</span><br><span class="line">| os-extended-volumes:volumes_attached | []                                                              |</span><br><span class="line">| progress                             | 0                                                               |</span><br><span class="line">| security_groups                      | default                                                         |</span><br><span class="line">| status                               | BUILD                                                           |</span><br><span class="line">| tags                                 | []                                                              |</span><br><span class="line">| tenant_id                            | da717c389f494c3e8e6d32f46142d610                                |</span><br><span class="line">| updated                              | 2018-07-04T09:22:12Z                                            |</span><br><span class="line">| user_id                              | bde32ad388334927b25a5c2ff259c78d                                |</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ nova boot --flavor 1 --image 695cf39a-6e94-46ed-9332-158da52361fc --nic net-id=137d45d3-820f-409c-aac7-12ef9be66cb2 vpn-vm-2</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| Property                             | Value                                                           |</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                    | MANUAL                                                          |</span><br><span class="line">| OS-EXT-AZ:availability_zone          |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                 | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:hostname             | vpn-vm-2                                                        |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name        |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:kernel_id            |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:launch_index         | 0                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:ramdisk_id           |                                                                 |</span><br><span class="line">| OS-EXT-SRV-ATTR:reservation_id       | r-4geqbiv7                                                      |</span><br><span class="line">| OS-EXT-SRV-ATTR:root_device_name     | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:user_data            | -                                                               |</span><br><span class="line">| OS-EXT-STS:power_state               | 0                                                               |</span><br><span class="line">| OS-EXT-STS:task_state                | scheduling                                                      |</span><br><span class="line">| OS-EXT-STS:vm_state                  | building                                                        |</span><br><span class="line">| OS-SRV-USG:launched_at               | -                                                               |</span><br><span class="line">| OS-SRV-USG:terminated_at             | -                                                               |</span><br><span class="line">| accessIPv4                           |                                                                 |</span><br><span class="line">| accessIPv6                           |                                                                 |</span><br><span class="line">| adminPass                            | BtUSoUTa375w                                                    |</span><br><span class="line">| config_drive                         |                                                                 |</span><br><span class="line">| created                              | 2018-07-04T09:24:04Z                                            |</span><br><span class="line">| description                          | -                                                               |</span><br><span class="line">| flavor:disk                          | 1                                                               |</span><br><span class="line">| flavor:ephemeral                     | 0                                                               |</span><br><span class="line">| flavor:extra_specs                   | &#123;&#125;                                                              |</span><br><span class="line">| flavor:original_name                 | m1.tiny                                                         |</span><br><span class="line">| flavor:ram                           | 512                                                             |</span><br><span class="line">| flavor:swap                          | 0                                                               |</span><br><span class="line">| flavor:vcpus                         | 1                                                               |</span><br><span class="line">| hostId                               |                                                                 |</span><br><span class="line">| host_status                          |                                                                 |</span><br><span class="line">| id                                   | e8e150dd-4a98-40df-ab35-28b3a791c1be                            |</span><br><span class="line">| image                                | cirros-0.3.5-x86_64-disk (695cf39a-6e94-46ed-9332-158da52361fc) |</span><br><span class="line">| key_name                             | -                                                               |</span><br><span class="line">| locked                               | False                                                           |</span><br><span class="line">| metadata                             | &#123;&#125;                                                              |</span><br><span class="line">| name                                 | vpn-vm-2                                                        |</span><br><span class="line">| os-extended-volumes:volumes_attached | []                                                              |</span><br><span class="line">| progress                             | 0                                                               |</span><br><span class="line">| security_groups                      | default                                                         |</span><br><span class="line">| status                               | BUILD                                                           |</span><br><span class="line">| tags                                 | []                                                              |</span><br><span class="line">| tenant_id                            | da717c389f494c3e8e6d32f46142d610                                |</span><br><span class="line">| updated                              | 2018-07-04T09:24:04Z                                            |</span><br><span class="line">| user_id                              | bde32ad388334927b25a5c2ff259c78d                                |</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建ikepolicy和ipsecpolicy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ neutron vpn-ikepolicy-create ikepolicy</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ikepolicy:</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| Field                   | Value                                |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">| auth_algorithm          | sha1                                 |</span><br><span class="line">| description             |                                      |</span><br><span class="line">| encryption_algorithm    | aes-128                              |</span><br><span class="line">| id                      | 3e5ae910-757f-46d2-b2c2-cb75df0abc39 |</span><br><span class="line">| ike_version             | v1                                   |</span><br><span class="line">| lifetime                | &#123;&quot;units&quot;: &quot;seconds&quot;, &quot;value&quot;: 3600&#125;  |</span><br><span class="line">| name                    | ikepolicy                            |</span><br><span class="line">| pfs                     | group5                               |</span><br><span class="line">| phase1_negotiation_mode | main                                 |</span><br><span class="line">| project_id              | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| tenant_id               | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">+-------------------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron vpn-ipsecpolicy-create ipsecpolicy</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ipsecpolicy:</span><br><span class="line">+----------------------+--------------------------------------+</span><br><span class="line">| Field                | Value                                |</span><br><span class="line">+----------------------+--------------------------------------+</span><br><span class="line">| auth_algorithm       | sha1                                 |</span><br><span class="line">| description          |                                      |</span><br><span class="line">| encapsulation_mode   | tunnel                               |</span><br><span class="line">| encryption_algorithm | aes-128                              |</span><br><span class="line">| id                   | f7c16fe2-a0cb-4494-bcf3-a430d5699c4c |</span><br><span class="line">| lifetime             | &#123;&quot;units&quot;: &quot;seconds&quot;, &quot;value&quot;: 3600&#125;  |</span><br><span class="line">| name                 | ipsecpolicy                          |</span><br><span class="line">| pfs                  | group5                               |</span><br><span class="line">| project_id           | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| tenant_id            | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| transform_protocol   | esp                                  |</span><br><span class="line">+----------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建vpn-sercvice，其将用来后面建立site-to-site的连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ neutron vpn-service-create --name VPNA --description &quot;VPN service A&quot; vpn-router-1 vpn-subnet-1</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new vpnservice:</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">| Field          | Value                                |</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">| admin_state_up | True                                 |</span><br><span class="line">| description    | VPN service A                        |</span><br><span class="line">| external_v4_ip | 172.24.4.18                          |</span><br><span class="line">| external_v6_ip | 2001:db8::b                          |</span><br><span class="line">| flavor_id      |                                      |</span><br><span class="line">| id             | 6725564d-a056-4c62-8ea8-3dff47a8e563 |</span><br><span class="line">| name           | VPNA                                 |</span><br><span class="line">| project_id     | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| router_id      | f0906c65-e9b2-447c-ad25-73fecb7fd093 |</span><br><span class="line">| status         | PENDING_CREATE                       |</span><br><span class="line">| subnet_id      | 840b87e2-c78c-45cb-92e7-2272ef6e0821 |</span><br><span class="line">| tenant_id      | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron vpn-service-create --name VPNB --description &quot;VPN service B&quot; vpn-router-2 vpn-subnet-2</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new vpnservice:</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">| Field          | Value                                |</span><br><span class="line">+----------------+--------------------------------------+</span><br><span class="line">| admin_state_up | True                                 |</span><br><span class="line">| description    | VPN service B                        |</span><br><span class="line">| external_v4_ip | 172.24.4.19                          |</span><br><span class="line">| external_v6_ip | 2001:db8::5                          |</span><br><span class="line">| flavor_id      |                                      |</span><br><span class="line">| id             | 4f7e2da2-92eb-4e30-aa7e-94ec66928d69 |</span><br><span class="line">| name           | VPNB                                 |</span><br><span class="line">| project_id     | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| router_id      | faf5fb10-8662-4862-bcb4-b3cee3c603be |</span><br><span class="line">| status         | PENDING_CREATE                       |</span><br><span class="line">| subnet_id      | 4a0b78a7-3d04-4b0e-8a43-350a482c4564 |</span><br><span class="line">| tenant_id      | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">+----------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建ipsec-site-connection</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ neutron vpn-service-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+------+----------------------------------+--------------------------------------+----------------+</span><br><span class="line">| id                                   | name | tenant_id                        | router_id                            | status         |</span><br><span class="line">+--------------------------------------+------+----------------------------------+--------------------------------------+----------------+</span><br><span class="line">| 4f7e2da2-92eb-4e30-aa7e-94ec66928d69 | VPNB | da717c389f494c3e8e6d32f46142d610 | faf5fb10-8662-4862-bcb4-b3cee3c603be | PENDING_CREATE |</span><br><span class="line">| 6725564d-a056-4c62-8ea8-3dff47a8e563 | VPNA | da717c389f494c3e8e6d32f46142d610 | f0906c65-e9b2-447c-ad25-73fecb7fd093 | PENDING_CREATE |</span><br><span class="line">+--------------------------------------+------+----------------------------------+--------------------------------------+----------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron vpn-ikepolicy-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-----------+----------------------------------+----------------+----------------------+-------------+--------+</span><br><span class="line">| id                                   | name      | tenant_id                        | auth_algorithm | encryption_algorithm | ike_version | pfs    |</span><br><span class="line">+--------------------------------------+-----------+----------------------------------+----------------+----------------------+-------------+--------+</span><br><span class="line">| 3e5ae910-757f-46d2-b2c2-cb75df0abc39 | ikepolicy | da717c389f494c3e8e6d32f46142d610 | sha1           | aes-128              | v1          | group5 |</span><br><span class="line">+--------------------------------------+-----------+----------------------------------+----------------+----------------------+-------------+--------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron vpn-ipsecpolicy-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+----------------+----------------------+--------+</span><br><span class="line">| id                                   | name        | tenant_id                        | auth_algorithm | encryption_algorithm | pfs    |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+----------------+----------------------+--------+</span><br><span class="line">| f7c16fe2-a0cb-4494-bcf3-a430d5699c4c | ipsecpolicy | da717c389f494c3e8e6d32f46142d610 | sha1           | aes-128              | group5 |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+----------------+----------------------+--------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron ipsec-site-connection-create --name VPNConnectionA --vpnservice-id 6725564d-a056-4c62-8ea8-3dff47a8e563 --ikepolicy-id 3e5ae910-757f-46d2-b2c2-cb75df0abc39 --ipsecpolicy-id f7c16fe2-a0cb-4494-bcf3-a430d5699c4c --peer-address 172.24.4.19 --peer-id 172.24.4.19 --peer-cidr 10.2.0.0/24 --psk lizenghui</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ipsec_site_connection:</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| Field             | Value                                              |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| admin_state_up    | True                                               |</span><br><span class="line">| auth_mode         | psk                                                |</span><br><span class="line">| description       |                                                    |</span><br><span class="line">| dpd               | &#123;&quot;action&quot;: &quot;hold&quot;, &quot;interval&quot;: 30, &quot;timeout&quot;: 120&#125; |</span><br><span class="line">| id                | ce29fb78-6b5c-4e2c-8fa8-6c7a8662a14c               |</span><br><span class="line">| ikepolicy_id      | 3e5ae910-757f-46d2-b2c2-cb75df0abc39               |</span><br><span class="line">| initiator         | bi-directional                                     |</span><br><span class="line">| ipsecpolicy_id    | f7c16fe2-a0cb-4494-bcf3-a430d5699c4c               |</span><br><span class="line">| local_ep_group_id |                                                    |</span><br><span class="line">| local_id          |                                                    |</span><br><span class="line">| mtu               | 1500                                               |</span><br><span class="line">| name              | VPNConnectionA                                     |</span><br><span class="line">| peer_address      | 172.24.4.19                                        |</span><br><span class="line">| peer_cidrs        | 10.2.0.0/24                                        |</span><br><span class="line">| peer_ep_group_id  |                                                    |</span><br><span class="line">| peer_id           | 172.24.4.19                                        |</span><br><span class="line">| project_id        | da717c389f494c3e8e6d32f46142d610                   |</span><br><span class="line">| psk               | lizenghui                                          |</span><br><span class="line">| route_mode        | static                                             |</span><br><span class="line">| status            | PENDING_CREATE                                     |</span><br><span class="line">| tenant_id         | da717c389f494c3e8e6d32f46142d610                   |</span><br><span class="line">| vpnservice_id     | 6725564d-a056-4c62-8ea8-3dff47a8e563               |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron ipsec-site-connection-create --name VPNConnectionB --vpnservice-id 4f7e2da2-92eb-4e30-aa7e-94ec66928d69 --ikepolicy-id 3e5ae910-757f-46d2-b2c2-cb75df0abc39 --ipsecpolicy-id f7c16fe2-a0cb-4494-bcf3-a430d5699c4c --peer-address 172.24.4.18 --peer-id 172.24.4.18 --peer-cidr 10.1.0.0/24 --psk lizenghui</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ipsec_site_connection:</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| Field             | Value                                              |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| admin_state_up    | True                                               |</span><br><span class="line">| auth_mode         | psk                                                |</span><br><span class="line">| description       |                                                    |</span><br><span class="line">| dpd               | &#123;&quot;action&quot;: &quot;hold&quot;, &quot;interval&quot;: 30, &quot;timeout&quot;: 120&#125; |</span><br><span class="line">| id                | 033a5fe4-7505-474c-bb83-4f4f78b63e7a               |</span><br><span class="line">| ikepolicy_id      | 3e5ae910-757f-46d2-b2c2-cb75df0abc39               |</span><br><span class="line">| initiator         | bi-directional                                     |</span><br><span class="line">| ipsecpolicy_id    | f7c16fe2-a0cb-4494-bcf3-a430d5699c4c               |</span><br><span class="line">| local_ep_group_id |                                                    |</span><br><span class="line">| local_id          |                                                    |</span><br><span class="line">| mtu               | 1500                                               |</span><br><span class="line">| name              | VPNConnectionB                                     |</span><br><span class="line">| peer_address      | 172.24.4.18                                        |</span><br><span class="line">| peer_cidrs        | 10.1.0.0/24                                        |</span><br><span class="line">| peer_ep_group_id  |                                                    |</span><br><span class="line">| peer_id           | 172.24.4.18                                        |</span><br><span class="line">| project_id        | da717c389f494c3e8e6d32f46142d610                   |</span><br><span class="line">| psk               | lizenghui                                          |</span><br><span class="line">| route_mode        | static                                             |</span><br><span class="line">| status            | PENDING_CREATE                                     |</span><br><span class="line">| tenant_id         | da717c389f494c3e8e6d32f46142d610                   |</span><br><span class="line">| vpnservice_id     | 4f7e2da2-92eb-4e30-aa7e-94ec66928d69               |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看连接状态，如果立即查看status为PENDING_CREATE，则等待30~50秒后再次查看，即可看到状态变为ACTIVE。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+--------------+-----------+----------------+</span><br><span class="line">| id                                   | name           | tenant_id                        | peer_address | auth_mode | status         |</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+--------------+-----------+----------------+</span><br><span class="line">| 033a5fe4-7505-474c-bb83-4f4f78b63e7a | VPNConnectionB | da717c389f494c3e8e6d32f46142d610 | 172.24.4.18  | psk       | PENDING_CREATE |</span><br><span class="line">| ce29fb78-6b5c-4e2c-8fa8-6c7a8662a14c | VPNConnectionA | da717c389f494c3e8e6d32f46142d610 | 172.24.4.19  | psk       | PENDING_CREATE |</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+--------------+-----------+----------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| id                                   | name           | tenant_id                        | peer_address | auth_mode | status |</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| 033a5fe4-7505-474c-bb83-4f4f78b63e7a | VPNConnectionB | da717c389f494c3e8e6d32f46142d610 | 172.24.4.18  | psk       | ACTIVE |</span><br><span class="line">| ce29fb78-6b5c-4e2c-8fa8-6c7a8662a14c | VPNConnectionA | da717c389f494c3e8e6d32f46142d610 | 172.24.4.19  | psk       | ACTIVE |</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+--------------+-----------+--------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>从vpn-router-2所在的namespace，看看是否能够ping通vm-1，同样查看在vpn-router-1所在namespace是否可以ping通vm-2,发现可以相互ping通。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ nova list</span><br><span class="line">+--------------------------------------+----------+--------+------------+-------------+-------------------------+</span><br><span class="line">| ID                                   | Name     | Status | Task State | Power State | Networks                |</span><br><span class="line">+--------------------------------------+----------+--------+------------+-------------+-------------------------+</span><br><span class="line">| 70b959d7-3bc6-485a-b51c-07711b67757e | vpn-vm-1 | ACTIVE | -          | Running     | vpn-network-1=10.1.0.12 |</span><br><span class="line">| e8e150dd-4a98-40df-ab35-28b3a791c1be | vpn-vm-2 | ACTIVE | -          | Running     | vpn-network-2=10.2.0.3  |</span><br><span class="line">+--------------------------------------+----------+--------+------------+-------------+-------------------------+</span><br><span class="line">stack@vpn-test2:~/devstack$ openstack router list</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">| ID                                   | Name         | Status | State | Distributed | HA    | Project                          |</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">| bdcb18cf-4b83-47df-b0d5-b424eaeda1a6 | router1      | ACTIVE | UP    | False       | False | 9885c5369b824e81b01d0e5444f379f7 |</span><br><span class="line">| f0906c65-e9b2-447c-ad25-73fecb7fd093 | vpn-router-1 | ACTIVE | UP    | False       | False | da717c389f494c3e8e6d32f46142d610 |</span><br><span class="line">| faf5fb10-8662-4862-bcb4-b3cee3c603be | vpn-router-2 | ACTIVE | UP    | False       | False | da717c389f494c3e8e6d32f46142d610 |</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">sudo ip netns exec qrouter-faf5fb10-8662-4862-bcb4-b3cee3c603be ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">17: qr-b0d7d178-00: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/ether fa:16:3e:a5:29:f9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.2.0.1/24 brd 10.2.0.255 scope global qr-b0d7d178-00</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:fea5:29f9/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">18: qg-16b32471-b8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/ether fa:16:3e:bd:3e:f1 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.24.4.19/24 brd 172.24.4.255 scope global qg-16b32471-b8</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 2001:db8::5/64 scope global</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:febd:3ef1/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">stack@vpn-test2:~/devstack$ sudo ip netns exec qrouter-faf5fb10-8662-4862-bcb4-b3cee3c603be  ping 10.1.0.12</span><br><span class="line">PING 10.1.0.12 (10.1.0.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=1 ttl=63 time=3.20 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=2 ttl=63 time=0.812 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=3 ttl=63 time=0.648 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=4 ttl=63 time=0.722 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=5 ttl=63 time=0.801 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=6 ttl=63 time=0.657 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=7 ttl=63 time=0.760 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=8 ttl=63 time=0.633 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=9 ttl=63 time=0.612 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=10 ttl=63 time=0.635 ms</span><br><span class="line">64 bytes from 10.1.0.12: icmp_seq=11 ttl=63 time=0.697 ms</span><br><span class="line">stack@vpn-test2:~$ sudo ip netns exec qrouter-f0906c65-e9b2-447c-ad25-73fecb7fd093 ping 10.2.0.3</span><br><span class="line">PING 10.2.0.3 (10.2.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=1 ttl=63 time=5.14 ms</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=2 ttl=63 time=0.875 ms</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=3 ttl=63 time=0.973 ms</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=4 ttl=63 time=0.819 ms</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=5 ttl=63 time=0.630 ms</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=6 ttl=63 time=0.755 ms</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=7 ttl=63 time=0.643 ms</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=8 ttl=63 time=0.563 ms</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=9 ttl=63 time=0.623 ms</span><br><span class="line">64 bytes from 10.2.0.3: icmp_seq=10 ttl=63 time=0.745 ms</span><br></pre></td></tr></table></figure>
</li>
<li><p>能够Ping通，说明vpn连接已经建立，在qr，qg口抓包，确认ipsec流量，可以看到ESP加密包，下面是在路由器vpn-router-2上的qg口上的数据包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~/devstack$ sudo ip netns exec qrouter-faf5fb10-8662-4862-bcb4-b3cee3c603be tcpdump -i qg-16b32471-b8 -v</span><br><span class="line">tcpdump: listening on qg-16b32471-b8, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">19:48:00.826393 IP (tos 0x0, ttl 64, id 59316, offset 0, flags [DF], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.19 &gt; 172.24.4.18: ESP(spi=0xc3330682,seq=0x120), length 132</span><br><span class="line">19:48:00.827128 IP (tos 0x0, ttl 64, id 18957, offset 0, flags [DF], proto UDP (17), length 70)</span><br><span class="line">    172.24.4.19.59831 &gt; host-192-168-1-4.openstacklocal.domain: 65426+ PTR? 18.4.24.172.in-addr.arpa. (42)</span><br><span class="line">19:48:00.828650 IP (tos 0x0, ttl 63, id 26517, offset 0, flags [DF], proto UDP (17), length 70)</span><br><span class="line">    host-192-168-1-4.openstacklocal.domain &gt; 172.24.4.19.59831: 65426 NXDomain 0/0/0 (42)</span><br><span class="line">19:48:00.828854 IP (tos 0x0, ttl 64, id 18958, offset 0, flags [DF], proto UDP (17), length 70)</span><br><span class="line">    172.24.4.19.44962 &gt; host-192-168-1-4.openstacklocal.domain: 9844+ PTR? 19.4.24.172.in-addr.arpa. (42)</span><br><span class="line">19:48:00.828902 IP (tos 0x0, ttl 64, id 27632, offset 0, flags [none], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.18 &gt; 172.24.4.19: ESP(spi=0xc2eca09d,seq=0x120), length 132</span><br><span class="line">19:48:00.828902 IP (tos 0x0, ttl 63, id 9967, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    10.1.0.12 &gt; 10.2.0.1: ICMP echo reply, id 8568, seq 1, length 64</span><br><span class="line">19:48:00.829140 IP (tos 0x0, ttl 63, id 26518, offset 0, flags [DF], proto UDP (17), length 70)</span><br><span class="line">    host-192-168-1-4.openstacklocal.domain &gt; 172.24.4.19.44962: 9844 NXDomain 0/0/0 (42)</span><br><span class="line">19:48:00.829341 IP (tos 0x0, ttl 64, id 18959, offset 0, flags [DF], proto UDP (17), length 70)</span><br><span class="line">    172.24.4.19.59801 &gt; host-192-168-1-4.openstacklocal.domain: 17454+ PTR? 4.1.168.192.in-addr.arpa. (42)</span><br><span class="line">19:48:00.829841 IP (tos 0x0, ttl 64, id 18960, offset 0, flags [DF], proto UDP (17), length 67)</span><br><span class="line">    172.24.4.19.48978 &gt; host-192-168-1-4.openstacklocal.domain: 40542+ PTR? 1.0.2.10.in-addr.arpa. (39)</span><br><span class="line">19:48:00.830112 IP (tos 0x0, ttl 63, id 26520, offset 0, flags [DF], proto UDP (17), length 67)</span><br><span class="line">    host-192-168-1-4.openstacklocal.domain &gt; 172.24.4.19.48978: 40542 NXDomain 0/0/0 (39)</span><br><span class="line">19:48:00.830320 IP (tos 0x0, ttl 64, id 18961, offset 0, flags [DF], proto UDP (17), length 68)</span><br><span class="line">    172.24.4.19.51925 &gt; host-192-168-1-4.openstacklocal.domain: 56871+ PTR? 12.0.1.10.in-addr.arpa. (40)</span><br><span class="line">19:48:00.857281 IP (tos 0x0, ttl 63, id 26542, offset 0, flags [DF], proto UDP (17), length 103)</span><br><span class="line">    host-192-168-1-4.openstacklocal.domain &gt; 172.24.4.19.51925: 56871 NXDomain* 0/1/0 (75)</span><br><span class="line">19:48:01.828091 IP (tos 0x0, ttl 64, id 59451, offset 0, flags [DF], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.19 &gt; 172.24.4.18: ESP(spi=0xc3330682,seq=0x121), length 132</span><br><span class="line">19:48:01.828958 IP (tos 0x0, ttl 64, id 27729, offset 0, flags [none], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.18 &gt; 172.24.4.19: ESP(spi=0xc2eca09d,seq=0x121), length 132</span><br><span class="line">19:48:01.828958 IP (tos 0x0, ttl 63, id 10013, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    10.1.0.12 &gt; 10.2.0.1: ICMP echo reply, id 8568, seq 2, length 64</span><br><span class="line">19:48:02.829143 IP (tos 0x0, ttl 64, id 59462, offset 0, flags [DF], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.19 &gt; 172.24.4.18: ESP(spi=0xc3330682,seq=0x122), length 132</span><br><span class="line">19:48:02.829728 IP (tos 0x0, ttl 64, id 27978, offset 0, flags [none], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.18 &gt; 172.24.4.19: ESP(spi=0xc2eca09d,seq=0x122), length 132</span><br><span class="line">19:48:02.829728 IP (tos 0x0, ttl 63, id 10207, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    10.1.0.12 &gt; 10.2.0.1: ICMP echo reply, id 8568, seq 3, length 64</span><br><span class="line">19:48:03.829327 IP (tos 0x0, ttl 64, id 59603, offset 0, flags [DF], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.19 &gt; 172.24.4.18: ESP(spi=0xc3330682,seq=0x123), length 132</span><br><span class="line">19:48:03.830344 IP (tos 0x0, ttl 64, id 28220, offset 0, flags [none], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.18 &gt; 172.24.4.19: ESP(spi=0xc2eca09d,seq=0x123), length 132</span><br><span class="line">19:48:03.830344 IP (tos 0x0, ttl 63, id 10261, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    10.1.0.12 &gt; 10.2.0.1: ICMP echo reply, id 8568, seq 4, length 64</span><br><span class="line">19:48:04.830575 IP (tos 0x0, ttl 64, id 59761, offset 0, flags [DF], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.19 &gt; 172.24.4.18: ESP(spi=0xc3330682,seq=0x124), length 132</span><br><span class="line">19:48:04.831213 IP (tos 0x0, ttl 64, id 28233, offset 0, flags [none], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.18 &gt; 172.24.4.19: ESP(spi=0xc2eca09d,seq=0x124), length 132</span><br><span class="line">19:48:04.831213 IP (tos 0x0, ttl 63, id 10436, offset 0, flags [none], proto ICMP (1), length 84)</span><br><span class="line">    10.1.0.12 &gt; 10.2.0.1: ICMP echo reply, id 8568, seq 5, length 64</span><br><span class="line">19:48:05.829216 ARP, Ethernet (len 6), IPv4 (len 4), Request who-has 172.24.4.10 tell 172.24.4.19, length 28</span><br><span class="line">19:48:05.829479 ARP, Ethernet (len 6), IPv4 (len 4), Request who-has 172.24.4.19 tell 172.24.4.10, length 28</span><br><span class="line">19:48:05.829492 ARP, Ethernet (len 6), IPv4 (len 4), Reply 172.24.4.19 is-at fa:16:3e:bd:3e:f1 (oui Unknown), length 28</span><br><span class="line">19:48:05.829495 IP (tos 0x0, ttl 64, id 19157, offset 0, flags [DF], proto UDP (17), length 70)</span><br><span class="line">    172.24.4.19.36595 &gt; host-192-168-1-4.openstacklocal.domain: 39747+ PTR? 10.4.24.172.in-addr.arpa. (42)</span><br><span class="line">19:48:05.829570 ARP, Ethernet (len 6), IPv4 (len 4), Reply 172.24.4.10 is-at 26:8b:2c:c4:4f:48 (oui Unknown), length 28</span><br><span class="line">19:48:05.829618 IP (tos 0x0, ttl 64, id 60003, offset 0, flags [DF], proto ESP (50), length 152)</span><br><span class="line">    172.24.4.19 &gt; 172.24.4.18: ESP(spi=0xc3330682,seq=0x125), length 132</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看两个路由器的路由表信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ sudo ip netns exec qrouter-f0906c65-e9b2-447c-ad25-73fecb7fd093 ip route list</span><br><span class="line">default via 172.24.4.10 dev qg-472d97a3-80</span><br><span class="line">10.1.0.0/24 dev qr-0fbd2cfa-9e  proto kernel  scope link  src 10.1.0.1</span><br><span class="line">172.24.4.0/24 dev qg-472d97a3-80  proto kernel  scope link  src 172.24.4.18</span><br><span class="line">stack@vpn-test2:~$ sudo ip netns exec qrouter-faf5fb10-8662-4862-bcb4-b3cee3c603be ip route list</span><br><span class="line">default via 172.24.4.10 dev qg-16b32471-b8</span><br><span class="line">10.2.0.0/24 dev qr-b0d7d178-00  proto kernel  scope link  src 10.2.0.1</span><br><span class="line">172.24.4.0/24 dev qg-16b32471-b8  proto kernel  scope link  src 172.24.4.19</span><br></pre></td></tr></table></figure>
</li>
<li><p>删掉vpn服务连接实例后，看看路由表变动情况以及还能否ping通，发现不能ping通了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron vpn-service-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+------+----------------------------------+--------------------------------------+--------+</span><br><span class="line">| id                                   | name | tenant_id                        | router_id                            | status |</span><br><span class="line">+--------------------------------------+------+----------------------------------+--------------------------------------+--------+</span><br><span class="line">| 4f7e2da2-92eb-4e30-aa7e-94ec66928d69 | VPNB | da717c389f494c3e8e6d32f46142d610 | faf5fb10-8662-4862-bcb4-b3cee3c603be | ACTIVE |</span><br><span class="line">| 6725564d-a056-4c62-8ea8-3dff47a8e563 | VPNA | da717c389f494c3e8e6d32f46142d610 | f0906c65-e9b2-447c-ad25-73fecb7fd093 | ACTIVE |</span><br><span class="line">+--------------------------------------+------+----------------------------------+--------------------------------------+--------+</span><br><span class="line">stack@vpn-test2:~$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| id                                   | name           | tenant_id                        | peer_address | auth_mode | status |</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| 033a5fe4-7505-474c-bb83-4f4f78b63e7a | VPNConnectionB | da717c389f494c3e8e6d32f46142d610 | 172.24.4.18  | psk       | ACTIVE |</span><br><span class="line">| ce29fb78-6b5c-4e2c-8fa8-6c7a8662a14c | VPNConnectionA | da717c389f494c3e8e6d32f46142d610 | 172.24.4.19  | psk       | ACTIVE |</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">stack@vpn-test2:~$ neutron ipsec-site-connection-delete ce29fb78-6b5c-4e2c-8fa8-6c7a8662a14c</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Deleted ipsec_site_connection(s): ce29fb78-6b5c-4e2c-8fa8-6c7a8662a14c</span><br><span class="line">stack@vpn-test2:~$ sudo ip netns exec qrouter-f0906c65-e9b2-447c-ad25-73fecb7fd093 ping 10.2.0.3</span><br><span class="line">PING 10.2.0.3 (10.2.0.3) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 10.2.0.3 ping statistics ---</span><br><span class="line">376 packets transmitted, 0 received, 100% packet loss, time 375175ms</span><br><span class="line">stack@vpn-test2:~$ sudo ip netns exec qrouter-faf5fb10-8662-4862-bcb4-b3cee3c603be  ping 10.1.0.12</span><br><span class="line">PING 10.1.0.12 (10.1.0.12) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 10.1.0.12 ping statistics ---</span><br><span class="line">15 packets transmitted, 0 received, 100% packet loss, time 14077ms</span><br><span class="line">stack@vpn-test2:~$ sudo ip netns exec qrouter-faf5fb10-8662-4862-bcb4-b3cee3c603be ip route list</span><br><span class="line">default via 172.24.4.10 dev qg-16b32471-b8</span><br><span class="line">10.2.0.0/24 dev qr-b0d7d178-00  proto kernel  scope link  src 10.2.0.1</span><br><span class="line">172.24.4.0/24 dev qg-16b32471-b8  proto kernel  scope link  src 172.24.4.19</span><br><span class="line">stack@vpn-test2:~$ sudo ip netns exec qrouter-f0906c65-e9b2-447c-ad25-73fecb7fd093 ip route list</span><br><span class="line">default via 172.24.4.10 dev qg-472d97a3-80</span><br><span class="line">10.1.0.0/24 dev qr-0fbd2cfa-9e  proto kernel  scope link  src 10.1.0.1</span><br><span class="line">172.24.4.0/24 dev qg-472d97a3-80  proto kernel  scope link  src 172.24.4.18</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>至此，vpnaas的基本功能验证完成。</p>
<h5 id="Endpoint-group功能测试"><a href="#Endpoint-group功能测试" class="headerlink" title="*! Endpoint group功能测试"></a>*! Endpoint group功能测试</h5><h6 id="测试方案-2"><a href="#测试方案-2" class="headerlink" title="测试方案"></a>测试方案</h6><p>环境还是ALL-IN-ONE单节点Openstack，四不同的vm（vm1~vm2），vm1,vm2属于network-1下的不同子网，vm3，vm4属于network-2下面的不同子网。各自连接的路由器上创建VPN服务，分别创建endpoint-group，需要将两个router的出口网关设为同一网段。</p>
<p>具体步骤：</p>
<ol>
<li>为四个vm创建对应的network和所在子网</li>
<li>创建router，并设置出口网关在同一段external网络，即”public”</li>
<li>各自network下创建vm，固定v4-ip，分别属于不同子网下面，并创建ikepolicy，ipsecpolicy，和vpn-service和endpoint group</li>
<li>创建和删除ipsec-site-connection后，测试四个vm之间的连通性</li>
</ol>
<p>网络拓扑:<br><img src="https://raw.githubusercontent.com/Sirius21c/sirius21c.github.io/master/images/Neutron-VPNaaS/endpoint_group%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91.png" alt="endpoint_group测试拓扑"></p>
<h6 id="测试步骤"><a href="#测试步骤" class="headerlink" title="测试步骤"></a>测试步骤</h6><ol>
<li><p>创建用于测试endpoint group的network和子网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron net-create eg-network-1</span><br><span class="line">stack@vpn-test2:~$ neutron net-create eg-network-2</span><br><span class="line">stack@vpn-test2:~$ neutron subnet-create --name eg-subnet-1 eg-network-1 10.3.0.0/24</span><br><span class="line">stack@vpn-test2:~$ neutron subnet-create --name eg-subnet-2 eg-network-1 10.4.0.0/24</span><br><span class="line">stack@vpn-test2:~$ neutron subnet-create --name eg-subnet-3 eg-network-2 10.5.0.0/24</span><br><span class="line">stack@vpn-test2:~$ neutron subnet-create --name eg-subnet-4 eg-network-2 10.6.0.0/24</span><br><span class="line">stack@vpn-test2:~$ openstack network list</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">| ID                                   | Name          | Subnets                                                                    |</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">| 137d45d3-820f-409c-aac7-12ef9be66cb2 | vpn-network-2 | 4a0b78a7-3d04-4b0e-8a43-350a482c4564                                       |</span><br><span class="line">| 274a1424-ccce-47c6-ad32-a092c51574a6 | eg-network-2  | 2a6799f1-2436-43f0-8dae-3b838bbb5167, 792a2075-fcf0-4622-a509-620f708bc316 |</span><br><span class="line">| 307b1ddf-36bc-4ace-a055-0bfe97f0da9d | eg-network-1  | 111c98b0-effc-4760-a270-f4003ca98ad2, 9584d7e3-8a93-49fb-8f8f-73d44c94d19d |</span><br><span class="line">| 4df92675-1843-4b4b-9436-4932856ed8fe | public        | 4d801dd9-da36-4832-ad10-0be3229fea9a, 4fafa6f9-2f43-475d-95b0-5392dc3164fb |</span><br><span class="line">| 8f71bd0e-d26e-405b-8e48-68148fef8ed1 | vpn-network-1 | 840b87e2-c78c-45cb-92e7-2272ef6e0821                                       |</span><br><span class="line">| e95e8eac-c523-4066-a6fd-9ba03f7a9b20 | private       | 20516105-08ab-407a-8c8f-a16f3d2f60c0, bab7c9d8-2065-4dfc-9ff7-1973ebb4b604 |</span><br><span class="line">+--------------------------------------+---------------+----------------------------------------------------------------------------+</span><br><span class="line">stack@vpn-test2:~$ openstack subnet list</span><br><span class="line">+--------------------------------------+---------------------+--------------------------------------+---------------------+</span><br><span class="line">| ID                                   | Name                | Network                              | Subnet              |</span><br><span class="line">+--------------------------------------+---------------------+--------------------------------------+---------------------+</span><br><span class="line">| 111c98b0-effc-4760-a270-f4003ca98ad2 | eg-subnet-1         | 307b1ddf-36bc-4ace-a055-0bfe97f0da9d | 10.3.0.0/24         |</span><br><span class="line">| 20516105-08ab-407a-8c8f-a16f3d2f60c0 | ipv6-private-subnet | e95e8eac-c523-4066-a6fd-9ba03f7a9b20 | fd60:9aee:5b2f::/64 |</span><br><span class="line">| 2a6799f1-2436-43f0-8dae-3b838bbb5167 | eg-subnet-3         | 274a1424-ccce-47c6-ad32-a092c51574a6 | 10.5.0.0/24         |</span><br><span class="line">| 4a0b78a7-3d04-4b0e-8a43-350a482c4564 | vpn-subnet-2        | 137d45d3-820f-409c-aac7-12ef9be66cb2 | 10.2.0.0/24         |</span><br><span class="line">| 4d801dd9-da36-4832-ad10-0be3229fea9a | ipv6-public-subnet  | 4df92675-1843-4b4b-9436-4932856ed8fe | 2001:db8::/64       |</span><br><span class="line">| 4fafa6f9-2f43-475d-95b0-5392dc3164fb | public-subnet       | 4df92675-1843-4b4b-9436-4932856ed8fe | 172.24.4.0/24       |</span><br><span class="line">| 792a2075-fcf0-4622-a509-620f708bc316 | eg-subnet-4         | 274a1424-ccce-47c6-ad32-a092c51574a6 | 10.6.0.0/24         |</span><br><span class="line">| 840b87e2-c78c-45cb-92e7-2272ef6e0821 | vpn-subnet-1        | 8f71bd0e-d26e-405b-8e48-68148fef8ed1 | 10.1.0.0/24         |</span><br><span class="line">| 9584d7e3-8a93-49fb-8f8f-73d44c94d19d | eg-subnet-2         | 307b1ddf-36bc-4ace-a055-0bfe97f0da9d | 10.4.0.0/24         |</span><br><span class="line">| bab7c9d8-2065-4dfc-9ff7-1973ebb4b604 | privateA            | e95e8eac-c523-4066-a6fd-9ba03f7a9b20 | 10.0.0.0/26         |</span><br><span class="line">+--------------------------------------+---------------------+--------------------------------------+---------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建两个eg-router，并连接对应子网，设置对外网关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron router-create eg-router-1</span><br><span class="line">stack@vpn-test2:~$ neutron router-create eg-router-2</span><br><span class="line">stack@vpn-test2:~$ neutron router-interface-add eg-router-1 eg-subnet-1</span><br><span class="line">stack@vpn-test2:~$ neutron router-interface-add eg-router-1 eg-subnet-2</span><br><span class="line">stack@vpn-test2:~$ neutron router-interface-add eg-router-2 eg-subnet-3</span><br><span class="line">stack@vpn-test2:~$ neutron router-interface-add eg-router-2 eg-subnet-4</span><br><span class="line">stack@vpn-test2:~$ neutron router-gateway-set eg-router-1 public</span><br><span class="line">Set gateway for router eg-router-1</span><br><span class="line">stack@vpn-test2:~$ neutron router-gateway-set eg-router-2 public</span><br><span class="line">Set gateway for router eg-router-2</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建虚机eg-vm-1~eg-vm-4</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ nova boot --flavor 1 --image cirros-0.3.5-x86_64-disk --nic net-id=307b1ddf-36bc-4ace-a055-0bfe97f0da9d,v4-fixed-ip=10.3.0.3 eg-vm-1</span><br><span class="line">stack@vpn-test2:~$ nova boot --flavor 1 --image cirros-0.3.5-x86_64-disk --nic net-id=307b1ddf-36bc-4ace-a055-0bfe97f0da9d,v4-fixed-ip=10.4.0.4 eg-vm-2</span><br><span class="line">stack@vpn-test2:~$ nova boot --flavor 1 --image cirros-0.3.5-x86_64-disk --nic net-id=274a1424-ccce-47c6-ad32-a092c51574a6,v4-fixed-ip=10.5.0.5 eg-vm-3</span><br><span class="line">stack@vpn-test2:~$ nova boot --flavor 1 --image cirros-0.3.5-x86_64-disk --nic net-id=274a1424-ccce-47c6-ad32-a092c51574a6,v4-fixed-ip=10.6.0.6 eg-vm-4</span><br><span class="line">stack@vpn-test2:~$ nova list</span><br><span class="line">+--------------------------------------+----------+--------+------------+-------------+-------------------------+</span><br><span class="line">| ID                                   | Name     | Status | Task State | Power State | Networks                |</span><br><span class="line">+--------------------------------------+----------+--------+------------+-------------+-------------------------+</span><br><span class="line">| c6c3a388-fe16-424a-8a68-0899b7578977 | eg-vm-1  | ACTIVE | -          | Running     | eg-network-1=10.3.0.3   |</span><br><span class="line">| 2dd3e32c-49f5-4db9-9271-a880eb7c6806 | eg-vm-2  | ACTIVE | -          | Running     | eg-network-1=10.4.0.4   |</span><br><span class="line">| f5040c29-2904-4318-879f-05ce51940c37 | eg-vm-3  | ACTIVE | -          | Running     | eg-network-2=10.5.0.5   |</span><br><span class="line">| 384c7696-a673-4039-b2aa-363199327c92 | eg-vm-4  | ACTIVE | -          | Running     | eg-network-2=10.6.0.6   |</span><br><span class="line">| 70b959d7-3bc6-485a-b51c-07711b67757e | vpn-vm-1 | ACTIVE | -          | Running     | vpn-network-1=10.1.0.12 |</span><br><span class="line">| e8e150dd-4a98-40df-ab35-28b3a791c1be | vpn-vm-2 | ACTIVE | -          | Running     | vpn-network-2=10.2.0.3  |</span><br><span class="line">+--------------------------------------+----------+--------+------------+-------------+-------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建用于测试endpoint group的ikepolicy，ipsecpolicy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron vpn-ikepolicy-create eg-ikepolicy</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-ipsecpolicy-create eg-ipsecpolicy</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-ikepolicy-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+--------------+----------------------------------+----------------+----------------------+-------------+--------+</span><br><span class="line">| id                                   | name         | tenant_id                        | auth_algorithm | encryption_algorithm | ike_version | pfs    |</span><br><span class="line">+--------------------------------------+--------------+----------------------------------+----------------+----------------------+-------------+--------+</span><br><span class="line">| 74796b9d-3695-4759-a0bc-bd0c6bdb8c9f | ikepolicy    | da717c389f494c3e8e6d32f46142d610 | sha1           | aes-128              | v1          | group5 |</span><br><span class="line">| 85c27997-ab43-4782-815b-b4de285ae74a | eg-ikepolicy | da717c389f494c3e8e6d32f46142d610 | sha1           | aes-128              | v1          | group5 |</span><br><span class="line">+--------------------------------------+--------------+----------------------------------+----------------+----------------------+-------------+--------+</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-ipsecpolicy-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+----------------+----------------------+--------+</span><br><span class="line">| id                                   | name           | tenant_id                        | auth_algorithm | encryption_algorithm | pfs    |</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+----------------+----------------------+--------+</span><br><span class="line">| 35305802-8e52-4983-adab-946a58e44c91 | eg-ipsecpolicy | da717c389f494c3e8e6d32f46142d610 | sha1           | aes-128              | group5 |</span><br><span class="line">| f7c16fe2-a0cb-4494-bcf3-a430d5699c4c | ipsecpolicy    | da717c389f494c3e8e6d32f46142d610 | sha1           | aes-128              | group5 |</span><br><span class="line">+--------------------------------------+----------------+----------------------------------+----------------+----------------------+--------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建vpn-service和endpoint-group。<br><strong><em>注意：</em></strong>此时创建vpn-service时，不指定子网，只指定路由器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">neutron vpn-service-create --name eg-VPNA eg-router-1</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-endpoint-group-create --name eg-locals --type subnet --value eg-subnet-1 --value eg-subnet-2</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new endpoint_group:</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">| Field       | Value                                |</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">| description |                                      |</span><br><span class="line">| endpoints   | 111c98b0-effc-4760-a270-f4003ca98ad2 |</span><br><span class="line">|             | 9584d7e3-8a93-49fb-8f8f-73d44c94d19d |</span><br><span class="line">| id          | 9827c31e-4255-41de-91e7-eeefa73db311 |</span><br><span class="line">| name        | eg-locals                            |</span><br><span class="line">| project_id  | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| tenant_id   | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| type        | subnet                               |</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-endpoint-group-create --name eg-peers --type cidr --value 10.5.0.0/24 --value 10.6.0.0/24</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new endpoint_group:</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">| Field       | Value                                |</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">| description |                                      |</span><br><span class="line">| endpoints   | 10.5.0.0/24                          |</span><br><span class="line">|             | 10.6.0.0/24                          |</span><br><span class="line">| id          | df0e8f64-5e03-49c8-ae5a-1ec9f62cf563 |</span><br><span class="line">| name        | eg-peers                             |</span><br><span class="line">| project_id  | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| tenant_id   | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| type        | cidr                                 |</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-service-create --name eg-VPNB eg-router-2</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-endpoint-group-create --name eg-locals-2 --type subnet --value eg-subnet-3 --value eg-subnet-4</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new endpoint_group:</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">| Field       | Value                                |</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">| description |                                      |</span><br><span class="line">| endpoints   | 2a6799f1-2436-43f0-8dae-3b838bbb5167 |</span><br><span class="line">|             | 792a2075-fcf0-4622-a509-620f708bc316 |</span><br><span class="line">| id          | 0fd07dbc-bf75-4b55-88a1-56cc072e437d |</span><br><span class="line">| name        | eg-locals-2                          |</span><br><span class="line">| project_id  | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| tenant_id   | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| type        | subnet                               |</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-endpoint-group-create --name eg-peers-2 --type cidr --value 10.3.0.0/24 --value 10.4.0.0/24</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new endpoint_group:</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">| Field       | Value                                |</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">| description |                                      |</span><br><span class="line">| endpoints   | 10.3.0.0/24                          |</span><br><span class="line">|             | 10.4.0.0/24                          |</span><br><span class="line">| id          | b6448c42-a274-4475-b335-4987cddfdba5 |</span><br><span class="line">| name        | eg-peers-2                           |</span><br><span class="line">| project_id  | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| tenant_id   | da717c389f494c3e8e6d32f46142d610     |</span><br><span class="line">| type        | cidr                                 |</span><br><span class="line">+-------------+--------------------------------------+</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-endpoint-group-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------+------------------------------------------------------------------------------------+</span><br><span class="line">| id                                   | name        | tenant_id                        | type   | endpoints                                                                          |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------+------------------------------------------------------------------------------------+</span><br><span class="line">| 0fd07dbc-bf75-4b55-88a1-56cc072e437d | eg-locals-2 | da717c389f494c3e8e6d32f46142d610 | subnet | [u&apos;2a6799f1-2436-43f0-8dae-3b838bbb5167&apos;, u&apos;792a2075-fcf0-4622-a509-620f708bc316&apos;] |</span><br><span class="line">| 9827c31e-4255-41de-91e7-eeefa73db311 | eg-locals   | da717c389f494c3e8e6d32f46142d610 | subnet | [u&apos;111c98b0-effc-4760-a270-f4003ca98ad2&apos;, u&apos;9584d7e3-8a93-49fb-8f8f-73d44c94d19d&apos;] |</span><br><span class="line">| b6448c42-a274-4475-b335-4987cddfdba5 | eg-peers-2  | da717c389f494c3e8e6d32f46142d610 | cidr   | [u&apos;10.3.0.0/24&apos;, u&apos;10.4.0.0/24&apos;]                                                   |</span><br><span class="line">| df0e8f64-5e03-49c8-ae5a-1ec9f62cf563 | eg-peers    | da717c389f494c3e8e6d32f46142d610 | cidr   | [u&apos;10.5.0.0/24&apos;, u&apos;10.6.0.0/24&apos;]                                                   |</span><br><span class="line">+--------------------------------------+-------------+----------------------------------+--------+------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建ipsec-site-connection，等待30到50秒后查看vpn-service和ipsec-site-connection的状态，状态为ACTIVE，说明功能正常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron ipsec-site-connection-create --name eg-vpnconnection1 --vpnservice-id e64a8cac-3b3e-46c0-9154-69b42b162d36 --ikepolicy-id 85c27997-ab43-4782-815b-b4de285ae74a --ipsecpolicy-id 35305802-8e52-4983-adab-946a58e44c91 --peer-address 172.24.4.17 --peer-id 172.24.4.17 --local-ep-group eg-locals --peer-ep-group eg-peers --psk lizenghui</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ipsec_site_connection:</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| Field             | Value                                              |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| admin_state_up    | True                                               |</span><br><span class="line">| auth_mode         | psk                                                |</span><br><span class="line">| description       |                                                    |</span><br><span class="line">| dpd               | &#123;&quot;action&quot;: &quot;hold&quot;, &quot;interval&quot;: 30, &quot;timeout&quot;: 120&#125; |</span><br><span class="line">| id                | 34fd710c-c989-453c-ab30-43e35300ec76               |</span><br><span class="line">| ikepolicy_id      | 85c27997-ab43-4782-815b-b4de285ae74a               |</span><br><span class="line">| initiator         | bi-directional                                     |</span><br><span class="line">| ipsecpolicy_id    | 35305802-8e52-4983-adab-946a58e44c91               |</span><br><span class="line">| local_ep_group_id | 9827c31e-4255-41de-91e7-eeefa73db311               |</span><br><span class="line">| local_id          |                                                    |</span><br><span class="line">| mtu               | 1500                                               |</span><br><span class="line">| name              | eg-vpnconnection1                                  |</span><br><span class="line">| peer_address      | 172.24.4.17                                        |</span><br><span class="line">| peer_cidrs        |                                                    |</span><br><span class="line">| peer_ep_group_id  | df0e8f64-5e03-49c8-ae5a-1ec9f62cf563               |</span><br><span class="line">| peer_id           | 172.24.4.17                                        |</span><br><span class="line">| project_id        | da717c389f494c3e8e6d32f46142d610                   |</span><br><span class="line">| psk               | lizenghui                                          |</span><br><span class="line">| route_mode        | static                                             |</span><br><span class="line">| status            | PENDING_CREATE                                     |</span><br><span class="line">| tenant_id         | da717c389f494c3e8e6d32f46142d610                   |</span><br><span class="line">| vpnservice_id     | e64a8cac-3b3e-46c0-9154-69b42b162d36               |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">stack@vpn-test2:~$ neutron ipsec-site-connection-create --name eg-vpnconnection2 --vpnservice-id f883f3f5-66be-414a-b90f-32f84aa77655 --ikepolicy-id 85c27997-ab43-4782-815b-b4de285ae74a --ipsecpolicy-id 35305802-8e52-4983-adab-946a58e44c91 --peer-address 172.24.4.15 --peer-id 172.24.4.15 --local-ep-group eg-locals-2 --peer-ep-group eg-peers-2 --psk lizenghui</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Created a new ipsec_site_connection:</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| Field             | Value                                              |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">| admin_state_up    | True                                               |</span><br><span class="line">| auth_mode         | psk                                                |</span><br><span class="line">| description       |                                                    |</span><br><span class="line">| dpd               | &#123;&quot;action&quot;: &quot;hold&quot;, &quot;interval&quot;: 30, &quot;timeout&quot;: 120&#125; |</span><br><span class="line">| id                | 429e0919-6e80-457e-a8d7-6f28f2d0df77               |</span><br><span class="line">| ikepolicy_id      | 85c27997-ab43-4782-815b-b4de285ae74a               |</span><br><span class="line">| initiator         | bi-directional                                     |</span><br><span class="line">| ipsecpolicy_id    | 35305802-8e52-4983-adab-946a58e44c91               |</span><br><span class="line">| local_ep_group_id | 0fd07dbc-bf75-4b55-88a1-56cc072e437d               |</span><br><span class="line">| local_id          |                                                    |</span><br><span class="line">| mtu               | 1500                                               |</span><br><span class="line">| name              | eg-vpnconnection2                                  |</span><br><span class="line">| peer_address      | 172.24.4.15                                        |</span><br><span class="line">| peer_cidrs        |                                                    |</span><br><span class="line">| peer_ep_group_id  | b6448c42-a274-4475-b335-4987cddfdba5               |</span><br><span class="line">| peer_id           | 172.24.4.15                                        |</span><br><span class="line">| project_id        | da717c389f494c3e8e6d32f46142d610                   |</span><br><span class="line">| psk               | lizenghui                                          |</span><br><span class="line">| route_mode        | static                                             |</span><br><span class="line">| status            | PENDING_CREATE                                     |</span><br><span class="line">| tenant_id         | da717c389f494c3e8e6d32f46142d610                   |</span><br><span class="line">| vpnservice_id     | f883f3f5-66be-414a-b90f-32f84aa77655               |</span><br><span class="line">+-------------------+----------------------------------------------------+</span><br><span class="line">stack@vpn-test2:~$ neutron vpn-service-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+---------+----------------------------------+--------------------------------------+----------------+</span><br><span class="line">| id                                   | name    | tenant_id                        | router_id                            | status         |</span><br><span class="line">+--------------------------------------+---------+----------------------------------+--------------------------------------+----------------+</span><br><span class="line">| 4f7e2da2-92eb-4e30-aa7e-94ec66928d69 | VPNB    | da717c389f494c3e8e6d32f46142d610 | faf5fb10-8662-4862-bcb4-b3cee3c603be | ACTIVE         |</span><br><span class="line">| aff9287d-22dd-43d9-b707-afd6257ac70e | VPNA    | da717c389f494c3e8e6d32f46142d610 | f0906c65-e9b2-447c-ad25-73fecb7fd093 | PENDING_CREATE |</span><br><span class="line">| e64a8cac-3b3e-46c0-9154-69b42b162d36 | eg-VPNA | da717c389f494c3e8e6d32f46142d610 | 704fcac7-57d3-4fca-a21e-1b838a440f2d | ACTIVE         |</span><br><span class="line">| f883f3f5-66be-414a-b90f-32f84aa77655 | eg-VPNB | da717c389f494c3e8e6d32f46142d610 | d8a62641-a84f-4d3d-a48f-ead48d85e701 | ACTIVE         |</span><br><span class="line">+--------------------------------------+---------+----------------------------------+--------------------------------------+----------------+</span><br><span class="line">stack@vpn-test2:~$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-------------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| id                                   | name              | tenant_id                        | peer_address | auth_mode | status |</span><br><span class="line">+--------------------------------------+-------------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| 34fd710c-c989-453c-ab30-43e35300ec76 | eg-vpnconnection1 | da717c389f494c3e8e6d32f46142d610 | 172.24.4.17  | psk       | ACTIVE |</span><br><span class="line">| 429e0919-6e80-457e-a8d7-6f28f2d0df77 | eg-vpnconnection2 | da717c389f494c3e8e6d32f46142d610 | 172.24.4.15  | psk       | ACTIVE |</span><br><span class="line">+--------------------------------------+-------------------+----------------------------------+--------------+-----------+--------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>登陆到创建的vm，验证vm1，vm2，vm3，vm4之间的连通性，发现它们之间是互相通的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ nova list</span><br><span class="line">+--------------------------------------+----------+--------+------------+-------------+-------------------------+</span><br><span class="line">| ID                                   | Name     | Status | Task State | Power State | Networks                |</span><br><span class="line">+--------------------------------------+----------+--------+------------+-------------+-------------------------+</span><br><span class="line">| c6c3a388-fe16-424a-8a68-0899b7578977 | eg-vm-1  | ACTIVE | -          | Running     | eg-network-1=10.3.0.3   |</span><br><span class="line">| 2dd3e32c-49f5-4db9-9271-a880eb7c6806 | eg-vm-2  | ACTIVE | -          | Running     | eg-network-1=10.4.0.4   |</span><br><span class="line">| f5040c29-2904-4318-879f-05ce51940c37 | eg-vm-3  | ACTIVE | -          | Running     | eg-network-2=10.5.0.5   |</span><br><span class="line">| 384c7696-a673-4039-b2aa-363199327c92 | eg-vm-4  | ACTIVE | -          | Running     | eg-network-2=10.6.0.6   |</span><br><span class="line">| 70b959d7-3bc6-485a-b51c-07711b67757e | vpn-vm-1 | ACTIVE | -          | Running     | vpn-network-1=10.1.0.12 |</span><br><span class="line">| e8e150dd-4a98-40df-ab35-28b3a791c1be | vpn-vm-2 | ACTIVE | -          | Running     | vpn-network-2=10.2.0.3  |</span><br><span class="line">+--------------------------------------+----------+--------+------------+-------------+-------------------------+</span><br><span class="line">stack@vpn-test2:~$ openstack router list</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">| ID                                   | Name         | Status | State | Distributed | HA    | Project                          |</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">| 704fcac7-57d3-4fca-a21e-1b838a440f2d | eg-router-1  | ACTIVE | UP    | False       | False | da717c389f494c3e8e6d32f46142d610 |</span><br><span class="line">| bdcb18cf-4b83-47df-b0d5-b424eaeda1a6 | router1      | ACTIVE | UP    | False       | False | 9885c5369b824e81b01d0e5444f379f7 |</span><br><span class="line">| d8a62641-a84f-4d3d-a48f-ead48d85e701 | eg-router-2  | ACTIVE | UP    | False       | False | da717c389f494c3e8e6d32f46142d610 |</span><br><span class="line">| f0906c65-e9b2-447c-ad25-73fecb7fd093 | vpn-router-1 | ACTIVE | UP    | False       | False | da717c389f494c3e8e6d32f46142d610 |</span><br><span class="line">| faf5fb10-8662-4862-bcb4-b3cee3c603be | vpn-router-2 | ACTIVE | UP    | False       | False | da717c389f494c3e8e6d32f46142d610 |</span><br><span class="line">+--------------------------------------+--------------+--------+-------+-------------+-------+----------------------------------+</span><br><span class="line">stack@vpn-test2:~$ sudo ip netns exec qrouter-704fcac7-57d3-4fca-a21e-1b838a440f2d ssh cirros@10.3.0.3</span><br><span class="line">cirros@10.3.0.3&apos;s password:</span><br><span class="line">Permission denied, please try again.</span><br><span class="line">cirros@10.3.0.3&apos;s password:</span><br><span class="line">$ ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc pfifo_fast qlen 1000</span><br><span class="line">    link/ether fa:16:3e:9a:10:1c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.3.0.3/24 brd 10.3.0.255 scope global eth0</span><br><span class="line">    inet6 fe80::f816:3eff:fe9a:101c/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">$ ping 10.5.0.5</span><br><span class="line">PING 10.5.0.5 (10.5.0.5): 56 data bytes</span><br><span class="line">64 bytes from 10.5.0.5: seq=0 ttl=62 time=5.781 ms</span><br><span class="line">64 bytes from 10.5.0.5: seq=1 ttl=62 time=1.803 ms</span><br><span class="line">64 bytes from 10.5.0.5: seq=2 ttl=62 time=1.809 ms</span><br><span class="line">64 bytes from 10.5.0.5: seq=3 ttl=62 time=1.707 ms</span><br><span class="line">64 bytes from 10.5.0.5: seq=4 ttl=62 time=1.300 ms</span><br><span class="line">64 bytes from 10.5.0.5: seq=5 ttl=62 time=1.342 ms</span><br><span class="line">64 bytes from 10.5.0.5: seq=6 ttl=62 time=1.263 ms</span><br><span class="line">64 bytes from 10.5.0.5: seq=7 ttl=62 time=1.409 ms</span><br><span class="line">64 bytes from 10.5.0.5: seq=8 ttl=62 time=1.356 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.5.0.5 ping statistics ---</span><br><span class="line">9 packets transmitted, 9 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 1.263/1.974/5.781 ms</span><br><span class="line">$ ping 10.6.0.6</span><br><span class="line">PING 10.6.0.6 (10.6.0.6): 56 data bytes</span><br><span class="line">64 bytes from 10.6.0.6: seq=0 ttl=62 time=6.258 ms</span><br><span class="line">64 bytes from 10.6.0.6: seq=1 ttl=62 time=2.096 ms</span><br><span class="line">64 bytes from 10.6.0.6: seq=2 ttl=62 time=1.644 ms</span><br><span class="line">64 bytes from 10.6.0.6: seq=3 ttl=62 time=1.441 ms</span><br><span class="line">64 bytes from 10.6.0.6: seq=4 ttl=62 time=1.516 ms</span><br><span class="line">64 bytes from 10.6.0.6: seq=5 ttl=62 time=1.546 ms</span><br><span class="line">64 bytes from 10.6.0.6: seq=6 ttl=62 time=2.268 ms</span><br><span class="line">64 bytes from 10.6.0.6: seq=7 ttl=62 time=2.222 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.6.0.6 ping statistics ---</span><br><span class="line">8 packets transmitted, 8 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 1.441/2.373/6.258 ms</span><br><span class="line">$ ping 10.4.0.4</span><br><span class="line">PING 10.4.0.4 (10.4.0.4): 56 data bytes</span><br><span class="line">64 bytes from 10.4.0.4: seq=0 ttl=63 time=10.127 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=1 ttl=63 time=1.999 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=2 ttl=63 time=1.438 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=3 ttl=63 time=1.125 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=4 ttl=63 time=1.217 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=5 ttl=63 time=1.245 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=6 ttl=63 time=1.202 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=7 ttl=63 time=1.120 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.4.0.4 ping statistics ---</span><br><span class="line">8 packets transmitted, 8 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 1.120/2.434/10.127 ms</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除ipsec-site-connection连接，另一个ipsec-site-connection连接down掉。再测试连通性，发现vm1与eg-network-2下面的vm3、vm4已无法ping通，而与vm2能ping通。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-------------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| id                                   | name              | tenant_id                        | peer_address | auth_mode | status |</span><br><span class="line">+--------------------------------------+-------------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| 34fd710c-c989-453c-ab30-43e35300ec76 | eg-vpnconnection1 | da717c389f494c3e8e6d32f46142d610 | 172.24.4.17  | psk       | ACTIVE |</span><br><span class="line">| 429e0919-6e80-457e-a8d7-6f28f2d0df77 | eg-vpnconnection2 | da717c389f494c3e8e6d32f46142d610 | 172.24.4.15  | psk       | ACTIVE |</span><br><span class="line">+--------------------------------------+-------------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">stack@vpn-test2:~$ neutron ipsec-site-connection-delete 34fd710c-c989-453c-ab30-43e35300ec76</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">Deleted ipsec_site_connection(s): 34fd710c-c989-453c-ab30-43e35300ec76</span><br><span class="line">stack@vpn-test2:~$ neutron ipsec-site-connection-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+-------------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| id                                   | name              | tenant_id                        | peer_address | auth_mode | status |</span><br><span class="line">+--------------------------------------+-------------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">| 429e0919-6e80-457e-a8d7-6f28f2d0df77 | eg-vpnconnection2 | da717c389f494c3e8e6d32f46142d610 | 172.24.4.15  | psk       | DOWN   |</span><br><span class="line">+--------------------------------------+-------------------+----------------------------------+--------------+-----------+--------+</span><br><span class="line">stack@vpn-test2:~$ sudo ip netns exec qrouter-704fcac7-57d3-4fca-a21e-1b838a440f2d ssh cirros@10.3.0.3</span><br><span class="line">cirros@10.3.0.3&apos;s password:</span><br><span class="line">$ ping 10.5.0.5</span><br><span class="line">PING 10.5.0.5 (10.5.0.5): 56 data bytes</span><br><span class="line">^C</span><br><span class="line">--- 10.5.0.5 ping statistics ---</span><br><span class="line">10 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line">$ ping 10.6.0.6</span><br><span class="line">PING 10.6.0.6 (10.6.0.6): 56 data bytes</span><br><span class="line">^C</span><br><span class="line">--- 10.6.0.6 ping statistics ---</span><br><span class="line">6 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line">$ ping 10.4.0.4</span><br><span class="line">PING 10.4.0.4 (10.4.0.4): 56 data bytes</span><br><span class="line">64 bytes from 10.4.0.4: seq=0 ttl=63 time=4.499 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=1 ttl=63 time=1.958 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=2 ttl=63 time=1.169 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=3 ttl=63 time=1.189 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=4 ttl=63 time=1.290 ms</span><br><span class="line">64 bytes from 10.4.0.4: seq=5 ttl=63 time=1.231 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.4.0.4 ping statistics ---</span><br><span class="line">6 packets transmitted, 6 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 1.169/1.889/4.499 ms</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="结果与分析"><a href="#结果与分析" class="headerlink" title="结果与分析"></a>结果与分析</h5><ul>
<li><p>查看agent，没有单独的neutron-vpn-agent，说明现在L3 agent起了vpn agent的作用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron agent-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+--------------------+-----------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| id                                   | agent_type         | host      | availability_zone | alive | admin_state_up | binary                    |</span><br><span class="line">+--------------------------------------+--------------------+-----------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| 4aaf04b5-a843-4af1-9c75-c5169d9c24a9 | Metadata agent     | vpn-test2 |                   | :-)   | True           | neutron-metadata-agent    |</span><br><span class="line">| 79de8e88-b5e2-458d-9fd1-f94b19b91524 | DHCP agent         | vpn-test2 | nova              | :-)   | True           | neutron-dhcp-agent        |</span><br><span class="line">| be88d7e9-44d9-41b3-8da2-29943df76fa6 | Open vSwitch agent | vpn-test2 |                   | :-)   | True           | neutron-openvswitch-agent |</span><br><span class="line">| dc1ee8b1-2a0c-4da7-b096-c54f7b0e071a | L3 agent           | vpn-test2 | nova              | :-)   | True           | neutron-l3-agent          |</span><br><span class="line">+--------------------------------------+--------------------+-----------+-------------------+-------+----------------+---------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看ipsec driver，dvr和ha都未启用，支持VPN功能实现的ipsec_driver为strongswan。关于HA router对VPNaaS功能的影响还有待进一步测试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron service-provider-list</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">+---------------+-------------+---------+</span><br><span class="line">| service_type  | name        | default |</span><br><span class="line">+---------------+-------------+---------+</span><br><span class="line">| L3_ROUTER_NAT | single_node | False   |</span><br><span class="line">| L3_ROUTER_NAT | ha          | False   |</span><br><span class="line">| L3_ROUTER_NAT | dvrha       | False   |</span><br><span class="line">| VPN           | strongswan  | True    |</span><br><span class="line">| L3_ROUTER_NAT | dvr         | False   |</span><br><span class="line">| VPN           | strongswan  | True    |</span><br><span class="line">+---------------+-------------+---------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>当前版本支持传统的指定子网CIDR的vpn连接方式，也支持建立endpoint group的多个本地子网的方式，并且后者是现在和以后推荐使用的。</p>
</li>
<li>Ubuntu系统支持strongswan类型的ipsec_driver，CentOS系统不支持。</li>
<li><p>当ipsec-site-connection一旦建立起来后，其连接所有用到的资源（ikepolicy，ipsecpolicy，subnet，endpoint group等）都不能被删除或更新。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stack@vpn-test2:~$ neutron vpn-ikepolicy-delete 85c27997-ab43-4782-815b-b4de285ae74a</span><br><span class="line">neutron CLI is deprecated and will be removed in the future. Use openstack CLI instead.</span><br><span class="line">IKEPolicy 85c27997-ab43-4782-815b-b4de285ae74a is in use by existing IPsecSiteConnection and can&apos;t be updated or deleted</span><br><span class="line">Neutron server returns request_ids: [&apos;req-afe0c4a0-0775-452a-a4dd-535274456373&apos;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>建立endpoint group时指定type时，后面的value必须一致，要么都为subnet，要么都为cidr。</p>
</li>
<li>建立ipsec-site-connection连接时双方psk值必须一致匹配。</li>
</ul>
</div><div class="tags"><a href="/tags/openstack/">openstack</a><a href="/tags/neutron/">neutron</a><a href="/tags/VPNaaS/">VPNaaS</a></div><div class="post-nav"><a class="pre" href="/2018/08/07/TripleO-QuickStart网络实现简述/">TripleO-QuickStart网络实现简述</a><a class="next" href="/2018/07/03/Octavia调研/">Octavia调研</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'cf6cbb233152befba374',
  clientSecret: 'd1d9b814b36163460ad6241843c4d1be861fe7db',
  repo: 'BlogComments',
  owner: 'sirius21c',
  admin: ['sirius21c'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://21cc.me"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/emotion/">emotion</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technology/">technology</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Happy-Birthday/" style="font-size: 15px;">Happy Birthday</a> <a href="/tags/随笔/" style="font-size: 17px;">随笔</a> <a href="/tags/calico/" style="font-size: 15px;">calico</a> <a href="/tags/k8s/" style="font-size: 17px;">k8s</a> <a href="/tags/openstack/" style="font-size: 25px;">openstack</a> <a href="/tags/network/" style="font-size: 21px;">network</a> <a href="/tags/travel/" style="font-size: 15px;">travel</a> <a href="/tags/neutron/" style="font-size: 23px;">neutron</a> <a href="/tags/octavia/" style="font-size: 15px;">octavia</a> <a href="/tags/openflow/" style="font-size: 17px;">openflow</a> <a href="/tags/sfc/" style="font-size: 15px;">sfc</a> <a href="/tags/ovs/" style="font-size: 19px;">ovs</a> <a href="/tags/devstack/" style="font-size: 15px;">devstack</a> <a href="/tags/tripleo/" style="font-size: 15px;">tripleo</a> <a href="/tags/linux-bridge/" style="font-size: 15px;">linux bridge</a> <a href="/tags/firewall对接/" style="font-size: 19px;">firewall对接</a> <a href="/tags/security/" style="font-size: 17px;">security</a> <a href="/tags/note/" style="font-size: 15px;">note</a> <a href="/tags/poetry/" style="font-size: 15px;">poetry</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/kvm/" style="font-size: 15px;">kvm</a> <a href="/tags/SR-IOV/" style="font-size: 15px;">SR-IOV</a> <a href="/tags/边缘计算/" style="font-size: 15px;">边缘计算</a> <a href="/tags/5G/" style="font-size: 15px;">5G</a> <a href="/tags/VPNaaS/" style="font-size: 15px;">VPNaaS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/02/11/CentaraGrand/">CentaraGrand</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/19/虚拟网络优化与测试/">虚拟网络优化与测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/03/Distributed-Virtual-Routing/">Distributed Virtual Routing</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/边缘计算：5G的命喉/">边缘计算：5G的命喉</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/OpenFlow：Neutron走上歧路的原罪/">OpenFlow：Neutron走上歧路的原罪</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/14/深入浅出容器网络/">深入浅出容器网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/04/成都本科落户流程指北/">成都本科落户流程指北</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/11/未选择的路/">未选择的路</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/Calico-Research/">Calico Research</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/16/neutron-pbr-spec/">Neutron Policy-based Routing Spec</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Sirius21c's Docs.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.6" zindex="-1" count="60" src="https://lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>