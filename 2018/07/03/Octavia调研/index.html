<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Octavia调研 | Sirius21c's Docs</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Octavia调研</h1><a id="logo" href="/.">Sirius21c's Docs</a><p class="description">一位不爱写文档的码农的自我救赎之路</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Octavia调研</h1><div class="post-meta">Jul 3, 2018<span> | </span><span class="category"><a href="/categories/technology/">technology</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行使用流程"><span class="toc-number">2.</span> <span class="toc-text">命令行使用流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#涉及资源及概念"><span class="toc-number">3.</span> <span class="toc-text">涉及资源及概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#loadbalancer"><span class="toc-number">3.1.</span> <span class="toc-text">loadbalancer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#listener"><span class="toc-number">3.2.</span> <span class="toc-text">listener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pool"><span class="toc-number">3.3.</span> <span class="toc-text">pool</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#member"><span class="toc-number">3.4.</span> <span class="toc-text">member</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#health-monitor"><span class="toc-number">3.5.</span> <span class="toc-text">health-monitor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#health-manager"><span class="toc-number">3.6.</span> <span class="toc-text">health-manager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#amphora-agent"><span class="toc-number">3.7.</span> <span class="toc-text">amphora-agent</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#amphora-镜像制作"><span class="toc-number">4.</span> <span class="toc-text">amphora 镜像制作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dib"><span class="toc-number">4.1.</span> <span class="toc-text">dib</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#octavia"><span class="toc-number">4.2.</span> <span class="toc-text">octavia</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Octavia与Neutron的关系"><span class="toc-number">5.</span> <span class="toc-text">Octavia与Neutron的关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#逻辑架构图"><span class="toc-number">6.</span> <span class="toc-text">逻辑架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考连接"><span class="toc-number">7.</span> <span class="toc-text">参考连接</span></a></li></ol></div></div><div class="post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Octavia 是一款开放源码的运营商级负载平衡解决方案，旨在与 OpenStack 配合使用。<br>Octavia 之前由 Neutron LBaaS 项目承担，影响了Neutron LBaaS项目的转型，Neutron LBaaS 从版本1转为版本2。从OpenStack的Liberty发行版开始，Octavia 成为Neutron LBaaS第2版的参考实现。从 Pike 版本开始，Octavia 就可以作为独立的Keystone服务而不再是 Neutron 的一个 service plugin，同时，CLI 命令也作为 openstack 命令行的一部分，而不是通过 neutron 调用。<br>Octavia通过管理一组虚拟机，容器或裸机（通常称为amphora）来完成其负载均衡服务的交付。 这种按需、横向扩展特性将Octavia与其他负载平衡解决方案区分开来，从而使Octavia真正适合“云”。<br>说白了，就是将用户的API请求经过逻辑处理，转换成haproxy和keepalived的配置参数，下发到amphorae虚拟机中。</p>
<h3 id="命令行使用流程"><a href="#命令行使用流程" class="headerlink" title="命令行使用流程"></a>命令行使用流程</h3><p>如下几个命令创建一个 loadbalancer，一个 listener 一个 pool，同时添加两个 member。</p>
<ul>
<li><p>neutron CLI</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">neutron lbaas-loadbalancer-create --name lb1 private-subnet</span><br><span class="line">neutron lbaas-listener-create --loadbalancer lb1 --protocol HTTP --protocol-port 80 --name listener1</span><br><span class="line">neutron lbaas-pool-create --lb-algorithm ROUND_ROBIN --listener listener1 --protocol HTTP --name pool1</span><br><span class="line">neutron lbaas-member-create  --subnet private-subnet --address $&#123;IP1&#125; --protocol-port 80 pool1</span><br><span class="line">neutron lbaas-member-create  --subnet private-subnet --address $&#123;IP2&#125; --protocol-port 80 pool1</span><br></pre></td></tr></table></figure>
</li>
<li><p>openstack CLI</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack loadbalancer create --name test_1 --vip-subnet-id f2492f6d-abe8-4600-9620-ea0b30e0f04c</span><br><span class="line">openstack loadbalancer listener create --name test_1 --protocol HTTP --protocol-port 80 a32dfcac-3f65-454d-acb1-fc038434b0ed</span><br><span class="line">openstack loadbalancer pool create --name test_pool_1 --protocol HTTP --listener 7a14d263-d19f-49c6-b7ac-35dc74f95e7e --lb-algorithm ROUND_ROBIN</span><br><span class="line">openstack loadbalancer member create --name member_1 --address 10.0.0.14 --subnet-id f2492f6d-abe8-4600-9620-ea0b30e0f04c --protocol-port 80 1922e4a8-3538-43ff-9489-7cb3b35e6bb0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="涉及资源及概念"><a href="#涉及资源及概念" class="headerlink" title="涉及资源及概念"></a>涉及资源及概念</h3><h4 id="loadbalancer"><a href="#loadbalancer" class="headerlink" title="loadbalancer"></a>loadbalancer</h4><p>octavia 的实现就是由 amphora 镜像起来的虚拟机实例，即创建 loadbalancer 就是创建 amphora 虚机。</p>
<p><strong>目前支持 single 和 active-standby 两种模式，社区正在开发 active-active 模式，（Queens）暂不支持。active-standby 模式如果配置enable_anti_affinity，则会针对这个 lb 先在Nova创建ServerGroup（这个ServerGroup的ID会记录在DB中），两个虚拟机就会创建在不同的host上。</strong></p>
<p><strong><em> 实现功能的 haproxy 和 keepalived 是在虚机的 amphora namespace 中。网络拓扑实现并没有使用 Linux bridge 或者 OVS 实现，而是由 namespace 独占一个网卡资源（一般是 eth1，用于 vrrp ，eth1:0 用于 vip），即 eth0 属于虚拟机主体，映射 neutron 中管理 lb 网络（lb-mgmt-net）的 port ，而 namespace 直接映射租户 vip 需求的 subnet。</em></strong></p>
<h4 id="listener"><a href="#listener" class="headerlink" title="listener"></a>listener</h4><p>监听器即一个不断在端口上检查连接请求的进程，一旦发现客户端的连接请求，则会按照你设定的规则将连接请求转发给后端的服务器池。一个监听器关联一个端口，如：HTTP(80)、HTTPS（443），当使用HTTPS，则需要上传用于https 加密和解密的证书到监听器中。</p>
<p>即虚拟机里面的一个 haproxy 进程，frontend 配置。</p>
<p>*<em>支持 L7 Policy</em></p>
<h4 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h4><p>服务器池即后端一组提供服务的实例，每个成员都是一个IP地址+4层的端口。<br>octavia 实现为 haproxy 配置中的一个 backend。</p>
<h4 id="member"><a href="#member" class="headerlink" title="member"></a>member</h4><p>backend 配置中的一个 member，即真正承载内容的后端服务器。</p>
<h4 id="health-monitor"><a href="#health-monitor" class="headerlink" title="health-monitor"></a>health-monitor</h4><p>健康检测的机制是指是负载均衡器通过定期的心跳信号检测服务器池中的服务器运行状态，从而排除掉后端故障的主机，保证服务整体正常。</p>
<p>支持的健康检测方式包括 ICMP、TCP、HTTP几种。</p>
<ul>
<li>ICMP是最简单的，通过ping 和echo的方式，看根据服务器是否响应。只要服务器操作系统TCP/IP协议栈运行正常，网卡不出问题，服务器到负载均衡之间的网络正常，ICMP的方式都起到良好的作用，但以上情况都不能代表服务器上面运行的应用是正常的。</li>
<li>TCP是4层的检测方式，相比ICMP、TCP会请求主机的特定端口，看特定的端口能否正常响应。</li>
<li>HTTP的方式则更进一筹，会通过get特定的页面，根据HTTP的返回代码来判断应用是否正常。</li>
</ul>
<p>健康监测的指标越精确，越能反映服务的实际响应情况，如果是web服务，最好是使用HTTP的方式，这样检测结果更可信。</p>
<h4 id="health-manager"><a href="#health-manager" class="headerlink" title="health-manager"></a>health-manager</h4><p>检查虚拟机状态，和虚拟机中的octavia agent通信，来更新各个组件的状态。<br><strong><em>注意和 health-monitor 监控对象的不同。</em></strong></p>
<h4 id="amphora-agent"><a href="#amphora-agent" class="headerlink" title="amphora-agent"></a>amphora-agent</h4><p>位于虚拟机内部，对下是接受指令操作下层的 haproxy 软件，对上是和 health-manager 通信汇报各种情况。</p>
<h3 id="amphora-镜像制作"><a href="#amphora-镜像制作" class="headerlink" title="amphora 镜像制作"></a>amphora 镜像制作</h3><p>在 部署完 octavia 真正运行服务之前，最重要的一个工作就是准备镜像。这个镜像是用来创建 amphorae service 虚拟机。<br>octavia repo 中提供了创建 haproxy 镜像的脚本可以直接使用：</p>
<blockquote>
<p>$ ./diskimage-create/diskimage-create.sh</p>
</blockquote>
<p>目前直接使用 octavia 的代码来制作镜像会出现问题，另外因为在 centos 上以 ubuntu 为 base 制作镜像会出现包验证和权限的问题，所以将 base 改为 centos。<br>需要以下修改，涉及两方面的代码： <strong><em> dib  octavia </em></strong></p>
<h4 id="dib"><a href="#dib" class="headerlink" title="dib"></a>dib</h4><p>octv ia 需要使用 pypi（element）更换 pip 源，因此需要将 pypi 指的源变更为国内源</p>
<ul>
<li>(方式一)  export DIB_PYPI_MIRROR_URL (测试时未生效)</li>
<li>(方式二)  pre-install.d/00-configure-pypi-mirror:46: indices.append(‘<a href="https://pypi.python.org/simple&#39;" target="_blank" rel="noopener">https://pypi.python.org/simple&#39;</a>)</li>
</ul>
<h4 id="octavia"><a href="#octavia" class="headerlink" title="octavia"></a>octavia</h4><ul>
<li>首先需要引入 pypi，可以使用 export DIB_LOCAL_ELEMENTS</li>
<li>接着将默认 base 改为 centos，或者使用 octvia 脚本中预留的 -i 参数</li>
<li>最后修改一处代码：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@@ -12,9 +12,9 @@ AMP_VENV=/opt/amphora-agent-venv</span><br><span class="line"># Create a virtual environment to contain the amphora agent</span><br><span class="line">$&#123;DIB_PYTHON&#125; -m virtualenv $AMP_VENV</span><br><span class="line"></span><br><span class="line">+$AMP_VENV/bin/pip install --upgrade pbr</span><br><span class="line"></span><br><span class="line"># Link the amphora-agent out to /usr/local/bin where the startup scripts look</span><br><span class="line">ln -s $AMP_VENV/bin/amphora-agent /usr/local/bin/amphora-agent || true</span><br></pre></td></tr></table></figure>
<h3 id="Octavia与Neutron的关系"><a href="#Octavia与Neutron的关系" class="headerlink" title="Octavia与Neutron的关系"></a>Octavia与Neutron的关系</h3><ul>
<li><p>Before Pike</p>
<blockquote>
<p>lbaas v1: This is the original Neutron LBaaS, and what you see in Horizon or in the neutron CLI as “lb-*”. It has an haproxy backend, and a few vendors supporting it. Feature-wise, it’s basically a byte pump.</p>
</blockquote>
<blockquote>
<p>lbaas v2: This is the “new” Neutron LBaaS, and is in the neutron CLI as “lbaas-*” (it’s not yet in Horizon.) It first shipped in Kilo. It re-organizes the objects, and adds TLS termination support, and has L7 plus other new goodies planned in Liberty. It similarly has an haproxy reference backend with a few vendors supporting it.</p>
</blockquote>
<blockquote>
<p>octavia: Think of this as a service vm framework that is specific to lbaas, to implement lbaas via nova VMs instead of “lbaas agents”. It is expected to be the reference backend implementation for neutron lbaasv2 in liberty. It could also be used as its own front-end, and/or given drivers to be a load balancing framework completely outside neutron/nova, though that is not the present direction of development.</p>
</blockquote>
</li>
<li><p>After Pike<br>从 Pike 版本开始，octavia 可以作为一个独立服务部署而不依赖于 neutron，neutron 对于 octavia 开说只是下层的一个服务而已。所以，也就不会有两份数据库记录，不用担心数据不一致的问题。</p>
</li>
</ul>
<h3 id="逻辑架构图"><a href="#逻辑架构图" class="headerlink" title="逻辑架构图"></a>逻辑架构图</h3><p><img src="/images/Octavia调研/逻辑架构图.png" alt="逻辑架构图"></p>
<h3 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h3><p><a href="https://docs.openstack.org/octavia/latest/" target="_blank" rel="noopener">https://docs.openstack.org/octavia/latest/</a><br><a href="https://lingxiankong.github.io/2017-09-13-octavia.html" target="_blank" rel="noopener">https://lingxiankong.github.io/2017-09-13-octavia.html</a><br><a href="https://www.cnblogs.com/pmyewei/p/7376921.html" target="_blank" rel="noopener">https://www.cnblogs.com/pmyewei/p/7376921.html</a><br><a href="http://www.cnblogs.com/sammyliu/p/4656176.html" target="_blank" rel="noopener">http://www.cnblogs.com/sammyliu/p/4656176.html</a></p>
</div><div class="tags"><a href="/tags/openstack/">openstack</a><a href="/tags/neutron/">neutron</a><a href="/tags/octavia/">octavia</a></div><div class="post-nav"><a class="pre" href="/2018/07/09/Neutron-VPNaaS/">Neutron-VPNaaS</a><a class="next" href="/2018/06/14/ServiceFunctionChaining/">Service Function Chaining</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'cf6cbb233152befba374',
  clientSecret: 'd1d9b814b36163460ad6241843c4d1be861fe7db',
  repo: 'BlogComments',
  owner: 'sirius21c',
  admin: ['sirius21c'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://21cc.me"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/emotion/">emotion</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technology/">technology</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Happy-Birthday/" style="font-size: 15px;">Happy Birthday</a> <a href="/tags/随笔/" style="font-size: 17px;">随笔</a> <a href="/tags/calico/" style="font-size: 15px;">calico</a> <a href="/tags/k8s/" style="font-size: 17px;">k8s</a> <a href="/tags/openstack/" style="font-size: 25px;">openstack</a> <a href="/tags/network/" style="font-size: 21px;">network</a> <a href="/tags/travel/" style="font-size: 15px;">travel</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/tool/" style="font-size: 15px;">tool</a> <a href="/tags/neutron/" style="font-size: 23px;">neutron</a> <a href="/tags/note/" style="font-size: 17px;">note</a> <a href="/tags/cloud/" style="font-size: 17px;">cloud</a> <a href="/tags/openflow/" style="font-size: 17px;">openflow</a> <a href="/tags/octavia/" style="font-size: 15px;">octavia</a> <a href="/tags/tripleo/" style="font-size: 15px;">tripleo</a> <a href="/tags/ovs/" style="font-size: 19px;">ovs</a> <a href="/tags/linux-bridge/" style="font-size: 15px;">linux bridge</a> <a href="/tags/devstack/" style="font-size: 15px;">devstack</a> <a href="/tags/firewall对接/" style="font-size: 19px;">firewall对接</a> <a href="/tags/security/" style="font-size: 17px;">security</a> <a href="/tags/sfc/" style="font-size: 15px;">sfc</a> <a href="/tags/sdn/" style="font-size: 15px;">sdn</a> <a href="/tags/poetry/" style="font-size: 15px;">poetry</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/kvm/" style="font-size: 15px;">kvm</a> <a href="/tags/SR-IOV/" style="font-size: 15px;">SR-IOV</a> <a href="/tags/边缘计算/" style="font-size: 15px;">边缘计算</a> <a href="/tags/5G/" style="font-size: 15px;">5G</a> <a href="/tags/VPNaaS/" style="font-size: 15px;">VPNaaS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/15/所爱隔山海，山海难平——浅谈SDN/">深入浅出容器网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/02/Mac使用zmodem传输文件/">Mac使用zmodem传输文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/06/PrivateNote-BCloudNet/">PrivateNote_BCloudNet</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/11/CentaraGrand/">CentaraGrand</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/19/虚拟网络优化与测试/">虚拟网络优化与测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/03/Distributed-Virtual-Routing/">Distributed Virtual Routing</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/边缘计算：5G的命喉/">边缘计算：5G的命喉</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/OpenFlow：Neutron走上歧路的原罪/">OpenFlow：Neutron走上歧路的原罪</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/14/深入浅出容器网络/">深入浅出容器网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/04/成都本科落户流程指北/">成都本科落户流程指北</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Sirius21c's Docs.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.6" zindex="-1" count="55" src="//lib.baomitu.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>