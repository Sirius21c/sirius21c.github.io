<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>openstack中引入firewall镜像方案概述 | Sirius21c's Docs</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">openstack中引入firewall镜像方案概述</h1><a id="logo" href="/.">Sirius21c's Docs</a><p class="description">一位不爱写文档的码农的自我救赎之路</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">openstack中引入firewall镜像方案概述</h1><div class="post-meta">May 20, 2018<span> | </span><span class="category"><a href="/categories/technology/">technology</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案概述"><span class="toc-number">2.</span> <span class="toc-text">方案概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#透明部署"><span class="toc-number">2.1.</span> <span class="toc-text">透明部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#L3部署"><span class="toc-number">2.2.</span> <span class="toc-text">L3部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#租户网络内部L3部署——旁挂引流回注（目前采用的方案）"><span class="toc-number">2.2.1.</span> <span class="toc-text">租户网络内部L3部署——旁挂引流回注（目前采用的方案）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#租户网络内部L3部署——替代qrouter"><span class="toc-number">2.2.2.</span> <span class="toc-text">租户网络内部L3部署——替代qrouter</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#provider-网络-L3-部署"><span class="toc-number">2.2.3.</span> <span class="toc-text">provider 网络 L3 部署</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>随着云计算的发展，安全方面得到越来越多的重视，但云安全这块领域应该才算刚起步，目前各个传统安全厂商将各自的安全产品云化也只是将镜像抠出来部署进云环境，然后使用传统的处理方式将流量引入安全设备进行处理。<br>本文主要讲述如何将 firewall 镜像引入 openstack 平台进行使用，firewall 以 360 镜像为例。</p>
<h3 id="方案概述"><a href="#方案概述" class="headerlink" title="方案概述"></a>方案概述</h3><h4 id="透明部署"><a href="#透明部署" class="headerlink" title="透明部署"></a>透明部署</h4><p>透明模式，顾名思义，采用无IP方式运行，用户将不必重新设定和修改路由，防火墙就可以直接安装和放置到网络中使用，如交换机一样不需要设置IP地址。<br>透明模式的防火墙就好像是一台网桥(非透明的防火墙好像一台路由器)，网络设备(包括主机、路由器、工作站等)和所有计算机的设置(包括IP地址和网关)无须改变。但是，防火墙透明模式与网桥存在不同，防火墙接收到的IP报文还需要（解析所有通过它的数据包）送到上层进行相关过滤等处理，通过检查会话表或ACL规则以确定是否允许该报文通过；此外，还要完成其它防攻击检查。透明模式的防火墙支持ACL规则检查、ASPF状态过滤、防攻击检查、流量监控等功能。因此既增加了网络的安全性，又降低了用户管理的复杂程度。<br>当防火墙工作在透明模式（也可以称为桥接模式）下时，所有接口都不能配置IP地址，接口所在的安全区域是二层区域，和二层区域相关接口连接的外部用户同属一个子网。当报文在二层区域的接口间进行转发时，需要根据报文的MAC地址来寻找出接口，此时防火墙表现为一个透明网桥。<br>工作在透明模式下的防火墙在数据链路层连接局域网（LAN），网络终端用户无需为连接网络而对设备进行特别配置，就像使用以太网交换机一样进行网络连接，避免了改变拓扑结构造成的麻烦。<br>那在openstack环境中，该模式下的 firewall 该如何引入呢？可以将 firewall 镜像实例直接起在租户网络上，通过 networking-sfc 来强制将流量导入导出虚拟机，示例图如下：</p>
<p><img src="https://sirius21c-1256566528.cos.ap-beijing.myqcloud.com/openstack/neutron/firewal%E5%AF%B9%E6%8E%A5-%E9%80%8F%E6%98%8E%E9%83%A8%E7%BD%B2.png" alt="firewall对接-透明模式"></p>
<p>如图所示，在 networking-sfc 中，流量的转发不经过传统 neutron 的转发规则限制，而是强制定向从某个虚拟机端口到达另一个虚拟机端口，这样的好处在于将所有的流量强制定向到防火墙进行安全审计，缺点如下：</p>
<ul>
<li>不适宜扩展，因为对于每一个虚机会单独生成一个 neutron port 绑定。</li>
<li>对于每一个用户虚机的创建，租户必须手动（或者集成 networking-sfc 以及 firewall 操作）创建 firewall 规则。</li>
</ul>
<p>因此不建议使用这种透明部署方案。</p>
<h4 id="L3部署"><a href="#L3部署" class="headerlink" title="L3部署"></a>L3部署</h4><p>对租户而言，看到的有两种网络，project 网络（即租户网络）和 provide 网络。<br>project 网络是用户按需提供（self-provisioned and on-demand），provide 网络一般来说是管理员预定义的网络来提供外部连通性。因此租户一般不单独操作外部网络提供的借口（加入/离开）以外的资源。以下提供三种方案：</p>
<h5 id="租户网络内部L3部署——旁挂引流回注（目前采用的方案）"><a href="#租户网络内部L3部署——旁挂引流回注（目前采用的方案）" class="headerlink" title="租户网络内部L3部署——旁挂引流回注（目前采用的方案）"></a>租户网络内部L3部署——旁挂引流回注（目前采用的方案）</h5><p>使用类似于“物理旁挂，逻辑串联”的方式旁挂在 qrouter 旁。<br>根据用户的需求，是否使用PBR将流量引入FW，需要则在qrouter的namespace写入iptables策略，不需要则删掉策略。<br>拓扑如下图所示：</p>
<p><img src="https://sirius21c-1256566528.cos.ap-beijing.myqcloud.com/openstack/neutron/firewall%E5%AF%B9%E6%8E%A5--%E7%A7%9F%E6%88%B7%E7%BD%91%E7%BB%9C%E9%83%A8%E7%BD%B2%E4%B9%8B%E6%97%81%E6%8C%82%E5%BC%95%E6%B5%81%E5%9B%9E%E6%B3%A8.png" alt="租户网络内部L3部署——旁挂引流回注"></p>
<p>该方式简单易行，只将 firewall 作为一个类似于feature 的实现，可以灵活的加载与卸载，当然切换中会有一定时间段的丢包。<br>开发则需要复用 neutron-server 的代码提供出自己的 API ，再写一个 plugin 调用 drive 向 namespace 写入和删除规则即可。</p>
<h5 id="租户网络内部L3部署——替代qrouter"><a href="#租户网络内部L3部署——替代qrouter" class="headerlink" title="租户网络内部L3部署——替代qrouter"></a>租户网络内部L3部署——替代qrouter</h5><p>这是一种租户自己利用 firewall 功能实现 neutron l3 转发的功能，部署示例如下所示：</p>
<p><img src="https://sirius21c-1256566528.cos.ap-beijing.myqcloud.com/openstack/neutron/%E7%A7%9F%E6%88%B7%E7%BD%91%E7%BB%9C%E5%86%85%E9%83%A8L3%E9%83%A8%E7%BD%B2%E2%80%94%E6%9B%BF%E4%BB%A3qrouter.png" alt="租户网络内部L3部署——替代qrouter"></p>
<p>如上图所示，假设给定的租户网络 192.168.1.0/24 ，其中网关为 192.168.1.1 ，在创建网络的时候不再创建 l3 neutron router 。将创建一个 192.168.1.1 的 neutron port ，和从 provider 网络中创建一个 neutron port 作为外部接口。接下来将两个端口附加到 firewall 实例上，至此完成 l3 部署的网络拓扑，然后租户对 firewall 进行配置完后 l3 功能。</p>
<p>这样做存在以下限制：</p>
<ul>
<li>tripleo部署的环境不允许在 public 网络里建立虚机，且需要手动使用建立 neutron port，再使用 nova attach 上去。</li>
<li>完全摒弃了neutron L3 的部署，以及诸如 L3 HA 等很多 features 。</li>
<li>防火墙必须对租户授权。</li>
</ul>
<h5 id="provider-网络-L3-部署"><a href="#provider-网络-L3-部署" class="headerlink" title="provider 网络 L3 部署"></a>provider 网络 L3 部署</h5><p>这种部署方案下，我们认为 firewall 服务属于管理员资源，部署拓扑参考如下：</p>
<p><img src="https://sirius21c-1256566528.cos.ap-beijing.myqcloud.com/openstack/neutron/provider%20%E7%BD%91%E7%BB%9C%20L3%20%E9%83%A8%E7%BD%B2.png" alt="provider 网络 L3 部署"></p>
<p>如上图所示，在租户网络外建立一个建的（fake）provider 来对租户网络提供带有 firewall 网络的 provider network ，对租户网络而言，所看到的 provider 网络就是这个假的 provider 网络。Firewall 实例由管理员部署，这样，租户网络保留原来的网络功能，防火墙所看到的是虚拟机 nat 地址和 floating-ip 地址，因此，防火墙需要正确的将这些地址映射到外部网络。<br>这种部署方案的最大好处在于保留租户网络原有的 L3 功能，provider 网络来提供防火墙的功能。<br>PS：这个假的 provider 网络同样也可以使用真实的 provider，流量同样要到 firewall 走一遍，但这种情形下的优点是 nat 可以解决 1:1 nat  和 1:n nat 功能的部署复杂性，防火墙能直接将 floating-ip 和 vm fixed-ip 来进行映射，使用 fake provider 则不可行，只能使用 1:n 的snat 。</p>
</div><div class="tags"><a href="/tags/openstack/">openstack</a><a href="/tags/neutron/">neutron</a><a href="/tags/firewall对接/">firewall对接</a></div><div class="post-nav"><a class="pre" href="/2018/05/20/openstack中引入firewall镜像——租户网络旁挂引流回注/">openstack中引入firewall镜像——租户网络旁挂引流回注</a><a class="next" href="/2018/05/09/uos和csmp对接方案概述/">uos和csmp对接方案概述</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'cf6cbb233152befba374',
  clientSecret: 'd1d9b814b36163460ad6241843c4d1be861fe7db',
  repo: 'BlogComments',
  owner: 'sirius21c',
  admin: ['sirius21c'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://21cc.me"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/emotion/">emotion</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technology/">technology</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Happy-Birthday/" style="font-size: 15px;">Happy Birthday</a> <a href="/tags/随笔/" style="font-size: 17px;">随笔</a> <a href="/tags/calico/" style="font-size: 15px;">calico</a> <a href="/tags/k8s/" style="font-size: 17px;">k8s</a> <a href="/tags/openstack/" style="font-size: 25px;">openstack</a> <a href="/tags/network/" style="font-size: 21px;">network</a> <a href="/tags/travel/" style="font-size: 15px;">travel</a> <a href="/tags/neutron/" style="font-size: 23px;">neutron</a> <a href="/tags/octavia/" style="font-size: 15px;">octavia</a> <a href="/tags/openflow/" style="font-size: 17px;">openflow</a> <a href="/tags/sfc/" style="font-size: 15px;">sfc</a> <a href="/tags/ovs/" style="font-size: 19px;">ovs</a> <a href="/tags/tripleo/" style="font-size: 15px;">tripleo</a> <a href="/tags/linux-bridge/" style="font-size: 15px;">linux bridge</a> <a href="/tags/devstack/" style="font-size: 15px;">devstack</a> <a href="/tags/firewall对接/" style="font-size: 19px;">firewall对接</a> <a href="/tags/security/" style="font-size: 17px;">security</a> <a href="/tags/note/" style="font-size: 15px;">note</a> <a href="/tags/poetry/" style="font-size: 15px;">poetry</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/kvm/" style="font-size: 15px;">kvm</a> <a href="/tags/SR-IOV/" style="font-size: 15px;">SR-IOV</a> <a href="/tags/边缘计算/" style="font-size: 15px;">边缘计算</a> <a href="/tags/5G/" style="font-size: 15px;">5G</a> <a href="/tags/VPNaaS/" style="font-size: 15px;">VPNaaS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/02/11/CentaraGrand/">CentaraGrand</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/19/虚拟网络优化与测试/">虚拟网络优化与测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/03/Distributed-Virtual-Routing/">Distributed Virtual Routing</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/边缘计算：5G的命喉/">边缘计算：5G的命喉</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/OpenFlow：Neutron走上歧路的原罪/">OpenFlow：Neutron走上歧路的原罪</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/14/深入浅出容器网络/">深入浅出容器网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/04/成都本科落户流程指北/">成都本科落户流程指北</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/11/未选择的路/">未选择的路</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/Calico-Research/">Calico Research</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/16/neutron-pbr-spec/">Neutron Policy-based Routing Spec</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Sirius21c's Docs.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zindex="-2" count="50" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>